<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ffead.server.doc: src/CHServer.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>src/CHServer.cpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">        Copyright 2010, Sumeet Chhetri</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<a name="l00005"></a>00005 <span class="comment">    you may not use this file except in compliance with the License.</span>
<a name="l00006"></a>00006 <span class="comment">    You may obtain a copy of the License at</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">        http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">    Unless required by applicable law or agreed to in writing, software</span>
<a name="l00011"></a>00011 <span class="comment">    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<a name="l00012"></a>00012 <span class="comment">    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00013"></a>00013 <span class="comment">    See the License for the specific language governing permissions and</span>
<a name="l00014"></a>00014 <span class="comment">    limitations under the License.</span>
<a name="l00015"></a>00015 <span class="comment">*/</span>
<a name="l00016"></a>00016 <span class="comment">/*</span>
<a name="l00017"></a>00017 <span class="comment"> * CHServer.cpp</span>
<a name="l00018"></a>00018 <span class="comment"> *</span>
<a name="l00019"></a>00019 <span class="comment"> *  Created on: Aug 25, 2009</span>
<a name="l00020"></a>00020 <span class="comment"> *      Author: sumeet</span>
<a name="l00021"></a>00021 <span class="comment"> */</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;CHServer.h&quot;</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 CHServer::CHServer()
<a name="l00027"></a>00027 {}
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 CHServer::~CHServer() {
<a name="l00030"></a>00030         <span class="comment">// TODO Auto-generated destructor stub</span>
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032 <a class="code" href="classSharedData.html">SharedData</a>* SharedData::shared_instance = NULL;
<a name="l00033"></a>00033 <span class="keywordtype">string</span> servd;
<a name="l00034"></a>00034 <span class="keyword">static</span> propMap props,lprops,urlpattMap,urlMap,tmplMap,vwMap,appMap,cntMap,pubMap,mapMap,mappattMap,autMap,autpattMap,wsdlmap,fviewmap;
<a name="l00035"></a>00035 <span class="keyword">static</span> resFuncMap rstCntMap;
<a name="l00036"></a>00036 <span class="keyword">static</span> map&lt;string, Element&gt; formMap;
<a name="l00037"></a>00037 <span class="keyword">static</span> map&lt;string, vector&lt;string&gt; &gt; filterMap;
<a name="l00038"></a>00038 <span class="keyword">static</span> <span class="keywordtype">string</span> resourcePath;
<a name="l00039"></a>00039 <span class="keyword">static</span> strVec dcpsss;
<a name="l00040"></a>00040 <span class="keyword">static</span> <span class="keywordtype">bool</span> isSSLEnabled,isThreadprq,processforcekilled,processgendone,sessatserv,isCompileEnabled;
<a name="l00041"></a>00041 <span class="keyword">static</span> <span class="keywordtype">int</span> thrdpsiz,shmid;
<a name="l00042"></a>00042 <span class="keyword">static</span> SSL_CTX *ctx;
<a name="l00043"></a>00043 <span class="keyword">static</span> <span class="keywordtype">int</span> s_server_session_id_context = 1;
<a name="l00044"></a>00044 <span class="keyword">static</span> <span class="keywordtype">int</span> s_server_auth_session_id_context = 2;
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keywordtype">int</span> client_auth=0;
<a name="l00046"></a>00046 <span class="keyword">static</span> <span class="keywordtype">char</span> *ciphers=0;
<a name="l00047"></a>00047 <span class="keyword">static</span> BIO *bio_err=0;
<a name="l00048"></a>00048 <span class="keyword">static</span> <span class="keywordtype">char</span> *pass;
<a name="l00049"></a>00049 map&lt;int,pid_t&gt; pds;
<a name="l00050"></a>00050 <span class="keyword">static</span> pid_t parid;
<a name="l00051"></a>00051 <span class="keywordtype">void</span> *dlib = NULL;
<a name="l00052"></a>00052 <span class="keyword">static</span> <span class="keywordtype">string</span> key_file,dh_file,ca_list,rand_file,sec_password,srv_auth_prvd,srv_auth_mode,srv_auth_file;
<a name="l00053"></a>00053 <span class="keyword">typedef</span> map&lt;string,string&gt; sessionMap;
<a name="l00054"></a>00054 <span class="keyword">static</span> boost::mutex m_mutex,p_mutex;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="keywordtype">void</span> writeToSharedMemeory(<span class="keywordtype">string</span> sessionId, <span class="keywordtype">string</span> value,<span class="keywordtype">bool</span> napp)
<a name="l00057"></a>00057 {
<a name="l00058"></a>00058         <span class="keywordtype">string</span> filen = servd+<span class="stringliteral">&quot;/tmp/&quot;</span>+sessionId+<span class="stringliteral">&quot;.sess&quot;</span>;
<a name="l00059"></a>00059         ofstream ofs;
<a name="l00060"></a>00060         <span class="keywordflow">if</span>(napp)
<a name="l00061"></a>00061                 ofs.open(filen.c_str());
<a name="l00062"></a>00062         <span class="keywordflow">else</span>
<a name="l00063"></a>00063                 ofs.open(filen.c_str(),ios_base::app);
<a name="l00064"></a>00064         ofs.write(value.c_str(),value.length());
<a name="l00065"></a>00065         ofs.close();
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 map&lt;string,string&gt; readFromSharedMemeory(<span class="keywordtype">string</span> sessionId)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070         map&lt;string,string&gt; valss;
<a name="l00071"></a>00071         <span class="keywordtype">string</span> filen = servd+<span class="stringliteral">&quot;/tmp/&quot;</span>+sessionId+<span class="stringliteral">&quot;.sess&quot;</span>;
<a name="l00072"></a>00072         ifstream ifs(filen.c_str());
<a name="l00073"></a>00073         <span class="keywordtype">string</span> tem,all;
<a name="l00074"></a>00074         <span class="keywordflow">while</span>(getline(ifs,tem))
<a name="l00075"></a>00075                 all.append(tem+<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00076"></a>00076         strVec results;
<a name="l00077"></a>00077         boost::iter_split(results, all, boost::first_finder(<span class="stringliteral">&quot;; &quot;</span>));
<a name="l00078"></a>00078         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> j=0;j&lt;(int)results.size()-1;j++)
<a name="l00079"></a>00079         {
<a name="l00080"></a>00080                 <span class="keywordflow">if</span>(results.at(j)==<span class="stringliteral">&quot;&quot;</span>)<span class="keywordflow">continue</span>;
<a name="l00081"></a>00081                 strVec results1;
<a name="l00082"></a>00082                 boost::replace_all(results.at(j),<span class="stringliteral">&quot;%3B%20&quot;</span>,<span class="stringliteral">&quot;; &quot;</span>);
<a name="l00083"></a>00083                 boost::iter_split(results1, results.at(j), boost::first_finder(<span class="stringliteral">&quot;=&quot;</span>));
<a name="l00084"></a>00084                 <span class="keywordflow">if</span>(results1.size()==2)
<a name="l00085"></a>00085                 {
<a name="l00086"></a>00086                         boost::replace_all(results1.at(0),<span class="stringliteral">&quot;%3D&quot;</span>,<span class="stringliteral">&quot;=&quot;</span>);
<a name="l00087"></a>00087                         boost::replace_all(results1.at(1),<span class="stringliteral">&quot;%3D&quot;</span>,<span class="stringliteral">&quot;=&quot;</span>);
<a name="l00088"></a>00088                         valss[results1.at(0)] = results1.at(1);
<a name="l00089"></a>00089                 }
<a name="l00090"></a>00090                 <span class="keywordflow">else</span>
<a name="l00091"></a>00091                 {
<a name="l00092"></a>00092                         boost::replace_all(results1.at(0),<span class="stringliteral">&quot;%3D&quot;</span>,<span class="stringliteral">&quot;=&quot;</span>);
<a name="l00093"></a>00093                         valss[results1.at(0)] = <span class="stringliteral">&quot;true&quot;</span>;
<a name="l00094"></a>00094                 }
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096         <span class="keywordflow">return</span> valss;
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">/*The password code is not thread safe*/</span>
<a name="l00100"></a>00100 <span class="keyword">static</span> <span class="keywordtype">int</span> password_cb(<span class="keywordtype">char</span> *buf,<span class="keywordtype">int</span> num,
<a name="l00101"></a>00101   <span class="keywordtype">int</span> rwflag,<span class="keywordtype">void</span> *userdata)
<a name="l00102"></a>00102   {
<a name="l00103"></a>00103     <span class="keywordflow">if</span>(num&lt;strlen(pass)+1)
<a name="l00104"></a>00104       <span class="keywordflow">return</span>(0);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     strcpy(buf,pass);
<a name="l00107"></a>00107     <span class="keywordflow">return</span>(strlen(pass));
<a name="l00108"></a>00108   }
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 <span class="keywordtype">void</span> load_dh_params(SSL_CTX *ctx,<span class="keywordtype">char</span> *file)
<a name="l00111"></a>00111 {
<a name="l00112"></a>00112     DH *ret=0;
<a name="l00113"></a>00113     BIO *bio;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="keywordflow">if</span> ((bio=BIO_new_file(file,<span class="stringliteral">&quot;r&quot;</span>)) == NULL)
<a name="l00116"></a>00116         cout &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t open DH file&quot;</span> &lt;&lt; flush;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     ret=PEM_read_bio_DHparams(bio,NULL,NULL,
<a name="l00119"></a>00119       NULL);
<a name="l00120"></a>00120     BIO_free(bio);
<a name="l00121"></a>00121     <span class="keywordflow">if</span>(SSL_CTX_set_tmp_dh(ctx,ret)&lt;0)
<a name="l00122"></a>00122         cout &lt;&lt; <span class="stringliteral">&quot;Couldn&#39;t set DH parameters&quot;</span> &lt;&lt; flush;
<a name="l00123"></a>00123   }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">static</span> <span class="keywordtype">void</span> sigpipe_handle(<span class="keywordtype">int</span> x){
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 SSL_CTX *initialize_ctx(<span class="keywordtype">char</span> *keyfile,<span class="keywordtype">char</span> *password)
<a name="l00128"></a>00128   {
<a name="l00129"></a>00129     SSL_METHOD *meth;
<a name="l00130"></a>00130     SSL_CTX *ctx;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordflow">if</span>(!bio_err){
<a name="l00133"></a>00133       <span class="comment">/* Global system initialization*/</span>
<a name="l00134"></a>00134       SSL_library_init();
<a name="l00135"></a>00135       SSL_load_error_strings();
<a name="l00136"></a>00136 
<a name="l00137"></a>00137       <span class="comment">/* An error write context */</span>
<a name="l00138"></a>00138       bio_err=BIO_new_fp(stderr,BIO_NOCLOSE);
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">/* Set up a SIGPIPE handler */</span>
<a name="l00142"></a>00142     signal(SIGPIPE,sigpipe_handle);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">/* Create our context*/</span>
<a name="l00145"></a>00145     meth=(SSL_METHOD*)SSLv23_method();
<a name="l00146"></a>00146     ctx=SSL_CTX_new(meth);
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="comment">/* Load our keys and certificates*/</span>
<a name="l00149"></a>00149     <span class="keywordflow">if</span>(!(SSL_CTX_use_certificate_chain_file(ctx,
<a name="l00150"></a>00150       keyfile)))
<a name="l00151"></a>00151         cout &lt;&lt; <span class="stringliteral">&quot;Can&#39;t read certificate file&quot;</span> &lt;&lt; flush;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     pass=password;
<a name="l00154"></a>00154     SSL_CTX_set_default_passwd_cb(ctx,
<a name="l00155"></a>00155       password_cb);
<a name="l00156"></a>00156     <span class="keywordflow">if</span>(!(SSL_CTX_use_PrivateKey_file(ctx,
<a name="l00157"></a>00157       keyfile,SSL_FILETYPE_PEM)))
<a name="l00158"></a>00158         cout &lt;&lt; <span class="stringliteral">&quot;Can&#39;t read key file&quot;</span> &lt;&lt; flush;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160     <span class="comment">/* Load the CAs we trust*/</span>
<a name="l00161"></a>00161     <span class="keywordflow">if</span>(!(SSL_CTX_load_verify_locations(ctx,
<a name="l00162"></a>00162       ca_list.c_str(),0)))
<a name="l00163"></a>00163         cout &lt;&lt; <span class="stringliteral">&quot;Can&#39;t read CA list&quot;</span> &lt;&lt; flush;
<a name="l00164"></a>00164 <span class="preprocessor">#if (OPENSSL_VERSION_NUMBER &lt; 0x00905100L)</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>    SSL_CTX_set_verify_depth(ctx,1);
<a name="l00166"></a>00166 <span class="preprocessor">#endif</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>
<a name="l00168"></a>00168     <span class="keywordflow">return</span> ctx;
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="keywordtype">void</span> destroy_ctx(SSL_CTX *ctx)
<a name="l00172"></a>00172   {
<a name="l00173"></a>00173     SSL_CTX_free(ctx);
<a name="l00174"></a>00174   }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="keywordtype">void</span> error_occurred(<span class="keywordtype">char</span> *error,<span class="keywordtype">int</span> fd,SSL *ssl)
<a name="l00177"></a>00177 {
<a name="l00178"></a>00178         cout &lt;&lt; error &lt;&lt; flush;
<a name="l00179"></a>00179         close(fd);
<a name="l00180"></a>00180         <span class="keywordtype">int</span> r=SSL_shutdown(ssl);
<a name="l00181"></a>00181         <span class="keywordflow">if</span>(!r){
<a name="l00182"></a>00182           <span class="comment">/* If we called SSL_shutdown() first then</span>
<a name="l00183"></a>00183 <span class="comment">                 we always get return value of &#39;0&#39;. In</span>
<a name="l00184"></a>00184 <span class="comment">                 this case, try again, but first send a</span>
<a name="l00185"></a>00185 <span class="comment">                 TCP FIN to trigger the other side&#39;s</span>
<a name="l00186"></a>00186 <span class="comment">                 close_notify*/</span>
<a name="l00187"></a>00187           shutdown(fd,1);
<a name="l00188"></a>00188           r=SSL_shutdown(ssl);
<a name="l00189"></a>00189         }
<a name="l00190"></a>00190         <span class="keywordflow">switch</span>(r){
<a name="l00191"></a>00191           <span class="keywordflow">case</span> 1:
<a name="l00192"></a>00192                 <span class="keywordflow">break</span>; <span class="comment">/* Success */</span>
<a name="l00193"></a>00193           <span class="keywordflow">case</span> 0:
<a name="l00194"></a>00194           <span class="keywordflow">case</span> -1:
<a name="l00195"></a>00195           <span class="keywordflow">default</span>:
<a name="l00196"></a>00196                   cout &lt;&lt; <span class="stringliteral">&quot;shutdown failed&quot;</span> &lt;&lt; flush;
<a name="l00197"></a>00197         }
<a name="l00198"></a>00198         SSL_free(ssl);
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201 <span class="keywordtype">void</span> closeSSL(<span class="keywordtype">int</span> fd,SSL *ssl,BIO* bio)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203         BIO_free(bio);
<a name="l00204"></a>00204         <span class="keywordtype">int</span> r=SSL_shutdown(ssl);
<a name="l00205"></a>00205         <span class="keywordflow">if</span>(!r){
<a name="l00206"></a>00206           <span class="comment">/* If we called SSL_shutdown() first then</span>
<a name="l00207"></a>00207 <span class="comment">                 we always get return value of &#39;0&#39;. In</span>
<a name="l00208"></a>00208 <span class="comment">                 this case, try again, but first send a</span>
<a name="l00209"></a>00209 <span class="comment">                 TCP FIN to trigger the other side&#39;s</span>
<a name="l00210"></a>00210 <span class="comment">                 close_notify*/</span>
<a name="l00211"></a>00211           shutdown(fd,1);
<a name="l00212"></a>00212           r=SSL_shutdown(ssl);
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214         <span class="keywordflow">switch</span>(r){
<a name="l00215"></a>00215           <span class="keywordflow">case</span> 1:
<a name="l00216"></a>00216                 <span class="keywordflow">break</span>; <span class="comment">/* Success */</span>
<a name="l00217"></a>00217           <span class="keywordflow">case</span> 0:
<a name="l00218"></a>00218           <span class="keywordflow">case</span> -1:
<a name="l00219"></a>00219           <span class="keywordflow">default</span>:
<a name="l00220"></a>00220                   cout &lt;&lt; <span class="stringliteral">&quot;shutdown failed&quot;</span> &lt;&lt; flush;
<a name="l00221"></a>00221         }
<a name="l00222"></a>00222         SSL_free(ssl);
<a name="l00223"></a>00223 }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="keywordtype">char</span> *unbase64(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">int</span> length)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227   BIO *b64, *bmem;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229   <span class="keywordtype">char</span> *buffer = (<span class="keywordtype">char</span> *)malloc(length);
<a name="l00230"></a>00230   memset(buffer, 0, length);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232   b64 = BIO_new(BIO_f_base64());
<a name="l00233"></a>00233   bmem = BIO_new_mem_buf(input, length);
<a name="l00234"></a>00234   bmem = BIO_push(b64, bmem);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236   BIO_read(bmem, buffer, length);
<a name="l00237"></a>00237 
<a name="l00238"></a>00238   BIO_free_all(bmem);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240   <span class="keywordflow">return</span> buffer;
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="keywordtype">char</span> *base64(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input, <span class="keywordtype">int</span> length)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245   BIO *bmem, *b64;
<a name="l00246"></a>00246   BUF_MEM *bptr;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248   b64 = BIO_new(BIO_f_base64());
<a name="l00249"></a>00249   bmem = BIO_new(BIO_s_mem());
<a name="l00250"></a>00250   b64 = BIO_push(b64, bmem);
<a name="l00251"></a>00251   BIO_write(b64, input, length);
<a name="l00252"></a>00252   BIO_flush(b64);
<a name="l00253"></a>00253   BIO_get_mem_ptr(b64, &amp;bptr);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255   <span class="keywordtype">char</span> *buff = (<span class="keywordtype">char</span> *)malloc(bptr-&gt;length);
<a name="l00256"></a>00256   memcpy(buff, bptr-&gt;data, bptr-&gt;length-1);
<a name="l00257"></a>00257   buff[bptr-&gt;length-1] = 0;
<a name="l00258"></a>00258 
<a name="l00259"></a>00259   BIO_free_all(b64);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261   <span class="keywordflow">return</span> buff;
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="keywordtype">string</span> createResponse(<span class="keywordtype">string</span> htm,<span class="keywordtype">string</span> url)
<a name="l00265"></a>00265 {
<a name="l00266"></a>00266         <span class="keywordtype">string</span> data;
<a name="l00267"></a>00267         stringstream ss;
<a name="l00268"></a>00268         ss &lt;&lt; htm.length();
<a name="l00269"></a>00269 
<a name="l00270"></a>00270         <span class="keywordtype">string</span> temp;
<a name="l00271"></a>00271         ss &gt;&gt; temp;
<a name="l00272"></a>00272         <span class="keywordtype">size_t</span> tes;
<a name="l00273"></a>00273         <span class="keywordflow">if</span>((tes=url.find(<span class="stringliteral">&quot;.html&quot;</span>))!=string::npos)
<a name="l00274"></a>00274         {
<a name="l00275"></a>00275                 data = <span class="stringliteral">&quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: text/html\nContent-Length: &quot;</span>+temp+<span class="stringliteral">&quot;\n\n&quot;</span>+htm+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00276"></a>00276                 <span class="comment">//cout &lt;&lt; &quot;HTML DATA&quot; &lt;&lt;flush;</span>
<a name="l00277"></a>00277         }
<a name="l00278"></a>00278         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(htm.size()!=0)
<a name="l00279"></a>00279         {
<a name="l00280"></a>00280                 data = <span class="stringliteral">&quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: image/jpeg\nContent-Length: &quot;</span>+temp+<span class="stringliteral">&quot;\n\n&quot;</span>+htm+<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00281"></a>00281                 <span class="comment">//cout &lt;&lt; &quot;other DATA&quot; &lt;&lt;flush;</span>
<a name="l00282"></a>00282         }
<a name="l00283"></a>00283         <span class="keywordflow">return</span> data;
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="keywordtype">string</span> getFileExtension(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; file)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288         <span class="keywordtype">string</span> str = file;
<a name="l00289"></a>00289         <span class="keywordtype">string</span> ext = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00290"></a>00290         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;str.length(); i++)
<a name="l00291"></a>00291         {
<a name="l00292"></a>00292                 <span class="keywordflow">if</span>(str[i] == <span class="charliteral">&#39;.&#39;</span>)
<a name="l00293"></a>00293                 {
<a name="l00294"></a>00294                         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = i; j&lt;str.length(); j++)
<a name="l00295"></a>00295                         {
<a name="l00296"></a>00296                                 ext += str[j];
<a name="l00297"></a>00297                         }
<a name="l00298"></a>00298                         <span class="keywordflow">return</span> ext;
<a name="l00299"></a>00299                 }
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301         <span class="keywordflow">return</span> ext;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 
<a name="l00305"></a>00305 <span class="keywordtype">string</span> createResponseVec(<span class="keywordtype">string</span> len,<span class="keywordtype">string</span> url)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307         <span class="keywordtype">string</span> data;
<a name="l00308"></a>00308         <span class="comment">//size_t tes;</span>
<a name="l00309"></a>00309         <span class="keywordtype">string</span> ext = getFileExtension(url);
<a name="l00310"></a>00310         <a class="code" href="classPropFileReader.html">PropFileReader</a> pf;
<a name="l00311"></a>00311         propMap props = pf.getProperties(<span class="stringliteral">&quot;resources/mime-types.prop&quot;</span>);
<a name="l00312"></a>00312         <span class="keywordtype">string</span> contype = props[ext];
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="comment">//cout &lt;&lt; props.size() &lt;&lt; flush;</span>
<a name="l00315"></a>00315         <span class="comment">/*if((tes=url.find(&quot;.html&quot;))!=string::npos)</span>
<a name="l00316"></a>00316 <span class="comment">        {</span>
<a name="l00317"></a>00317 <span class="comment">                data = &quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: text/html\n\nContent-Length: &quot;+len+&quot;\n\n&quot;;</span>
<a name="l00318"></a>00318 <span class="comment">                cout &lt;&lt; &quot;HTML DATA&quot; &lt;&lt;flush;</span>
<a name="l00319"></a>00319 <span class="comment">        }</span>
<a name="l00320"></a>00320 <span class="comment">        else if((tes=url.find(&quot;.jpg&quot;))!=string::npos)</span>
<a name="l00321"></a>00321 <span class="comment">        {</span>
<a name="l00322"></a>00322 <span class="comment">                data = &quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: image/jpeg\nContent-Length: &quot;+len+&quot;\n\n&quot;;</span>
<a name="l00323"></a>00323 <span class="comment">                cout &lt;&lt; &quot;other DATA&quot; &lt;&lt;flush;</span>
<a name="l00324"></a>00324 <span class="comment">        }</span>
<a name="l00325"></a>00325 <span class="comment">        else if((tes=url.find(&quot;.txt&quot;))!=string::npos)</span>
<a name="l00326"></a>00326 <span class="comment">        {</span>
<a name="l00327"></a>00327 <span class="comment">                data = &quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: text/plain\nContent-Length: &quot;+len+&quot;\n\n&quot;;</span>
<a name="l00328"></a>00328 <span class="comment">                cout &lt;&lt; &quot;other DATA&quot; &lt;&lt;flush;</span>
<a name="l00329"></a>00329 <span class="comment">        }</span>
<a name="l00330"></a>00330 <span class="comment">        else if((tes=url.find(&quot;.xml&quot;))!=string::npos)</span>
<a name="l00331"></a>00331 <span class="comment">        {</span>
<a name="l00332"></a>00332 <span class="comment">                data = &quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nContent-Type: text/xml\nContent-Length: &quot;+len+&quot;\n\n&quot;;</span>
<a name="l00333"></a>00333 <span class="comment">                cout &lt;&lt; &quot;other DATA&quot; &lt;&lt;flush;</span>
<a name="l00334"></a>00334 <span class="comment">        }</span>
<a name="l00335"></a>00335 <span class="comment">        else if((tes=url.find(&quot;.jar&quot;))!=string::npos)</span>
<a name="l00336"></a>00336 <span class="comment">        {*/</span>
<a name="l00337"></a>00337                 data = <span class="stringliteral">&quot;HTTP/1.1 200 OK\nDate: Fri, 31 Dec 1999 23:59:59 GMT\nConnection: close\nContent-Type: &quot;</span>+contype+<span class="stringliteral">&quot;\nContent-Length: &quot;</span>+len+<span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l00338"></a>00338                 <span class="comment">//cout &lt;&lt; &quot;other DATA&quot; &lt;&lt;flush;</span>
<a name="l00339"></a>00339         <span class="comment">//}</span>
<a name="l00340"></a>00340         <span class="keywordflow">return</span> data;
<a name="l00341"></a>00341 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 <span class="keywordtype">string</span> getContent(<span class="keywordtype">string</span> url)
<a name="l00344"></a>00344 {
<a name="l00345"></a>00345         <span class="keywordtype">string</span> all;
<a name="l00346"></a>00346         <span class="keywordtype">string</span> line;
<a name="l00347"></a>00347         <span class="keywordtype">string</span> fname = <span class="stringliteral">&quot;/home/sumeet/&quot;</span>+url;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="keywordflow">if</span> (url==<span class="stringliteral">&quot;/&quot;</span>)
<a name="l00350"></a>00350         {
<a name="l00351"></a>00351                 <span class="comment">//cout &lt;&lt; &quot;\nURL is&quot; &lt;&lt; fname &lt;&lt; flush;</span>
<a name="l00352"></a>00352                 <span class="keywordflow">return</span> all;
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354         <span class="comment">//Magick::Image image(&quot;/home/sumeet/test123.jpg&quot;);</span>
<a name="l00355"></a>00355     ifstream myfile (&amp;fname[0],ios::in | ios::binary);
<a name="l00356"></a>00356     stringstream ss;
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (myfile.is_open())
<a name="l00358"></a>00358     {
<a name="l00359"></a>00359           <span class="keywordflow">while</span> (!myfile.eof())
<a name="l00360"></a>00360           {
<a name="l00361"></a>00361                   getline(myfile,line);
<a name="l00362"></a>00362                   <span class="comment">//char c = getchar(myfile);</span>
<a name="l00363"></a>00363                   <span class="comment">//ss &lt;&lt; c;</span>
<a name="l00364"></a>00364                   all += line;
<a name="l00365"></a>00365           }
<a name="l00366"></a>00366           myfile.close();
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368     <span class="keywordflow">else</span>
<a name="l00369"></a>00369     {
<a name="l00370"></a>00370         <span class="comment">//cout &lt;&lt; &quot;Unable to open file&quot;;</span>
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <span class="comment">//ss &gt;&gt; all;</span>
<a name="l00373"></a>00373     <span class="keywordflow">return</span> all;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 vector&lt;unsigned char&gt; getContentVec(<span class="keywordtype">string</span> url,<span class="keywordtype">string</span> locale,<span class="keywordtype">string</span> ext)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378         vector&lt;unsigned char&gt; all;
<a name="l00379"></a>00379         <span class="keywordtype">string</span> fname = <span class="stringliteral">&quot;&quot;</span>+url;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (url==<span class="stringliteral">&quot;/&quot;</span>)
<a name="l00382"></a>00382         {
<a name="l00383"></a>00383                 <span class="comment">//cout &lt;&lt; &quot;\nURL is&quot; &lt;&lt; fname &lt;&lt; flush;</span>
<a name="l00384"></a>00384                 <span class="keywordflow">return</span> all;
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386         ifstream myfile;
<a name="l00387"></a>00387         <span class="comment">//Magick::Image image(&quot;/home/sumeet/test123.jpg&quot;);</span>
<a name="l00388"></a>00388         <span class="keywordflow">if</span>(locale.find(<span class="stringliteral">&quot;english&quot;</span>)==string::npos &amp;&amp; (ext==<span class="stringliteral">&quot;.html&quot;</span> || ext==<span class="stringliteral">&quot;.htm&quot;</span>))
<a name="l00389"></a>00389         {
<a name="l00390"></a>00390                 <span class="keywordtype">string</span> fnj = fname;
<a name="l00391"></a>00391                 boost::replace_first(fnj,<span class="stringliteral">&quot;.&quot;</span>,(<span class="stringliteral">&quot;_&quot;</span> + locale+<span class="stringliteral">&quot;.&quot;</span>));
<a name="l00392"></a>00392                 myfile.open(&amp;fnj[0],ios::in | ios::binary);
<a name="l00393"></a>00393                 <span class="comment">//cout &lt;&lt; fnj &lt;&lt; flush;</span>
<a name="l00394"></a>00394         }
<a name="l00395"></a>00395         <span class="keywordflow">if</span>(!myfile.is_open())
<a name="l00396"></a>00396                 myfile.open(&amp;fname[0],ios::in | ios::binary);
<a name="l00397"></a>00397     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (myfile.is_open())
<a name="l00399"></a>00399     {
<a name="l00400"></a>00400       <span class="keywordflow">while</span> (myfile.read((<span class="keywordtype">char</span>*)&amp;byte, <span class="keyword">sizeof</span>(byte)))
<a name="l00401"></a>00401           {
<a name="l00402"></a>00402                   all.push_back(byte);
<a name="l00403"></a>00403           }
<a name="l00404"></a>00404           myfile.close();
<a name="l00405"></a>00405     }
<a name="l00406"></a>00406     <span class="keywordflow">else</span>
<a name="l00407"></a>00407     {
<a name="l00408"></a>00408         <span class="comment">//cout &lt;&lt; &quot;Unable to open file&quot;;</span>
<a name="l00409"></a>00409     }
<a name="l00410"></a>00410     <span class="comment">//ss &gt;&gt; all;</span>
<a name="l00411"></a>00411     <span class="keywordflow">return</span> all;
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="keywordtype">string</span> getContentStr(<span class="keywordtype">string</span> url,<span class="keywordtype">string</span> locale,<span class="keywordtype">string</span> ext)
<a name="l00415"></a>00415 {
<a name="l00416"></a>00416         <span class="keywordtype">string</span> all;
<a name="l00417"></a>00417         <span class="keywordtype">string</span> fname = <span class="stringliteral">&quot;&quot;</span>+url;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419         <span class="keywordflow">if</span> (url==<span class="stringliteral">&quot;/&quot;</span>)
<a name="l00420"></a>00420         {
<a name="l00421"></a>00421                 <span class="comment">//cout &lt;&lt; &quot;\nURL is&quot; &lt;&lt; fname &lt;&lt; flush;</span>
<a name="l00422"></a>00422                 <span class="keywordflow">return</span> all;
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424         ifstream myfile;
<a name="l00425"></a>00425         <span class="comment">//Magick::Image image(&quot;/home/sumeet/test123.jpg&quot;);</span>
<a name="l00426"></a>00426         <span class="keywordflow">if</span>(locale.find(<span class="stringliteral">&quot;english&quot;</span>)==string::npos &amp;&amp; (ext==<span class="stringliteral">&quot;.html&quot;</span> || ext==<span class="stringliteral">&quot;.htm&quot;</span>))
<a name="l00427"></a>00427         {
<a name="l00428"></a>00428                 <span class="keywordtype">string</span> fnj = fname;
<a name="l00429"></a>00429                 boost::replace_first(fnj,<span class="stringliteral">&quot;.&quot;</span>,(<span class="stringliteral">&quot;_&quot;</span> + locale+<span class="stringliteral">&quot;.&quot;</span>));
<a name="l00430"></a>00430                 myfile.open(&amp;fnj[0],ios::in | ios::binary);
<a name="l00431"></a>00431                 <span class="comment">//cout &lt;&lt; fnj &lt;&lt; flush;</span>
<a name="l00432"></a>00432         }
<a name="l00433"></a>00433         <span class="keywordflow">if</span>(!myfile.is_open())
<a name="l00434"></a>00434                 myfile.open(&amp;fname[0],ios::in | ios::binary);
<a name="l00435"></a>00435     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> byte = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00436"></a>00436     <span class="keywordflow">if</span> (myfile.is_open())
<a name="l00437"></a>00437     {
<a name="l00438"></a>00438       <span class="keywordflow">while</span> (myfile.read((<span class="keywordtype">char</span>*)&amp;byte, <span class="keyword">sizeof</span>(byte)))
<a name="l00439"></a>00439           {
<a name="l00440"></a>00440                   all.push_back(byte);
<a name="l00441"></a>00441           }
<a name="l00442"></a>00442           myfile.close();
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444     <span class="keywordflow">else</span>
<a name="l00445"></a>00445     {
<a name="l00446"></a>00446         <span class="comment">//cout &lt;&lt; &quot;Unable to open file&quot;;</span>
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     <span class="comment">//ss &gt;&gt; all;</span>
<a name="l00449"></a>00449     <span class="keywordflow">return</span> all;
<a name="l00450"></a>00450 }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452 <span class="keywordtype">void</span> createResponse(<a class="code" href="classHttpResponse.html">HttpResponse</a> &amp;res,<span class="keywordtype">bool</span> flag,map&lt;string,string&gt; vals,<span class="keywordtype">string</span> prevcookid)
<a name="l00453"></a>00453 {
<a name="l00454"></a>00454         <span class="keywordflow">if</span>(flag)
<a name="l00455"></a>00455         {
<a name="l00456"></a>00456                 <span class="keywordtype">string</span> values;
<a name="l00457"></a>00457                 cout &lt;&lt; <span class="stringliteral">&quot;session object modified &quot;</span> &lt;&lt; vals.size() &lt;&lt; endl;
<a name="l00458"></a>00458                 <a class="code" href="classDate.html">Date</a> date;
<a name="l00459"></a>00459                 <span class="keywordtype">string</span> <span class="keywordtype">id</span> = boost::lexical_cast&lt;<span class="keywordtype">string</span>&gt;(Timer::getCurrentTime());
<a name="l00460"></a>00460                 date.setHh(date.getHh()+6);
<a name="l00461"></a>00461                 <a class="code" href="classDateFormat.html">DateFormat</a> dformat(<span class="stringliteral">&quot;ddd, dd-mmm-yyyy hh:mi:ss&quot;</span>);
<a name="l00462"></a>00462                 map&lt;string,string&gt;::iterator it;
<a name="l00463"></a>00463                 <span class="keywordflow">for</span>(it=vals.begin();it!=vals.end();it++)
<a name="l00464"></a>00464                 {
<a name="l00465"></a>00465                         <span class="keywordtype">string</span> key = it-&gt;first;
<a name="l00466"></a>00466                         <span class="keywordtype">string</span> value = it-&gt;second;
<a name="l00467"></a>00467                         boost::replace_all(key,<span class="stringliteral">&quot;; &quot;</span>,<span class="stringliteral">&quot;%3B%20&quot;</span>);
<a name="l00468"></a>00468                         boost::replace_all(key,<span class="stringliteral">&quot;=&quot;</span>,<span class="stringliteral">&quot;%3D&quot;</span>);
<a name="l00469"></a>00469                         boost::replace_all(value,<span class="stringliteral">&quot;; &quot;</span>,<span class="stringliteral">&quot;%3B%20&quot;</span>);
<a name="l00470"></a>00470                         boost::replace_all(value,<span class="stringliteral">&quot;=&quot;</span>,<span class="stringliteral">&quot;%3D&quot;</span>);
<a name="l00471"></a>00471                         cout &lt;&lt; it-&gt;first &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; endl;
<a name="l00472"></a>00472                         <span class="keywordflow">if</span>(!sessatserv)
<a name="l00473"></a>00473                                 res.addCookie(key + <span class="stringliteral">&quot;=&quot;</span> + value + <span class="stringliteral">&quot;; expires=&quot;</span>+dformat.format(date)+<span class="stringliteral">&quot; GMT; path=/; HttpOnly&quot;</span>);
<a name="l00474"></a>00474                         <span class="keywordflow">else</span>
<a name="l00475"></a>00475                         {
<a name="l00476"></a>00476                                 values += key + <span class="stringliteral">&quot;=&quot;</span> + value + <span class="stringliteral">&quot;; &quot;</span>;
<a name="l00477"></a>00477                         }
<a name="l00478"></a>00478                 }
<a name="l00479"></a>00479                 <span class="keywordflow">if</span>(sessatserv)
<a name="l00480"></a>00480                 {
<a name="l00481"></a>00481                         <span class="keywordflow">if</span>(values!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00482"></a>00482                         {
<a name="l00483"></a>00483                                 <span class="keywordflow">if</span>(prevcookid!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00484"></a>00484                                         writeToSharedMemeory(prevcookid,values,<span class="keyword">true</span>);
<a name="l00485"></a>00485                                 <span class="keywordflow">else</span>
<a name="l00486"></a>00486                                 {
<a name="l00487"></a>00487                                         writeToSharedMemeory(<span class="keywordtype">id</span>,values,<span class="keyword">false</span>);
<a name="l00488"></a>00488                                         res.addCookie(<span class="stringliteral">&quot;FFEADID=&quot;</span> + <span class="keywordtype">id</span> + <span class="stringliteral">&quot;; expires=&quot;</span>+dformat.format(date)+<span class="stringliteral">&quot; GMT; path=/; HttpOnly&quot;</span>);
<a name="l00489"></a>00489                                 }
<a name="l00490"></a>00490                         }
<a name="l00491"></a>00491                 }
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="keywordtype">void</span> listi(<span class="keywordtype">string</span> cwd,<span class="keywordtype">string</span> type,<span class="keywordtype">bool</span> apDir,strVec &amp;folders)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497         FILE *pipe_fp;
<a name="l00498"></a>00498         <span class="keywordtype">string</span> command;
<a name="l00499"></a>00499         command = (<span class="stringliteral">&quot;ls -F1 &quot;</span>+cwd+<span class="stringliteral">&quot;|grep &#39;&quot;</span>+type+<span class="stringliteral">&quot;&#39;&quot;</span>);
<a name="l00500"></a>00500         cout &lt;&lt; <span class="stringliteral">&quot;\nCommand:&quot;</span> &lt;&lt; command &lt;&lt; flush;
<a name="l00501"></a>00501         <span class="keywordflow">if</span> ((pipe_fp = popen(command.c_str(), <span class="stringliteral">&quot;r&quot;</span>)) == NULL)
<a name="l00502"></a>00502         {
<a name="l00503"></a>00503                 printf(<span class="stringliteral">&quot;pipe open error in cmd_list\n&quot;</span>);
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505         <span class="keywordtype">int</span> t_char;
<a name="l00506"></a>00506         <span class="keywordtype">string</span> folderName;
<a name="l00507"></a>00507         <span class="keywordflow">while</span> ((t_char = fgetc(pipe_fp)) != EOF)
<a name="l00508"></a>00508         {
<a name="l00509"></a>00509                 <span class="keywordflow">if</span>(t_char!=<span class="charliteral">&#39;\n&#39;</span>)
<a name="l00510"></a>00510                 {
<a name="l00511"></a>00511                         stringstream ss;
<a name="l00512"></a>00512                         ss &lt;&lt; (char)t_char;
<a name="l00513"></a>00513                         <span class="keywordtype">string</span> temp;
<a name="l00514"></a>00514                         ss &gt;&gt; temp;
<a name="l00515"></a>00515                         folderName.append(temp);
<a name="l00516"></a>00516                 }
<a name="l00517"></a>00517                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(folderName!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00518"></a>00518                 {
<a name="l00519"></a>00519                         boost::replace_first(folderName,<span class="stringliteral">&quot;*&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00520"></a>00520                         <span class="keywordflow">if</span>(folderName.find(<span class="stringliteral">&quot;~&quot;</span>)==string::npos)
<a name="l00521"></a>00521                         {
<a name="l00522"></a>00522                                 cout &lt;&lt; <span class="stringliteral">&quot;\nlist for file&quot;</span> &lt;&lt; (cwd+<span class="stringliteral">&quot;/&quot;</span>+folderName) &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; flush;
<a name="l00523"></a>00523                                 <span class="keywordflow">if</span>(apDir)
<a name="l00524"></a>00524                                         folders.push_back(cwd+folderName);
<a name="l00525"></a>00525                                 <span class="keywordflow">else</span>
<a name="l00526"></a>00526                                         folders.push_back(folderName);
<a name="l00527"></a>00527                         }
<a name="l00528"></a>00528                         folderName = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00529"></a>00529                 }
<a name="l00530"></a>00530         }
<a name="l00531"></a>00531         pclose(pipe_fp);
<a name="l00532"></a>00532 }
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="keywordtype">void</span> ServiceTask::run()
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536         <span class="comment">//cout &lt;&lt; dlib &lt;&lt; endl;</span>
<a name="l00537"></a>00537         <span class="keywordtype">string</span> ip = <span class="stringliteral">&quot;invalid session&quot;</span>;
<a name="l00538"></a>00538         <span class="keywordtype">string</span> alldatlg = <span class="stringliteral">&quot;\ngot fd from parent&quot;</span>;
<a name="l00539"></a>00539         SSL *ssl=NULL;
<a name="l00540"></a>00540         BIO *sbio=NULL;
<a name="l00541"></a>00541         BIO *io=NULL,*ssl_bio=NULL;
<a name="l00542"></a>00542         <span class="keywordflow">try</span>
<a name="l00543"></a>00543         {
<a name="l00544"></a>00544                 <span class="keywordtype">int</span> cntlen = 0;
<a name="l00545"></a>00545                 <span class="keywordtype">char</span> buf[MAXBUFLENM];
<a name="l00546"></a>00546                 strVec results;
<a name="l00547"></a>00547                 stringstream ss;
<a name="l00548"></a>00548                 <span class="keywordtype">string</span> temp;
<a name="l00549"></a>00549                 <span class="keywordtype">int</span> bytes = -1;
<a name="l00550"></a>00550                 <span class="keywordflow">if</span>(isSSLEnabled)
<a name="l00551"></a>00551                 {
<a name="l00552"></a>00552                         sbio=BIO_new_socket(fd,BIO_CLOSE);
<a name="l00553"></a>00553                         <span class="comment">//cout &lt;&lt; &quot;\nBefore = &quot; &lt;&lt; ssl &lt;&lt; flush;</span>
<a name="l00554"></a>00554                         ssl=SSL_new(ctx);
<a name="l00555"></a>00555                         <span class="comment">//cout &lt;&lt; &quot;\nAfter = &quot; &lt;&lt; ssl &lt;&lt; flush;</span>
<a name="l00556"></a>00556                         SSL_set_bio(ssl,sbio,sbio);
<a name="l00557"></a>00557                         <span class="keywordtype">int</span> r;
<a name="l00558"></a>00558                         <span class="keywordflow">if</span>((r=SSL_accept(ssl)&lt;=0))
<a name="l00559"></a>00559                         {
<a name="l00560"></a>00560                                 error_occurred(<span class="stringliteral">&quot;SSL accept error&quot;</span>,fd,ssl);
<a name="l00561"></a>00561                                 <span class="keywordflow">return</span>;
<a name="l00562"></a>00562                         }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564                         io=BIO_new(BIO_f_buffer());
<a name="l00565"></a>00565                         ssl_bio=BIO_new(BIO_f_ssl());
<a name="l00566"></a>00566                         BIO_set_ssl(ssl_bio,ssl,BIO_CLOSE);
<a name="l00567"></a>00567                         BIO_push(io,ssl_bio);
<a name="l00568"></a>00568                         <span class="keywordtype">int</span> er=-1;
<a name="l00569"></a>00569                         <span class="keywordtype">bool</span> flag = <span class="keyword">true</span>;
<a name="l00570"></a>00570                         <span class="keywordflow">while</span>(flag)
<a name="l00571"></a>00571                         {
<a name="l00572"></a>00572                                 er = BIO_gets(io,buf,BUFSIZZ-1);
<a name="l00573"></a>00573                                 <span class="keywordflow">switch</span>(SSL_get_error(ssl,er))
<a name="l00574"></a>00574                                 {
<a name="l00575"></a>00575                                         <span class="keywordflow">case</span> SSL_ERROR_NONE:
<a name="l00576"></a>00576                                                 <span class="keywordflow">break</span>;
<a name="l00577"></a>00577                                         <span class="keywordflow">case</span> SSL_ERROR_ZERO_RETURN:
<a name="l00578"></a>00578                                         {
<a name="l00579"></a>00579                                                 error_occurred(<span class="stringliteral">&quot;SSL error problem&quot;</span>,fd,ssl);
<a name="l00580"></a>00580                                                 <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l00581"></a>00581                                                 <span class="keywordflow">return</span>;
<a name="l00582"></a>00582                                         }
<a name="l00583"></a>00583                                         <span class="keywordflow">default</span>:
<a name="l00584"></a>00584                                         {
<a name="l00585"></a>00585                                                 error_occurred(<span class="stringliteral">&quot;SSL read problem&quot;</span>,fd,ssl);
<a name="l00586"></a>00586                                                 <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l00587"></a>00587                                                 <span class="keywordflow">return</span>;
<a name="l00588"></a>00588                                         }
<a name="l00589"></a>00589                                 }
<a name="l00590"></a>00590                                 ss &lt;&lt; buf;
<a name="l00591"></a>00591                                 <span class="comment">//cout &lt;&lt;buf &lt;&lt;endl;</span>
<a name="l00592"></a>00592                                 <span class="keywordflow">if</span>(!strcmp(buf,<span class="stringliteral">&quot;\r\n&quot;</span>) || !strcmp(buf,<span class="stringliteral">&quot;\n&quot;</span>))
<a name="l00593"></a>00593                                         <span class="keywordflow">break</span>;
<a name="l00594"></a>00594                                 <span class="keywordtype">string</span> temp(buf);
<a name="l00595"></a>00595                                 temp = temp.substr(0,temp.length()-1);
<a name="l00596"></a>00596                                 results.push_back(temp);
<a name="l00597"></a>00597                                 <span class="comment">//cout &lt;&lt; temp &lt;&lt;endl;</span>
<a name="l00598"></a>00598                                 <span class="keywordflow">if</span>(temp.find(<span class="stringliteral">&quot;Content-Length:&quot;</span>)!=string::npos)
<a name="l00599"></a>00599                                 {
<a name="l00600"></a>00600                                         std::string cntle = temp.substr(temp.find(<span class="stringliteral">&quot;: &quot;</span>)+2);
<a name="l00601"></a>00601                                         cntle = cntle.substr(0,cntle.length()-1);
<a name="l00602"></a>00602                                         <span class="comment">//cout &lt;&lt; &quot;contne-length=&quot;&lt;&lt;cntle &lt;&lt;endl;</span>
<a name="l00603"></a>00603                                         <span class="keywordflow">try</span>
<a name="l00604"></a>00604                                         {
<a name="l00605"></a>00605                                                 cntlen = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(cntle);
<a name="l00606"></a>00606                                         }
<a name="l00607"></a>00607                                         <span class="keywordflow">catch</span>(boost::bad_lexical_cast&amp;)
<a name="l00608"></a>00608                                         {
<a name="l00609"></a>00609                                                 cout &lt;&lt; <span class="stringliteral">&quot;bad lexical cast&quot;</span> &lt;&lt;endl;
<a name="l00610"></a>00610                                         }
<a name="l00611"></a>00611                                 }
<a name="l00612"></a>00612                                 memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l00613"></a>00613                         }
<a name="l00614"></a>00614                 }
<a name="l00615"></a>00615                 <span class="keywordflow">else</span>
<a name="l00616"></a>00616                 {
<a name="l00617"></a>00617                         <span class="keywordtype">int</span> er=-1;
<a name="l00618"></a>00618                         <span class="keywordtype">bool</span> flag = <span class="keyword">true</span>;
<a name="l00619"></a>00619                         sbio=BIO_new_socket(fd,BIO_CLOSE);
<a name="l00620"></a>00620                         io=BIO_new(BIO_f_buffer());
<a name="l00621"></a>00621                         BIO_push(io,sbio);
<a name="l00622"></a>00622                         <span class="keywordflow">while</span>(flag)
<a name="l00623"></a>00623                         {
<a name="l00624"></a>00624                                 er = BIO_gets(io,buf,BUFSIZZ-1);
<a name="l00625"></a>00625                                 <span class="keywordflow">if</span>(er==0)
<a name="l00626"></a>00626                                 {
<a name="l00627"></a>00627                                         close(fd);
<a name="l00628"></a>00628                                         cout &lt;&lt; <span class="stringliteral">&quot;\nsocket closed before being serviced&quot;</span> &lt;&lt;flush;
<a name="l00629"></a>00629                                         <span class="keywordflow">return</span>;
<a name="l00630"></a>00630                                 }
<a name="l00631"></a>00631                                 ss &lt;&lt; buf;
<a name="l00632"></a>00632                                 <span class="keywordflow">if</span>(!strcmp(buf,<span class="stringliteral">&quot;\r\n&quot;</span>) || !strcmp(buf,<span class="stringliteral">&quot;\n&quot;</span>) || er&lt;0)
<a name="l00633"></a>00633                                         <span class="keywordflow">break</span>;
<a name="l00634"></a>00634                                 <span class="keywordtype">string</span> temp(buf);
<a name="l00635"></a>00635                                 temp = temp.substr(0,temp.length()-1);
<a name="l00636"></a>00636                                 results.push_back(temp);
<a name="l00637"></a>00637                                 <span class="comment">//cout &lt;&lt; temp &lt;&lt;endl;</span>
<a name="l00638"></a>00638                                 <span class="keywordflow">if</span>(temp.find(<span class="stringliteral">&quot;Content-Length:&quot;</span>)!=string::npos)
<a name="l00639"></a>00639                                 {
<a name="l00640"></a>00640                                         std::string cntle = temp.substr(temp.find(<span class="stringliteral">&quot;: &quot;</span>)+2);
<a name="l00641"></a>00641                                         cntle = cntle.substr(0,cntle.length()-1);
<a name="l00642"></a>00642                                         <span class="comment">//cout &lt;&lt; &quot;contne-length=&quot;&lt;&lt;cntle &lt;&lt;endl;</span>
<a name="l00643"></a>00643                                         <span class="keywordflow">try</span>
<a name="l00644"></a>00644                                         {
<a name="l00645"></a>00645                                                 cntlen = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(cntle);
<a name="l00646"></a>00646                                         }
<a name="l00647"></a>00647                                         <span class="keywordflow">catch</span>(boost::bad_lexical_cast&amp;)
<a name="l00648"></a>00648                                         {
<a name="l00649"></a>00649                                                 cout &lt;&lt; <span class="stringliteral">&quot;bad lexical cast&quot;</span> &lt;&lt;endl;
<a name="l00650"></a>00650                                         }
<a name="l00651"></a>00651                                 }
<a name="l00652"></a>00652                                 memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l00653"></a>00653                         }
<a name="l00654"></a>00654                 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656                 ss.clear();
<a name="l00657"></a>00657                 <span class="keywordflow">if</span>(isSSLEnabled &amp;&amp; cntlen&gt;0)
<a name="l00658"></a>00658                 {
<a name="l00659"></a>00659                         <span class="keywordtype">int</span> er=-1;
<a name="l00660"></a>00660                         <span class="keywordflow">if</span>(cntlen&gt;0)
<a name="l00661"></a>00661                         {
<a name="l00662"></a>00662                                 <span class="comment">//cout &lt;&lt; &quot;reading conetnt &quot; &lt;&lt; cntlen &lt;&lt; endl;</span>
<a name="l00663"></a>00663                                 er = BIO_read(io,buf,cntlen);
<a name="l00664"></a>00664                                 <span class="keywordflow">switch</span>(SSL_get_error(ssl,er))
<a name="l00665"></a>00665                                 {
<a name="l00666"></a>00666                                         <span class="keywordflow">case</span> SSL_ERROR_NONE:
<a name="l00667"></a>00667                                                 cntlen -= er;
<a name="l00668"></a>00668                                                 <span class="keywordflow">break</span>;
<a name="l00669"></a>00669                                         <span class="keywordflow">case</span> SSL_ERROR_ZERO_RETURN:
<a name="l00670"></a>00670                                         {
<a name="l00671"></a>00671                                                 error_occurred(<span class="stringliteral">&quot;SSL error problem&quot;</span>,fd,ssl);
<a name="l00672"></a>00672                                                 <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l00673"></a>00673                                                 <span class="keywordflow">return</span>;
<a name="l00674"></a>00674                                         }
<a name="l00675"></a>00675                                         <span class="keywordflow">default</span>:
<a name="l00676"></a>00676                                         {
<a name="l00677"></a>00677                                                 error_occurred(<span class="stringliteral">&quot;SSL read problem&quot;</span>,fd,ssl);
<a name="l00678"></a>00678                                                 <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l00679"></a>00679                                                 <span class="keywordflow">return</span>;
<a name="l00680"></a>00680                                         }
<a name="l00681"></a>00681                                 }
<a name="l00682"></a>00682                                 <span class="keywordtype">string</span> temp(buf);
<a name="l00683"></a>00683                                 results.push_back(<span class="stringliteral">&quot;\r&quot;</span>);
<a name="l00684"></a>00684                                 results.push_back(temp);
<a name="l00685"></a>00685                                 <span class="comment">//cout &lt;&lt;buf &lt;&lt;endl;</span>
<a name="l00686"></a>00686                                 memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l00687"></a>00687                         }
<a name="l00688"></a>00688                 }
<a name="l00689"></a>00689                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cntlen&gt;0)
<a name="l00690"></a>00690                 {
<a name="l00691"></a>00691                         <span class="keywordtype">int</span> er=-1;
<a name="l00692"></a>00692                         <span class="keywordflow">if</span>(cntlen&gt;0)
<a name="l00693"></a>00693                         {
<a name="l00694"></a>00694                                 <span class="comment">//cout &lt;&lt; &quot;reading conetnt &quot; &lt;&lt; cntlen &lt;&lt; endl;</span>
<a name="l00695"></a>00695                                 er = BIO_read(io,buf,cntlen);
<a name="l00696"></a>00696                                 <span class="keywordflow">if</span>(er==0)
<a name="l00697"></a>00697                                 {
<a name="l00698"></a>00698                                         close(fd);
<a name="l00699"></a>00699                                         cout &lt;&lt; <span class="stringliteral">&quot;\nsocket closed before being serviced&quot;</span> &lt;&lt;flush;
<a name="l00700"></a>00700                                         <span class="keywordflow">return</span>;
<a name="l00701"></a>00701                                 }
<a name="l00702"></a>00702                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(er&gt;0)
<a name="l00703"></a>00703                                 {
<a name="l00704"></a>00704                                         <span class="keywordtype">string</span> temp(buf);
<a name="l00705"></a>00705                                         results.push_back(<span class="stringliteral">&quot;\r&quot;</span>);
<a name="l00706"></a>00706                                         results.push_back(temp);
<a name="l00707"></a>00707                                         <span class="comment">//cout &lt;&lt; temp &lt;&lt;endl;</span>
<a name="l00708"></a>00708                                         memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l00709"></a>00709                                 }
<a name="l00710"></a>00710                         }
<a name="l00711"></a>00711                 }
<a name="l00712"></a>00712                 alldatlg += <span class="stringliteral">&quot;--read data&quot;</span>;
<a name="l00713"></a>00713                 map&lt;string,string&gt; params1 = *params;
<a name="l00714"></a>00714                 <span class="keywordtype">string</span> webpath = serverRootDirectory + <span class="stringliteral">&quot;web/&quot;</span>;
<a name="l00715"></a>00715                 <a class="code" href="classHttpRequest.html">HttpRequest</a>* req= <span class="keyword">new</span> <a class="code" href="classHttpRequest.html">HttpRequest</a>(results,webpath);
<a name="l00716"></a>00716                 <span class="keywordflow">if</span>(req-&gt;getFile()==<span class="stringliteral">&quot;&quot;</span>)
<a name="l00717"></a>00717                 {
<a name="l00718"></a>00718                         req-&gt;setFile(<span class="stringliteral">&quot;index.html&quot;</span>);
<a name="l00719"></a>00719                 }
<a name="l00720"></a>00720                 <span class="keywordflow">if</span>(req-&gt;hasCookie())
<a name="l00721"></a>00721                 {
<a name="l00722"></a>00722                         <span class="keywordflow">if</span>(!sessatserv)
<a name="l00723"></a>00723                                 req-&gt;getSession()-&gt;setSessionAttributes(req-&gt;getCookieInfo());
<a name="l00724"></a>00724                         <span class="keywordflow">else</span>
<a name="l00725"></a>00725                         {
<a name="l00726"></a>00726                                 <span class="keywordtype">string</span> <span class="keywordtype">id</span> = req-&gt;getCookieInfo()[<span class="stringliteral">&quot;FFEADID&quot;</span>];
<a name="l00727"></a>00727                                 map&lt;string,string&gt; values = readFromSharedMemeory(<span class="keywordtype">id</span>);
<a name="l00728"></a>00728                                 req-&gt;getSession()-&gt;setSessionAttributes(values);
<a name="l00729"></a>00729                         }
<a name="l00730"></a>00730                 }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732                 <span class="keywordflow">if</span>(cntMap[req-&gt;getCntxt_name()]!=<span class="stringliteral">&quot;true&quot;</span>)
<a name="l00733"></a>00733                 {
<a name="l00734"></a>00734                         req-&gt;setCntxt_name(<span class="stringliteral">&quot;default&quot;</span>);
<a name="l00735"></a>00735                         req-&gt;setCntxt_root(webpath+<span class="stringliteral">&quot;default&quot;</span>);
<a name="l00736"></a>00736                         req-&gt;setUrl(webpath+<span class="stringliteral">&quot;default&quot;</span>+req-&gt;getActUrl());
<a name="l00737"></a>00737                 }
<a name="l00738"></a>00738                 <span class="comment">//cout &lt;&lt; req-&gt;getCntxt_name() &lt;&lt; req-&gt;getCntxt_root() &lt;&lt; req-&gt;getUrl() &lt;&lt; endl;</span>
<a name="l00739"></a>00739 
<a name="l00740"></a>00740                 <span class="keywordflow">if</span>(appMap[req-&gt;getCntxt_name()]!=<span class="stringliteral">&quot;false&quot;</span>)
<a name="l00741"></a>00741                 {
<a name="l00742"></a>00742                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l00743"></a>00743                         {
<a name="l00744"></a>00744                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l00745"></a>00745                                 exit(-1);
<a name="l00746"></a>00746                         }
<a name="l00747"></a>00747                         <span class="keywordtype">string</span> meth1 = (req-&gt;getCntxt_name()+<span class="stringliteral">&quot;checkRules&quot;</span>);
<a name="l00748"></a>00748                         <span class="keywordtype">string</span> path1;
<a name="l00749"></a>00749                         <span class="keywordtype">void</span> *mkr1 = dlsym(dlib, meth1.c_str());
<a name="l00750"></a>00750                         <span class="keywordflow">if</span>(mkr1!=NULL)
<a name="l00751"></a>00751                         {
<a name="l00752"></a>00752                                 <span class="keyword">typedef</span> string (*DCPPtr1) (string,<a class="code" href="classHttpSession.html">HttpSession</a>);
<a name="l00753"></a>00753                                 DCPPtr1 f =  (DCPPtr1)mkr1;
<a name="l00754"></a>00754                                 path1 = f(req-&gt;getUrl(),*(req-&gt;getSession()));
<a name="l00755"></a>00755                                 <span class="comment">//cout &lt;&lt; path1 &lt;&lt; flush;</span>
<a name="l00756"></a>00756                                 <span class="keywordflow">if</span>(path1==<span class="stringliteral">&quot;FAILED&quot;</span>)
<a name="l00757"></a>00757                                 {
<a name="l00758"></a>00758                                         req-&gt;setUrl(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00759"></a>00759                                 }
<a name="l00760"></a>00760                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(path1!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; path1!=req-&gt;getUrl())
<a name="l00761"></a>00761                                 {
<a name="l00762"></a>00762                                         req-&gt;setUrl(path1);
<a name="l00763"></a>00763                                 }
<a name="l00764"></a>00764                         }
<a name="l00765"></a>00765                 }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767                 <a class="code" href="classHttpResponse.html">HttpResponse</a> res;
<a name="l00768"></a>00768                 <span class="keywordtype">string</span> ext = getFileExtension(req-&gt;getUrl());
<a name="l00769"></a>00769                 vector&lt;unsigned char&gt; test;
<a name="l00770"></a>00770                 <span class="keywordtype">string</span> content;
<a name="l00771"></a>00771                 <span class="comment">//if(ext!=&quot;.dcp&quot; &amp;&amp; ext!=&quot;.view&quot; &amp;&amp; ext!=&quot;.tpe&quot; &amp;&amp; ext!=&quot;.wsdl&quot;)</span>
<a name="l00772"></a>00772                 <span class="comment">//      test = getContentVec(req-&gt;getUrl(),lprops[req-&gt;getDefaultLocale()],ext);</span>
<a name="l00773"></a>00773 
<a name="l00774"></a>00774                 <span class="keywordtype">string</span> claz;
<a name="l00775"></a>00775                 <span class="comment">//cout &lt;&lt; urlpattMap[&quot;*.*&quot;] &lt;&lt; flush;</span>
<a name="l00776"></a>00776                 <span class="keywordtype">bool</span> isAuthenticated = <span class="keyword">false</span>;
<a name="l00777"></a>00777                 <span class="keywordtype">bool</span> isoAuthRes = <span class="keyword">false</span>;
<a name="l00778"></a>00778                 <span class="keywordtype">bool</span> isContrl = <span class="keyword">false</span>;
<a name="l00779"></a>00779 
<a name="l00780"></a>00780                 <span class="keywordflow">if</span>(filterMap.find(req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*in&quot;</span>)!=filterMap.end() || filterMap.find(req-&gt;getCntxt_name()+ext+<span class="stringliteral">&quot;in&quot;</span>)!=filterMap.end())
<a name="l00781"></a>00781                 {
<a name="l00782"></a>00782                         vector&lt;string&gt; tempp;
<a name="l00783"></a>00783                         <span class="keywordflow">if</span>(filterMap.find(req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*in&quot;</span>)!=filterMap.end())
<a name="l00784"></a>00784                                 tempp = filterMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*in&quot;</span>];
<a name="l00785"></a>00785                         <span class="keywordflow">else</span>
<a name="l00786"></a>00786                                 tempp = filterMap[req-&gt;getCntxt_name()+ext+<span class="stringliteral">&quot;in&quot;</span>];
<a name="l00787"></a>00787 
<a name="l00788"></a>00788                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> var = 0; var &lt; tempp.size(); ++var)
<a name="l00789"></a>00789                         {
<a name="l00790"></a>00790                                 <span class="keywordtype">string</span> clasz = tempp.at(var);
<a name="l00791"></a>00791                                 clasz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + clasz;
<a name="l00792"></a>00792                                 cout &lt;&lt; <span class="stringliteral">&quot;filter handled by class &quot;</span> &lt;&lt; clasz &lt;&lt; endl;
<a name="l00793"></a>00793                                 <span class="keywordflow">if</span>(dlib == NULL)
<a name="l00794"></a>00794                                 {
<a name="l00795"></a>00795                                         cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l00796"></a>00796                                         exit(-1);
<a name="l00797"></a>00797                                 }
<a name="l00798"></a>00798                                 <span class="keywordtype">void</span> *mkr = dlsym(dlib, clasz.c_str());
<a name="l00799"></a>00799                                 <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l00800"></a>00800                                 {
<a name="l00801"></a>00801                                         FunPtr f =  (FunPtr)mkr;
<a name="l00802"></a>00802                                         <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l00803"></a>00803                                         args argus;
<a name="l00804"></a>00804                                         <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l00805"></a>00805                                         <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l00806"></a>00806                                         <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l00807"></a>00807                                         <a class="code" href="classFilter.html">Filter</a> *filter = (<a class="code" href="classFilter.html">Filter</a>*)_temp;
<a name="l00808"></a>00808                                         filter-&gt;doInputFilter(req);
<a name="l00809"></a>00809                                         cout &lt;&lt; <span class="stringliteral">&quot;filter called&quot;</span> &lt;&lt; endl;
<a name="l00810"></a>00810                                         <span class="keyword">delete</span> _temp;
<a name="l00811"></a>00811                                 }
<a name="l00812"></a>00812                         }
<a name="l00813"></a>00813                 }
<a name="l00814"></a>00814                 <span class="keywordflow">if</span>(autpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span> || autMap[req-&gt;getCntxt_name()+ext]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00815"></a>00815                 {
<a name="l00816"></a>00816                         <span class="keywordflow">if</span>(autpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00817"></a>00817                         {
<a name="l00818"></a>00818                                 claz = autpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>];
<a name="l00819"></a>00819                         }
<a name="l00820"></a>00820                         <span class="keywordflow">else</span>
<a name="l00821"></a>00821                         {
<a name="l00822"></a>00822                                 claz = autMap[req-&gt;getCntxt_name()+ext];
<a name="l00823"></a>00823                         }
<a name="l00824"></a>00824                         <a class="code" href="classAuthController.html">AuthController</a> *authc;
<a name="l00825"></a>00825                         cout &lt;&lt; <span class="stringliteral">&quot;OAUTH/HTTP Authorization requested &quot;</span> &lt;&lt;  claz &lt;&lt; endl;
<a name="l00826"></a>00826                         map&lt;string,string&gt;::iterator it;
<a name="l00827"></a>00827                         map&lt;string,string&gt; tempmap = req-&gt;getAuthinfo();
<a name="l00828"></a>00828                         <span class="keywordflow">for</span>(it=tempmap.begin();it!=tempmap.end();it++)
<a name="l00829"></a>00829                         {
<a name="l00830"></a>00830                                 cout &lt;&lt; it-&gt;first &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; endl;
<a name="l00831"></a>00831                         }
<a name="l00832"></a>00832                         map&lt;string,string&gt; tempmap1 = req-&gt;getRequestParams();
<a name="l00833"></a>00833                         <span class="keywordflow">for</span>(it=tempmap1.begin();it!=tempmap1.end();it++)
<a name="l00834"></a>00834                         {
<a name="l00835"></a>00835                                 cout &lt;&lt; it-&gt;first &lt;&lt; <span class="stringliteral">&quot; = &quot;</span> &lt;&lt; it-&gt;second &lt;&lt; endl;
<a name="l00836"></a>00836                         }
<a name="l00837"></a>00837                         <span class="keywordflow">if</span>(claz.find(<span class="stringliteral">&quot;file:&quot;</span>)==0)
<a name="l00838"></a>00838                         {
<a name="l00839"></a>00839                                 claz = req-&gt;getCntxt_root()+<span class="stringliteral">&quot;/&quot;</span>+claz.substr(claz.find(<span class="stringliteral">&quot;:&quot;</span>)+1);
<a name="l00840"></a>00840                                 cout &lt;&lt; <span class="stringliteral">&quot;auth handled by file &quot;</span> &lt;&lt; claz &lt;&lt; endl;
<a name="l00841"></a>00841                                 authc = <span class="keyword">new</span> <a class="code" href="classFileAuthController.html">FileAuthController</a>(claz,<span class="stringliteral">&quot;:&quot;</span>);
<a name="l00842"></a>00842                                 <span class="keywordflow">if</span>(authc-&gt;isInitialized())
<a name="l00843"></a>00843                                 {
<a name="l00844"></a>00844                                         <span class="keywordflow">if</span>(authc-&gt;authenticate(req-&gt;getAuthinfo()[<span class="stringliteral">&quot;Username&quot;</span>],req-&gt;getAuthinfo()[<span class="stringliteral">&quot;Password&quot;</span>]))
<a name="l00845"></a>00845                                         {
<a name="l00846"></a>00846                                                 cout &lt;&lt; <span class="stringliteral">&quot;valid user&quot;</span> &lt;&lt; endl;
<a name="l00847"></a>00847                                         }
<a name="l00848"></a>00848                                         <span class="keywordflow">else</span>
<a name="l00849"></a>00849                                         {
<a name="l00850"></a>00850                                                 cout &lt;&lt; <span class="stringliteral">&quot;invalid user&quot;</span> &lt;&lt; endl;
<a name="l00851"></a>00851                                                 res.setStatusCode(<span class="stringliteral">&quot;401&quot;</span>);
<a name="l00852"></a>00852                                                 res.setStatusMsg(<span class="stringliteral">&quot;Unauthorized\r\nWWW-Authenticate: Invalid authentication details&quot;</span>);
<a name="l00853"></a>00853                                                 isContrl = <span class="keyword">true</span>;
<a name="l00854"></a>00854                                                 cout &lt;&lt; <span class="stringliteral">&quot;verified request token signature is invalid&quot;</span> &lt;&lt; endl;
<a name="l00855"></a>00855                                         }
<a name="l00856"></a>00856                                 }
<a name="l00857"></a>00857                                 <span class="keywordflow">else</span>
<a name="l00858"></a>00858                                 {
<a name="l00859"></a>00859                                         cout &lt;&lt; <span class="stringliteral">&quot;invalid user repo defined&quot;</span> &lt;&lt; endl;
<a name="l00860"></a>00860                                 }
<a name="l00861"></a>00861                         }
<a name="l00862"></a>00862                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(claz.find(<span class="stringliteral">&quot;class:&quot;</span>)==0)
<a name="l00863"></a>00863                         {
<a name="l00864"></a>00864                                 claz = claz.substr(claz.find(<span class="stringliteral">&quot;:&quot;</span>)+1);
<a name="l00865"></a>00865                                 claz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + claz;
<a name="l00866"></a>00866                                 cout &lt;&lt; <span class="stringliteral">&quot;auth handled by class &quot;</span> &lt;&lt; claz &lt;&lt; endl;
<a name="l00867"></a>00867                                 <span class="keywordflow">if</span>(dlib == NULL)
<a name="l00868"></a>00868                                 {
<a name="l00869"></a>00869                                         cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l00870"></a>00870                                         exit(-1);
<a name="l00871"></a>00871                                 }
<a name="l00872"></a>00872                                 <span class="keywordtype">void</span> *mkr = dlsym(dlib, claz.c_str());
<a name="l00873"></a>00873                                 <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l00874"></a>00874                                 {
<a name="l00875"></a>00875                                         FunPtr f =  (FunPtr)mkr;
<a name="l00876"></a>00876                                         <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l00877"></a>00877                                         args argus;
<a name="l00878"></a>00878                                         <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l00879"></a>00879                                         <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l00880"></a>00880                                         <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l00881"></a>00881                                         authc = (<a class="code" href="classAuthController.html">AuthController</a>*)_temp;
<a name="l00882"></a>00882                                         isoAuthRes = authc-&gt;handle(req,&amp;res);
<a name="l00883"></a>00883                                         <span class="keywordflow">if</span>(res.getStatusCode()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00884"></a>00884                                                 isContrl = <span class="keyword">true</span>;
<a name="l00885"></a>00885                                         cout &lt;&lt; <span class="stringliteral">&quot;authhandler called&quot;</span> &lt;&lt; endl;
<a name="l00886"></a>00886                                         ext = getFileExtension(req-&gt;getUrl());
<a name="l00887"></a>00887                                         <span class="keyword">delete</span> authc;
<a name="l00888"></a>00888                                 }
<a name="l00889"></a>00889                         }
<a name="l00890"></a>00890                 }
<a name="l00891"></a>00891                 <span class="keywordtype">string</span> pthwofile = req-&gt;getCntxt_name()+req-&gt;getActUrl();
<a name="l00892"></a>00892                 <span class="comment">//pthwofile = pthwofile.substr(0, pthwofile.find_last_of(&quot;/&quot;)+1);</span>
<a name="l00893"></a>00893                 <span class="keywordflow">if</span>(!isContrl &amp;&amp; (urlpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span> || urlMap[req-&gt;getCntxt_name()+ext]!=<span class="stringliteral">&quot;&quot;</span>))
<a name="l00894"></a>00894                 {
<a name="l00895"></a>00895                         <span class="comment">//cout &lt;&lt; &quot;Controller requested for &quot; &lt;&lt; req-&gt;getCntxt_name() &lt;&lt; &quot; name &quot; &lt;&lt; urlMap[req-&gt;getCntxt_name()+ext] &lt;&lt; endl;</span>
<a name="l00896"></a>00896                         <span class="keywordflow">if</span>(urlpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00897"></a>00897                                 claz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + urlpattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>];
<a name="l00898"></a>00898                         <span class="keywordflow">else</span>
<a name="l00899"></a>00899                                 claz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + urlMap[req-&gt;getCntxt_name()+ext];
<a name="l00900"></a>00900                         <span class="keywordtype">string</span> libName = <span class="stringliteral">&quot;libinter.so&quot;</span>;
<a name="l00901"></a>00901                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l00902"></a>00902                         {
<a name="l00903"></a>00903                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l00904"></a>00904                                 exit(-1);
<a name="l00905"></a>00905                         }
<a name="l00906"></a>00906                         <span class="keywordtype">void</span> *mkr = dlsym(dlib, claz.c_str());
<a name="l00907"></a>00907                         <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l00908"></a>00908                         {
<a name="l00909"></a>00909                                 FunPtr f =  (FunPtr)mkr;
<a name="l00910"></a>00910                                 <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l00911"></a>00911                                 args argus;
<a name="l00912"></a>00912                                 <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l00913"></a>00913                                 <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l00914"></a>00914                                 <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l00915"></a>00915                                 <a class="code" href="classController.html">Controller</a> *thrd = (<a class="code" href="classController.html">Controller</a> *)_temp;
<a name="l00916"></a>00916                                 <span class="keywordflow">try</span>{
<a name="l00917"></a>00917                                          cout &lt;&lt; <span class="stringliteral">&quot;Controller called&quot;</span> &lt;&lt; endl;
<a name="l00918"></a>00918                                          res = thrd-&gt;service(*req);
<a name="l00919"></a>00919                                          cout &lt;&lt; res.getStatusCode() &lt;&lt; endl;
<a name="l00920"></a>00920                                          cout &lt;&lt; res.getContent_type() &lt;&lt; endl;
<a name="l00921"></a>00921                                          cout &lt;&lt; res.getContent_len() &lt;&lt; endl;
<a name="l00922"></a>00922                                          <span class="keywordflow">if</span>(res.getStatusCode()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00923"></a>00923                                                  isContrl = <span class="keyword">true</span>;
<a name="l00924"></a>00924                                          ext = getFileExtension(req-&gt;getUrl());
<a name="l00925"></a>00925                                          <span class="comment">//delete mkr;</span>
<a name="l00926"></a>00926                                 }<span class="keywordflow">catch</span>(...){ cout &lt;&lt; <span class="stringliteral">&quot;Controller exception&quot;</span> &lt;&lt; endl;}
<a name="l00927"></a>00927                                 cout &lt;&lt; <span class="stringliteral">&quot;Controller called\n&quot;</span> &lt;&lt; flush;
<a name="l00928"></a>00928                         }
<a name="l00929"></a>00929                 }
<a name="l00930"></a>00930                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!isContrl &amp;&amp; (mappattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span> || mapMap[req-&gt;getCntxt_name()+ext]!=<span class="stringliteral">&quot;&quot;</span>))
<a name="l00931"></a>00931                 {
<a name="l00932"></a>00932                         <span class="keywordtype">string</span> file = req-&gt;getFile();
<a name="l00933"></a>00933                         <span class="keywordtype">string</span> fili = file.substr(0,file.find_last_of(<span class="stringliteral">&quot;.&quot;</span>));
<a name="l00934"></a>00934                         <span class="keywordflow">if</span>(mappattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l00935"></a>00935                         {
<a name="l00936"></a>00936                                 req-&gt;setFile(fili+mappattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>]);
<a name="l00937"></a>00937                                 cout &lt;&lt; <span class="stringliteral">&quot;URL mapped from * to &quot;</span> &lt;&lt; mappattMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*&quot;</span>] &lt;&lt; endl;
<a name="l00938"></a>00938                         }
<a name="l00939"></a>00939                         <span class="keywordflow">else</span>
<a name="l00940"></a>00940                         {
<a name="l00941"></a>00941                                 req-&gt;setFile(fili+mapMap[req-&gt;getCntxt_name()+ext]);
<a name="l00942"></a>00942                                 cout &lt;&lt; <span class="stringliteral">&quot;URL mapped from &quot;</span> &lt;&lt; ext &lt;&lt; <span class="stringliteral">&quot; to &quot;</span> &lt;&lt; mapMap[req-&gt;getCntxt_name()+ext] &lt;&lt; endl;
<a name="l00943"></a>00943                         }
<a name="l00944"></a>00944                 }
<a name="l00945"></a>00945                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!isContrl)
<a name="l00946"></a>00946                 {
<a name="l00947"></a>00947                         resFuncMap::iterator it;
<a name="l00948"></a>00948                         <a class="code" href="classRestFunction.html">RestFunction</a> rft;
<a name="l00949"></a>00949                         <span class="keywordtype">bool</span> flag = <span class="keyword">false</span>;
<a name="l00950"></a>00950                         vector&lt;string&gt; valss;
<a name="l00951"></a>00951                         <span class="keywordtype">int</span> prsiz = 0;
<a name="l00952"></a>00952                         <span class="comment">//cout &lt;&lt; pthwofile &lt;&lt; endl;</span>
<a name="l00953"></a>00953                         <span class="keywordflow">for</span> (it=rstCntMap.begin();it!=rstCntMap.end();it++)
<a name="l00954"></a>00954                         {
<a name="l00955"></a>00955                                 <span class="comment">//cout &lt;&lt; it-&gt;first &lt;&lt; endl;</span>
<a name="l00956"></a>00956                                 <span class="keywordflow">if</span>(pthwofile.find(it-&gt;first)!=string::npos)
<a name="l00957"></a>00957                                 {
<a name="l00958"></a>00958                                         <a class="code" href="classRestFunction.html">RestFunction</a> ft = it-&gt;second;
<a name="l00959"></a>00959                                         prsiz = ft.params.size();
<a name="l00960"></a>00960                                         <span class="keywordtype">string</span> pthwofiletemp(pthwofile);
<a name="l00961"></a>00961                                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> var = 0; var &lt; prsiz; var++)
<a name="l00962"></a>00962                                         {
<a name="l00963"></a>00963                                                 <span class="comment">//cout &lt;&lt; &quot;loop - &quot; &lt;&lt; pthwofiletemp &lt;&lt; endl;</span>
<a name="l00964"></a>00964                                                 <span class="keywordtype">string</span> valsvv(pthwofiletemp.substr(pthwofiletemp.find_last_of(<span class="stringliteral">&quot;/&quot;</span>)+1));
<a name="l00965"></a>00965                                                 pthwofiletemp = pthwofiletemp.substr(0, pthwofiletemp.find_last_of(<span class="stringliteral">&quot;/&quot;</span>));
<a name="l00966"></a>00966                                                 valss.push_back(valsvv);
<a name="l00967"></a>00967                                         }
<a name="l00968"></a>00968                                         <span class="comment">//cout &lt;&lt; &quot;after - &quot; &lt;&lt; pthwofiletemp &lt;&lt; endl;</span>
<a name="l00969"></a>00969                                         <span class="comment">/*if(pthwofiletemp.at(pthwofiletemp.length()-1)==&#39;/&#39;)</span>
<a name="l00970"></a>00970 <span class="comment">                                        {</span>
<a name="l00971"></a>00971 <span class="comment">                                                pthwofiletemp = pthwofiletemp.substr(0, pthwofiletemp.length()-1);</span>
<a name="l00972"></a>00972 <span class="comment">                                        }*/</span>
<a name="l00973"></a>00973                                         <span class="comment">//cout &lt;&lt; &quot;after - &quot; &lt;&lt; pthwofiletemp &lt;&lt; endl;</span>
<a name="l00974"></a>00974                                         <span class="keywordflow">if</span>(it-&gt;first==pthwofiletemp)
<a name="l00975"></a>00975                                         {
<a name="l00976"></a>00976                                                 <span class="keywordflow">if</span>(prsiz==valss.size())
<a name="l00977"></a>00977                                                 {
<a name="l00978"></a>00978                                                         cout &lt;&lt; <span class="stringliteral">&quot;got correct url -- restcontroller &quot;</span> &lt;&lt; endl;
<a name="l00979"></a>00979                                                         rft = ft;
<a name="l00980"></a>00980                                                         flag = <span class="keyword">true</span>;
<a name="l00981"></a>00981                                                 }
<a name="l00982"></a>00982                                                 <span class="keywordflow">break</span>;
<a name="l00983"></a>00983                                         }
<a name="l00984"></a>00984                                 }
<a name="l00985"></a>00985                         }
<a name="l00986"></a>00986                         <span class="keywordflow">if</span>(flag)
<a name="l00987"></a>00987                         {
<a name="l00988"></a>00988                                 <span class="comment">//cout &lt;&lt; &quot;inside restcontroller logic ...&quot; &lt;&lt; endl;</span>
<a name="l00989"></a>00989                                 <span class="keywordtype">string</span> libName = <span class="stringliteral">&quot;libinter.so&quot;</span>;
<a name="l00990"></a>00990                                 <span class="keywordflow">if</span>(dlib == NULL)
<a name="l00991"></a>00991                                 {
<a name="l00992"></a>00992                                         cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l00993"></a>00993                                         exit(-1);
<a name="l00994"></a>00994                                 }
<a name="l00995"></a>00995                                 <span class="keywordtype">string</span> clasnam(<span class="stringliteral">&quot;getReflectionCIFor&quot;</span>+rft.clas);
<a name="l00996"></a>00996                                 <span class="keywordtype">void</span> *mkr = dlsym(dlib, clasnam.c_str());
<a name="l00997"></a>00997                                 cout &lt;&lt; mkr &lt;&lt; endl;
<a name="l00998"></a>00998                                 <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l00999"></a>00999                                 {
<a name="l01000"></a>01000                                         FunPtr f =  (FunPtr)mkr;
<a name="l01001"></a>01001                                         <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l01002"></a>01002                                         args argus;
<a name="l01003"></a>01003                                         <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l01004"></a>01004                                         <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l01005"></a>01005                                         <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l01006"></a>01006                                         <a class="code" href="classRestController.html">RestController</a>* rstcnt = (<a class="code" href="classRestController.html">RestController</a>*)_temp;
<a name="l01007"></a>01007                                         rstcnt-&gt;request = req;
<a name="l01008"></a>01008                                         rstcnt-&gt;response = &amp;res;
<a name="l01009"></a>01009 
<a name="l01010"></a>01010                                         vals valus;
<a name="l01011"></a>01011                                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> var = 0; var &lt; prsiz; var++)
<a name="l01012"></a>01012                                         {
<a name="l01013"></a>01013                                                 argus.push_back(rft.params.at(var).type);
<a name="l01014"></a>01014                                                 <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;int&quot;</span>)
<a name="l01015"></a>01015                                                 {
<a name="l01016"></a>01016                                                         <span class="keywordtype">int</span>* ival = <span class="keyword">new</span> int(boost::lexical_cast&lt;int&gt;(valss.at(var)));
<a name="l01017"></a>01017                                                         valus.push_back(ival);
<a name="l01018"></a>01018                                                 }
<a name="l01019"></a>01019                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;long&quot;</span>)
<a name="l01020"></a>01020                                                 {
<a name="l01021"></a>01021                                                         <span class="keywordtype">long</span>* ival = <span class="keyword">new</span> long(boost::lexical_cast&lt;long&gt;(valss.at(var)));
<a name="l01022"></a>01022                                                         valus.push_back(ival);
<a name="l01023"></a>01023                                                 }
<a name="l01024"></a>01024                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;double&quot;</span>)
<a name="l01025"></a>01025                                                 {
<a name="l01026"></a>01026                                                         <span class="keywordtype">double</span>* ival = <span class="keyword">new</span> double(boost::lexical_cast&lt;double&gt;(valss.at(var)));
<a name="l01027"></a>01027                                                         valus.push_back(ival);
<a name="l01028"></a>01028                                                 }
<a name="l01029"></a>01029                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;float&quot;</span>)
<a name="l01030"></a>01030                                                 {
<a name="l01031"></a>01031                                                         <span class="keywordtype">float</span>* ival = <span class="keyword">new</span> float(boost::lexical_cast&lt;float&gt;(valss.at(var)));
<a name="l01032"></a>01032                                                         valus.push_back(ival);
<a name="l01033"></a>01033                                                 }
<a name="l01034"></a>01034                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;bool&quot;</span>)
<a name="l01035"></a>01035                                                 {
<a name="l01036"></a>01036                                                         <span class="keywordtype">bool</span>* ival = <span class="keyword">new</span> bool(boost::lexical_cast&lt;bool&gt;(valss.at(var)));
<a name="l01037"></a>01037                                                         valus.push_back(ival);
<a name="l01038"></a>01038                                                 }
<a name="l01039"></a>01039                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(rft.params.at(var).type==<span class="stringliteral">&quot;string&quot;</span>)
<a name="l01040"></a>01040                                                 {
<a name="l01041"></a>01041                                                         <span class="keywordtype">string</span>* sval = <span class="keyword">new</span> string(valss.at(var));
<a name="l01042"></a>01042                                                         valus.push_back(sval);
<a name="l01043"></a>01043                                                 }
<a name="l01044"></a>01044                                         }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                                         <a class="code" href="classMethod.html">Method</a> meth = srv.getMethod(rft.name, argus);
<a name="l01047"></a>01047                                         <span class="keywordflow">if</span>(meth.getMethodName()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01048"></a>01048                                         {
<a name="l01049"></a>01049                                                 ref.invokeMethodUnknownReturn(_temp,meth,valus);
<a name="l01050"></a>01050                                                 cout &lt;&lt; <span class="stringliteral">&quot;successfully called restcontroller&quot;</span> &lt;&lt; endl;
<a name="l01051"></a>01051                                                 <span class="comment">//return;</span>
<a name="l01052"></a>01052                                         }
<a name="l01053"></a>01053                                         <span class="keywordflow">else</span>
<a name="l01054"></a>01054                                         {
<a name="l01055"></a>01055                                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01056"></a>01056                                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01057"></a>01057                                                 res.setContent_type(<span class="stringliteral">&quot;text/plain&quot;</span>);
<a name="l01058"></a>01058                                                 res.setContent_str(<span class="stringliteral">&quot;Rest Controller Method Not Found&quot;</span>);
<a name="l01059"></a>01059                                                 cout &lt;&lt; <span class="stringliteral">&quot;Rest Controller Method Not Found&quot;</span> &lt;&lt; endl;
<a name="l01060"></a>01060                                                 <span class="comment">//return;</span>
<a name="l01061"></a>01061                                         }
<a name="l01062"></a>01062                                 }
<a name="l01063"></a>01063                         }
<a name="l01064"></a>01064                 }
<a name="l01065"></a>01065 
<a name="l01066"></a>01066                 <span class="comment">/*After going through the controller the response might be blank, just set the HTTP version*/</span>
<a name="l01067"></a>01067                 res.setHttpVersion(req-&gt;getHttpVersion());
<a name="l01068"></a>01068                 <span class="comment">//cout &lt;&lt; req-&gt;toString() &lt;&lt; endl;</span>
<a name="l01069"></a>01069                 <span class="keywordflow">if</span>(isContrl)
<a name="l01070"></a>01070                 {
<a name="l01071"></a>01071 
<a name="l01072"></a>01072                 }
<a name="l01073"></a>01073                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.form&quot;</span>)
<a name="l01074"></a>01074                 {
<a name="l01075"></a>01075                         <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l01076"></a>01076                         <a class="code" href="classElement.html">Element</a> ele = formMap[req-&gt;getFile()];
<a name="l01077"></a>01077                         cout &lt;&lt; ele.getTagName() &lt;&lt; endl;
<a name="l01078"></a>01078                         cout &lt;&lt; ele.render() &lt;&lt; endl;
<a name="l01079"></a>01079                         <a class="code" href="classClassInfo.html">ClassInfo</a> binfo = ref.getClassInfo(ele.getAttribute(<span class="stringliteral">&quot;bean&quot;</span>));
<a name="l01080"></a>01080                         ElementList eles = ele.getChildElements();
<a name="l01081"></a>01081                         <span class="keywordtype">string</span> json = <span class="stringliteral">&quot;{&quot;</span>;
<a name="l01082"></a>01082                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> apps = 0; apps &lt; eles.size(); apps++)
<a name="l01083"></a>01083                         {
<a name="l01084"></a>01084                                 <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;field&quot;</span>)
<a name="l01085"></a>01085                                 {
<a name="l01086"></a>01086                                         <span class="keywordtype">string</span> name = eles.at(apps).getAttribute(<span class="stringliteral">&quot;name&quot;</span>);
<a name="l01087"></a>01087                                         <a class="code" href="classField.html">Field</a> fld = binfo.getField(eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>));
<a name="l01088"></a>01088                                         <span class="keywordflow">if</span>(fld.getType()==<span class="stringliteral">&quot;string&quot;</span>)
<a name="l01089"></a>01089                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: \&quot;&quot;</span> + req-&gt;getRequestParam(name) + <span class="stringliteral">&quot;\&quot;,&quot;</span>;
<a name="l01090"></a>01090                                         <span class="keywordflow">else</span>
<a name="l01091"></a>01091                                         {
<a name="l01092"></a>01092                                                 <span class="keywordflow">if</span>(fld.getType()==<span class="stringliteral">&quot;int&quot;</span> || fld.getType()==<span class="stringliteral">&quot;long&quot;</span>)
<a name="l01093"></a>01093                                                 {
<a name="l01094"></a>01094                                                         <span class="keywordflow">if</span>(req-&gt;getRequestParam(name)==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01095"></a>01095                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: 0,&quot;</span>;
<a name="l01096"></a>01096                                                         <span class="keywordflow">else</span>
<a name="l01097"></a>01097                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: &quot;</span> + req-&gt;getRequestParam(name) + <span class="stringliteral">&quot;,&quot;</span>;
<a name="l01098"></a>01098                                                 }
<a name="l01099"></a>01099                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fld.getType()==<span class="stringliteral">&quot;double&quot;</span> || fld.getType()==<span class="stringliteral">&quot;float&quot;</span>)
<a name="l01100"></a>01100                                                 {
<a name="l01101"></a>01101                                                         <span class="keywordflow">if</span>(req-&gt;getRequestParam(name)==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01102"></a>01102                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: 0.0,&quot;</span>;
<a name="l01103"></a>01103                                                         <span class="keywordflow">else</span>
<a name="l01104"></a>01104                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: &quot;</span> + req-&gt;getRequestParam(name) + <span class="stringliteral">&quot;,&quot;</span>;
<a name="l01105"></a>01105                                                 }
<a name="l01106"></a>01106                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fld.getType()==<span class="stringliteral">&quot;bool&quot;</span>)
<a name="l01107"></a>01107                                                 {
<a name="l01108"></a>01108                                                         <span class="keywordflow">if</span>(req-&gt;getRequestParam(name)==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01109"></a>01109                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: false,&quot;</span>;
<a name="l01110"></a>01110                                                         <span class="keywordflow">else</span>
<a name="l01111"></a>01111                                                                 json += <span class="stringliteral">&quot;\&quot;&quot;</span>+eles.at(apps).getAttribute(<span class="stringliteral">&quot;prop&quot;</span>)+<span class="stringliteral">&quot;\&quot;: &quot;</span> + req-&gt;getRequestParam(name) + <span class="stringliteral">&quot;,&quot;</span>;
<a name="l01112"></a>01112                                                 }
<a name="l01113"></a>01113                                         }
<a name="l01114"></a>01114                                 }
<a name="l01115"></a>01115                         }
<a name="l01116"></a>01116                         <span class="keywordflow">if</span>(json.find(<span class="stringliteral">&quot;,&quot;</span>)!=string::npos)
<a name="l01117"></a>01117                         {
<a name="l01118"></a>01118                                 json = json.substr(0,json.length()-1);
<a name="l01119"></a>01119                         }
<a name="l01120"></a>01120                         json += <span class="stringliteral">&quot;}&quot;</span>;
<a name="l01121"></a>01121                         cout &lt;&lt; json &lt;&lt; endl;
<a name="l01122"></a>01122                         <span class="keywordtype">string</span> libName = <span class="stringliteral">&quot;libinter.so&quot;</span>;
<a name="l01123"></a>01123                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l01124"></a>01124                         {
<a name="l01125"></a>01125                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l01126"></a>01126                                 exit(-1);
<a name="l01127"></a>01127                         }
<a name="l01128"></a>01128                         <span class="keywordtype">string</span> meth = <span class="stringliteral">&quot;toVoidP&quot;</span> + ele.getAttribute(<span class="stringliteral">&quot;bean&quot;</span>);
<a name="l01129"></a>01129                         cout &lt;&lt; meth &lt;&lt; endl;
<a name="l01130"></a>01130                         <span class="keywordtype">void</span> *mkr = dlsym(dlib, meth.c_str());
<a name="l01131"></a>01131                         <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01132"></a>01132                         {
<a name="l01133"></a>01133                                 toVoidP f1 = (toVoidP)mkr;
<a name="l01134"></a>01134                                 <span class="keywordtype">void</span> *_beaninst = f1(json);
<a name="l01135"></a>01135                                 FunPtr f =  (FunPtr)mkr;
<a name="l01136"></a>01136                                 <a class="code" href="classClassInfo.html">ClassInfo</a> srv = ref.getClassInfo(ele.getAttribute(<span class="stringliteral">&quot;controller&quot;</span>));
<a name="l01137"></a>01137                                 args argus;
<a name="l01138"></a>01138                                 vals valus;
<a name="l01139"></a>01139                                 <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l01140"></a>01140                                 <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l01141"></a>01141                                 argus.push_back(<span class="stringliteral">&quot;void*&quot;</span>);
<a name="l01142"></a>01142                                 argus.push_back(<span class="stringliteral">&quot;HttpResponse*&quot;</span>);
<a name="l01143"></a>01143                                 valus.push_back(_beaninst);
<a name="l01144"></a>01144                                 valus.push_back(&amp;res);
<a name="l01145"></a>01145                                 <a class="code" href="classMethod.html">Method</a> meth = srv.getMethod(<span class="stringliteral">&quot;onSubmit&quot;</span>,argus);
<a name="l01146"></a>01146                                 <span class="keywordflow">if</span>(meth.getMethodName()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01147"></a>01147                                 {
<a name="l01148"></a>01148                                         ref.invokeMethodUnknownReturn(_temp,meth,valus);
<a name="l01149"></a>01149                                         cout &lt;&lt; <span class="stringliteral">&quot;successfully called formcontroller&quot;</span> &lt;&lt; endl;
<a name="l01150"></a>01150                                         <span class="comment">//return;</span>
<a name="l01151"></a>01151                                 }
<a name="l01152"></a>01152                                 <span class="keywordflow">else</span>
<a name="l01153"></a>01153                                 {
<a name="l01154"></a>01154                                         res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01155"></a>01155                                         res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01156"></a>01156                                         res.setContent_type(<span class="stringliteral">&quot;text/plain&quot;</span>);
<a name="l01157"></a>01157                                         res.setContent_str(<span class="stringliteral">&quot;Controller Method Not Found&quot;</span>);
<a name="l01158"></a>01158                                         cout &lt;&lt; <span class="stringliteral">&quot;Controller Method Not Found&quot;</span> &lt;&lt; endl;
<a name="l01159"></a>01159                                         <span class="comment">//return;</span>
<a name="l01160"></a>01160                                 }
<a name="l01161"></a>01161                         }
<a name="l01162"></a>01162                 }
<a name="l01163"></a>01163                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(req-&gt;getMethod()==<span class="stringliteral">&quot;POST&quot;</span> &amp;&amp; req-&gt;getRequestParam(<span class="stringliteral">&quot;claz&quot;</span>)!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; req-&gt;getRequestParam(<span class="stringliteral">&quot;method&quot;</span>)!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01164"></a>01164                 {
<a name="l01165"></a>01165                         content = AfcUtil::execute(*req);
<a name="l01166"></a>01166                         res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01167"></a>01167                         res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01168"></a>01168                         res.setContent_type(props[<span class="stringliteral">&quot;.txt&quot;</span>]);
<a name="l01169"></a>01169                         res.setContent_str(content);
<a name="l01170"></a>01170                         <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01171"></a>01171                 }
<a name="l01172"></a>01172                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.dcp&quot;</span>)
<a name="l01173"></a>01173                 {
<a name="l01174"></a>01174                         <span class="keywordtype">string</span> libName = <span class="stringliteral">&quot;libinter.so&quot;</span>;
<a name="l01175"></a>01175                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l01176"></a>01176                         {
<a name="l01177"></a>01177                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l01178"></a>01178                                 exit(-1);
<a name="l01179"></a>01179                         }
<a name="l01180"></a>01180                         <span class="keywordtype">int</span> s = req-&gt;getUrl().find_last_of(<span class="stringliteral">&quot;/&quot;</span>)+1;
<a name="l01181"></a>01181                         <span class="keywordtype">int</span> en = req-&gt;getUrl().find_last_of(<span class="stringliteral">&quot;.&quot;</span>);
<a name="l01182"></a>01182                         <span class="keywordtype">string</span> meth,file;
<a name="l01183"></a>01183                         file = req-&gt;getUrl().substr(s,en-s);
<a name="l01184"></a>01184                         meth = <span class="stringliteral">&quot;_&quot;</span> + file + <span class="stringliteral">&quot;emittHTML&quot;</span>;
<a name="l01185"></a>01185 
<a name="l01186"></a>01186                         <span class="keywordtype">void</span> *mkr = dlsym(dlib, meth.c_str());
<a name="l01187"></a>01187                         <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01188"></a>01188                         {
<a name="l01189"></a>01189                                 cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;inside dcp &quot;</span> &lt;&lt; meth &lt;&lt; endl;
<a name="l01190"></a>01190                                 DCPPtr f =  (DCPPtr)mkr;
<a name="l01191"></a>01191                                 content = f();
<a name="l01192"></a>01192                                 <span class="comment">//string patf;</span>
<a name="l01193"></a>01193                                 <span class="comment">//patf = req-&gt;getCntxt_root() + &quot;/dcp_&quot; + file + &quot;.html&quot;;</span>
<a name="l01194"></a>01194                                 <span class="comment">//content = getContentStr(patf,lprops[req-&gt;getDefaultLocale()],ext);</span>
<a name="l01195"></a>01195                                 <span class="comment">//delete mkr;</span>
<a name="l01196"></a>01196                         }
<a name="l01197"></a>01197                         ext = <span class="stringliteral">&quot;.html&quot;</span>;
<a name="l01198"></a>01198                         <span class="keywordflow">if</span>(ext!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; content.length()==0)
<a name="l01199"></a>01199                         {
<a name="l01200"></a>01200                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01201"></a>01201                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01202"></a>01202                                 <span class="comment">//res.setContent_len(&quot;0&quot;);</span>
<a name="l01203"></a>01203                         }
<a name="l01204"></a>01204                         <span class="keywordflow">else</span>
<a name="l01205"></a>01205                         {
<a name="l01206"></a>01206                                 res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01207"></a>01207                                 res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01208"></a>01208                                 res.setContent_type(props[ext]);
<a name="l01209"></a>01209                                 res.setContent_str(content);
<a name="l01210"></a>01210                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01211"></a>01211                         }
<a name="l01212"></a>01212                 }
<a name="l01213"></a>01213                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.view&quot;</span> &amp;&amp; vwMap[req-&gt;getCntxt_name()+req-&gt;getFile()]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01214"></a>01214                 {
<a name="l01215"></a>01215                         <span class="keywordtype">string</span> libName = <span class="stringliteral">&quot;libinter.so&quot;</span>;
<a name="l01216"></a>01216                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l01217"></a>01217                         {
<a name="l01218"></a>01218                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l01219"></a>01219                                 exit(-1);
<a name="l01220"></a>01220                         }
<a name="l01221"></a>01221                         claz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + vwMap[req-&gt;getCntxt_name()+req-&gt;getFile()];
<a name="l01222"></a>01222                         <span class="keywordtype">void</span> *mkr = dlsym(dlib, claz.c_str());
<a name="l01223"></a>01223                         <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01224"></a>01224                         {
<a name="l01225"></a>01225                                 FunPtr f =  (FunPtr)mkr;
<a name="l01226"></a>01226                                 <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l01227"></a>01227                                 args argus;
<a name="l01228"></a>01228                                 <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l01229"></a>01229                                 <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l01230"></a>01230                                 <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l01231"></a>01231                                 <a class="code" href="classDynamicView.html">DynamicView</a> *thrd = (<a class="code" href="classDynamicView.html">DynamicView</a> *)_temp;
<a name="l01232"></a>01232                                 <a class="code" href="classDocument.html">Document</a> doc = thrd-&gt;getDocument();
<a name="l01233"></a>01233                                 <a class="code" href="classView.html">View</a> view;
<a name="l01234"></a>01234                                 <span class="keywordtype">string</span> t = view.generateDocument(doc);
<a name="l01235"></a>01235                                 content = t;
<a name="l01236"></a>01236                         }
<a name="l01237"></a>01237                         ext = <span class="stringliteral">&quot;.html&quot;</span>;
<a name="l01238"></a>01238                         <span class="keywordflow">if</span>(ext!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; (content.length()==0))
<a name="l01239"></a>01239                         {
<a name="l01240"></a>01240                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01241"></a>01241                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01242"></a>01242                                 <span class="comment">//res.setContent_len(&quot;0&quot;);</span>
<a name="l01243"></a>01243                         }
<a name="l01244"></a>01244                         <span class="keywordflow">else</span>
<a name="l01245"></a>01245                         {
<a name="l01246"></a>01246                                 res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01247"></a>01247                                 res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01248"></a>01248                                 res.setContent_type(props[ext]);
<a name="l01249"></a>01249                                 res.setContent_str(content);
<a name="l01250"></a>01250                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01251"></a>01251                         }
<a name="l01252"></a>01252                 }
<a name="l01253"></a>01253                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.tpe&quot;</span> &amp;&amp; tmplMap[req-&gt;getCntxt_name()+req-&gt;getFile()]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l01254"></a>01254                 {
<a name="l01255"></a>01255                         <a class="code" href="classTemplateEngine.html">TemplateEngine</a> te;
<a name="l01256"></a>01256                         ext = <span class="stringliteral">&quot;.html&quot;</span>;
<a name="l01257"></a>01257                         <span class="keywordflow">if</span>(dlib == NULL)
<a name="l01258"></a>01258                         {
<a name="l01259"></a>01259                                 cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l01260"></a>01260                                 exit(-1);
<a name="l01261"></a>01261                         }
<a name="l01262"></a>01262                         claz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + tmplMap[req-&gt;getCntxt_name()+req-&gt;getFile()];
<a name="l01263"></a>01263                         <span class="keywordtype">void</span> *mkr = dlsym(dlib, claz.c_str());
<a name="l01264"></a>01264                         <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01265"></a>01265                         {
<a name="l01266"></a>01266                                 FunPtr f =  (FunPtr)mkr;
<a name="l01267"></a>01267                                 <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l01268"></a>01268                                 args argus;
<a name="l01269"></a>01269                                 <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l01270"></a>01270                                 <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l01271"></a>01271                                 <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l01272"></a>01272                                 <a class="code" href="classTemplateHandler.html">TemplateHandler</a> *thrd = (<a class="code" href="classTemplateHandler.html">TemplateHandler</a> *)_temp;
<a name="l01273"></a>01273                                 Context cnt = thrd-&gt;getContext();
<a name="l01274"></a>01274                                 <span class="keywordtype">string</span> t = te.evaluate(req-&gt;getUrl(),cnt);
<a name="l01275"></a>01275                                 content = t;
<a name="l01276"></a>01276                         }
<a name="l01277"></a>01277                         <span class="keywordflow">if</span>(ext!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; (content.length()==0))
<a name="l01278"></a>01278                         {
<a name="l01279"></a>01279                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01280"></a>01280                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01281"></a>01281                                 <span class="comment">//res.setContent_len(&quot;0&quot;);</span>
<a name="l01282"></a>01282                         }
<a name="l01283"></a>01283                         <span class="keywordflow">else</span>
<a name="l01284"></a>01284                         {
<a name="l01285"></a>01285                                 res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01286"></a>01286                                 res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01287"></a>01287                                 res.setContent_type(props[ext]);
<a name="l01288"></a>01288                                 res.setContent_str(content);
<a name="l01289"></a>01289                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01290"></a>01290                         }
<a name="l01291"></a>01291                 }
<a name="l01292"></a>01292                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>((req-&gt;getContent_type().find(<span class="stringliteral">&quot;application/soap+xml&quot;</span>)!=string::npos || req-&gt;getContent_type().find(<span class="stringliteral">&quot;text/xml&quot;</span>)!=string::npos)
<a name="l01293"></a>01293                                 &amp;&amp; (req-&gt;getContent().find(<span class="stringliteral">&quot;&lt;soap:Envelope&quot;</span>)!=string::npos || req-&gt;getContent().find(<span class="stringliteral">&quot;&lt;soapenv:Envelope&quot;</span>)!=string::npos)
<a name="l01294"></a>01294                                 &amp;&amp; wsdlmap[req-&gt;getFile()]==req-&gt;getCntxt_name())
<a name="l01295"></a>01295                 {
<a name="l01296"></a>01296                         <span class="keywordtype">string</span> meth,ws_name,env;
<a name="l01297"></a>01297                         ws_name = req-&gt;getFile();
<a name="l01298"></a>01298                         <a class="code" href="classElement.html">Element</a> soapenv;
<a name="l01299"></a>01299                         Logger::info(<span class="stringliteral">&quot;request =&gt; &quot;</span>+req-&gt;getContent());
<a name="l01300"></a>01300                         <a class="code" href="classElement.html">Element</a> soapbody;
<a name="l01301"></a>01301                         <span class="keywordflow">try</span>
<a name="l01302"></a>01302                         {
<a name="l01303"></a>01303                                 <a class="code" href="classXmlParser.html">XmlParser</a> parser(<span class="stringliteral">&quot;Parser&quot;</span>);
<a name="l01304"></a>01304                                 <a class="code" href="classDocument.html">Document</a> doc = parser.getDocument(req-&gt;getContent());
<a name="l01305"></a>01305                                 soapenv = doc.getRootElement();
<a name="l01306"></a>01306                                 cout &lt;&lt; soapenv.getTagName() &lt;&lt; <span class="stringliteral">&quot;----\n&quot;</span> &lt;&lt; flush;
<a name="l01307"></a>01307 
<a name="l01308"></a>01308                                 <span class="keywordflow">if</span>(soapenv.getChildElements().size()==1
<a name="l01309"></a>01309                                                 &amp;&amp; soapenv.getChildElements().at(0).getTagName()==<span class="stringliteral">&quot;Body&quot;</span>)
<a name="l01310"></a>01310                                         soapbody = soapenv.getChildElements().at(0);
<a name="l01311"></a>01311                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(soapenv.getChildElements().size()==2
<a name="l01312"></a>01312                                                 &amp;&amp; soapenv.getChildElements().at(1).getTagName()==<span class="stringliteral">&quot;Body&quot;</span>)
<a name="l01313"></a>01313                                         soapbody = soapenv.getChildElements().at(1);
<a name="l01314"></a>01314                                 cout &lt;&lt; soapbody.getTagName() &lt;&lt; <span class="stringliteral">&quot;----\n&quot;</span> &lt;&lt; flush;
<a name="l01315"></a>01315                                 <a class="code" href="classElement.html">Element</a> method = soapbody.getChildElements().at(0);
<a name="l01316"></a>01316                                 cout &lt;&lt; method.getTagName() &lt;&lt; <span class="stringliteral">&quot;----\n&quot;</span> &lt;&lt; flush;
<a name="l01317"></a>01317                                 meth = method.getTagName();
<a name="l01318"></a>01318                                 <span class="keywordtype">string</span> methodname = meth + ws_name;
<a name="l01319"></a>01319                                 cout &lt;&lt; methodname &lt;&lt; <span class="stringliteral">&quot;----\n&quot;</span> &lt;&lt; flush;
<a name="l01320"></a>01320                                 <span class="keywordtype">void</span> *mkr = dlsym(dlib, methodname.c_str());
<a name="l01321"></a>01321                                 <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01322"></a>01322                                 {
<a name="l01323"></a>01323                                         <span class="keyword">typedef</span> string (*WsPtr) (<a class="code" href="classElement.html">Element</a>);
<a name="l01324"></a>01324                                         WsPtr f =  (WsPtr)mkr;
<a name="l01325"></a>01325                                         <span class="keywordtype">string</span> outpt = f(method);
<a name="l01326"></a>01326                                         <span class="keyword">typedef</span> map&lt;string,string&gt; AttributeList;
<a name="l01327"></a>01327                                         AttributeList attl = soapbody.getAttributes();
<a name="l01328"></a>01328                                         AttributeList::iterator it;
<a name="l01329"></a>01329                                         <span class="keywordtype">string</span> bod = <span class="stringliteral">&quot;&lt;&quot;</span> + soapbody.getTagNameSpc();
<a name="l01330"></a>01330                                         <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01331"></a>01331                                         {
<a name="l01332"></a>01332                                                 bod.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01333"></a>01333                                         }
<a name="l01334"></a>01334                                         bod.append(<span class="stringliteral">&quot;&gt;&quot;</span>+outpt + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapbody.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01335"></a>01335                                         attl = soapenv.getAttributes();
<a name="l01336"></a>01336                                         env = <span class="stringliteral">&quot;&lt;&quot;</span> + soapenv.getTagNameSpc();
<a name="l01337"></a>01337                                         <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01338"></a>01338                                         {
<a name="l01339"></a>01339                                                 env.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01340"></a>01340                                         }
<a name="l01341"></a>01341                                         env.append(<span class="stringliteral">&quot;&gt;&quot;</span>+bod + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapenv.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01342"></a>01342                                         <span class="comment">//delete mkr;</span>
<a name="l01343"></a>01343                                 }
<a name="l01344"></a>01344                                 <span class="keywordflow">else</span>
<a name="l01345"></a>01345                                 {
<a name="l01346"></a>01346                                         <span class="keyword">typedef</span> map&lt;string,string&gt; AttributeList;
<a name="l01347"></a>01347                                         AttributeList attl = soapbody.getAttributes();
<a name="l01348"></a>01348                                         AttributeList::iterator it;
<a name="l01349"></a>01349                                         <span class="keywordtype">string</span> bod = <span class="stringliteral">&quot;&lt;&quot;</span> + soapbody.getTagNameSpc();
<a name="l01350"></a>01350                                         <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01351"></a>01351                                         {
<a name="l01352"></a>01352                                                 bod.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01353"></a>01353                                         }
<a name="l01354"></a>01354                                         bod.append(<span class="stringliteral">&quot;&gt;&lt;soap-fault&gt;&lt;faultcode&gt;soap:Server&lt;/faultcode&gt;&lt;faultstring&gt;Operation not supported&lt;/faultstring&gt;&lt;faultactor/&gt;&lt;detail&gt;No such method error&lt;/detail&gt;&lt;soap-fault&gt;&lt;/&quot;</span> + soapbody.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01355"></a>01355                                         attl = soapenv.getAttributes();
<a name="l01356"></a>01356                                         env = <span class="stringliteral">&quot;&lt;&quot;</span> + soapenv.getTagNameSpc();
<a name="l01357"></a>01357                                         <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01358"></a>01358                                         {
<a name="l01359"></a>01359                                                 env.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01360"></a>01360                                         }
<a name="l01361"></a>01361                                         env.append(<span class="stringliteral">&quot;&gt;&quot;</span>+bod + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapenv.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01362"></a>01362                                 }
<a name="l01363"></a>01363                                 cout &lt;&lt; <span class="stringliteral">&quot;\n----------------------------------------------------------------------------\n&quot;</span> &lt;&lt; flush;
<a name="l01364"></a>01364                                 cout &lt;&lt; env &lt;&lt; <span class="stringliteral">&quot;\n----------------------------------------------------------------------------\n&quot;</span> &lt;&lt; flush;
<a name="l01365"></a>01365                         }
<a name="l01366"></a>01366                         <span class="keywordflow">catch</span>(<span class="keywordtype">string</span> &amp;fault)
<a name="l01367"></a>01367                         {
<a name="l01368"></a>01368                                 <span class="keyword">typedef</span> map&lt;string,string&gt; AttributeList;
<a name="l01369"></a>01369                                 AttributeList attl = soapbody.getAttributes();
<a name="l01370"></a>01370                                 AttributeList::iterator it;
<a name="l01371"></a>01371                                 <span class="keywordtype">string</span> bod = <span class="stringliteral">&quot;&lt;&quot;</span> + soapbody.getTagNameSpc();
<a name="l01372"></a>01372                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01373"></a>01373                                 {
<a name="l01374"></a>01374                                         bod.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01375"></a>01375                                 }
<a name="l01376"></a>01376                                 bod.append(<span class="stringliteral">&quot;&gt;&lt;soap-fault&gt;&lt;faultcode&gt;soap:Server&lt;/faultcode&gt;&lt;faultstring&gt;&quot;</span>+fault+<span class="stringliteral">&quot;&lt;/faultstring&gt;&lt;detail&gt;&lt;/detail&gt;&lt;soap-fault&gt;&lt;/&quot;</span> + soapbody.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01377"></a>01377                                 attl = soapenv.getAttributes();
<a name="l01378"></a>01378                                 env = <span class="stringliteral">&quot;&lt;&quot;</span> + soapenv.getTagNameSpc();
<a name="l01379"></a>01379                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01380"></a>01380                                 {
<a name="l01381"></a>01381                                         env.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01382"></a>01382                                 }
<a name="l01383"></a>01383                                 env.append(<span class="stringliteral">&quot;&gt;&quot;</span>+bod + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapenv.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01384"></a>01384                                 cout &lt;&lt; fault &lt;&lt; flush;
<a name="l01385"></a>01385                         }
<a name="l01386"></a>01386                         <span class="keywordflow">catch</span>(<a class="code" href="classException.html">Exception</a> *e)
<a name="l01387"></a>01387                         {
<a name="l01388"></a>01388                                 <span class="keyword">typedef</span> map&lt;string,string&gt; AttributeList;
<a name="l01389"></a>01389                                 AttributeList attl = soapbody.getAttributes();
<a name="l01390"></a>01390                                 AttributeList::iterator it;
<a name="l01391"></a>01391                                 <span class="keywordtype">string</span> bod = <span class="stringliteral">&quot;&lt;&quot;</span> + soapbody.getTagNameSpc();
<a name="l01392"></a>01392                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01393"></a>01393                                 {
<a name="l01394"></a>01394                                         bod.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01395"></a>01395                                 }
<a name="l01396"></a>01396                                 bod.append(<span class="stringliteral">&quot;&gt;&lt;soap-fault&gt;&lt;faultcode&gt;soap:Server&lt;/faultcode&gt;&lt;faultstring&gt;&quot;</span>+e-&gt;what()+<span class="stringliteral">&quot;&lt;/faultstring&gt;&lt;detail&gt;&lt;/detail&gt;&lt;soap-fault&gt;&lt;/&quot;</span> + soapbody.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01397"></a>01397                                 attl = soapenv.getAttributes();
<a name="l01398"></a>01398                                 env = <span class="stringliteral">&quot;&lt;&quot;</span> + soapenv.getTagNameSpc();
<a name="l01399"></a>01399                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01400"></a>01400                                 {
<a name="l01401"></a>01401                                         env.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01402"></a>01402                                 }
<a name="l01403"></a>01403                                 env.append(<span class="stringliteral">&quot;&gt;&quot;</span>+bod + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapenv.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01404"></a>01404                                 cout &lt;&lt; e-&gt;what() &lt;&lt; flush;
<a name="l01405"></a>01405                         }
<a name="l01406"></a>01406                         <span class="keywordflow">catch</span>(...)
<a name="l01407"></a>01407                         {
<a name="l01408"></a>01408                                 <span class="keyword">typedef</span> map&lt;string,string&gt; AttributeList;
<a name="l01409"></a>01409                                 AttributeList attl = soapbody.getAttributes();
<a name="l01410"></a>01410                                 AttributeList::iterator it;
<a name="l01411"></a>01411                                 <span class="keywordtype">string</span> bod = <span class="stringliteral">&quot;&lt;&quot;</span> + soapbody.getTagNameSpc();
<a name="l01412"></a>01412                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01413"></a>01413                                 {
<a name="l01414"></a>01414                                         bod.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01415"></a>01415                                 }
<a name="l01416"></a>01416                                 bod.append(<span class="stringliteral">&quot;&gt;&lt;soap-fault&gt;&lt;faultcode&gt;soap:Server&lt;/faultcode&gt;&lt;faultstring&gt;Standard Exception&lt;/faultstring&gt;&lt;detail&gt;&lt;/detail&gt;&lt;soap-fault&gt;&lt;/&quot;</span> + soapbody.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01417"></a>01417                                 attl = soapenv.getAttributes();
<a name="l01418"></a>01418                                 env = <span class="stringliteral">&quot;&lt;&quot;</span> + soapenv.getTagNameSpc();
<a name="l01419"></a>01419                                 <span class="keywordflow">for</span>(it=attl.begin();it!=attl.end();it++)
<a name="l01420"></a>01420                                 {
<a name="l01421"></a>01421                                         env.append(<span class="stringliteral">&quot; &quot;</span> + it-&gt;first + <span class="stringliteral">&quot;=\&quot;&quot;</span> + it-&gt;second + <span class="stringliteral">&quot;\&quot; &quot;</span>);
<a name="l01422"></a>01422                                 }
<a name="l01423"></a>01423                                 env.append(<span class="stringliteral">&quot;&gt;&quot;</span>+bod + <span class="stringliteral">&quot;&lt;/&quot;</span> + soapenv.getTagNameSpc()+<span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01424"></a>01424                                 cout &lt;&lt; <span class="stringliteral">&quot;Standard Exception&quot;</span> &lt;&lt; flush;
<a name="l01425"></a>01425                         }
<a name="l01426"></a>01426                         res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01427"></a>01427                         res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01428"></a>01428                         res.setContent_type(props[<span class="stringliteral">&quot;.xml&quot;</span>]);
<a name="l01429"></a>01429                         res.setContent_str(env);
<a name="l01430"></a>01430                         <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(env.length()));</span>
<a name="l01431"></a>01431                 }
<a name="l01432"></a>01432                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.wsdl&quot;</span>)
<a name="l01433"></a>01433                 {
<a name="l01434"></a>01434                         content = getContentStr(resourcePath+req-&gt;getFile(),<span class="stringliteral">&quot;english&quot;</span>,ext);
<a name="l01435"></a>01435                         <span class="keywordflow">if</span>((content.length()==0))
<a name="l01436"></a>01436                         {
<a name="l01437"></a>01437                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01438"></a>01438                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01439"></a>01439                                 <span class="comment">//res.setContent_len(&quot;0&quot;);</span>
<a name="l01440"></a>01440                         }
<a name="l01441"></a>01441                         <span class="keywordflow">else</span>
<a name="l01442"></a>01442                         {
<a name="l01443"></a>01443                                 res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01444"></a>01444                                 res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01445"></a>01445                                 res.setContent_type(props[ext]);
<a name="l01446"></a>01446                                 res.setContent_str(content);
<a name="l01447"></a>01447                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01448"></a>01448                         }
<a name="l01449"></a>01449                 }
<a name="l01450"></a>01450                 <span class="keywordflow">else</span>
<a name="l01451"></a>01451                 {
<a name="l01452"></a>01452                         <span class="keywordflow">if</span>(ext==<span class="stringliteral">&quot;.fview&quot;</span>)
<a name="l01453"></a>01453                         {
<a name="l01454"></a>01454                                 cout &lt;&lt; <span class="stringliteral">&quot;inside fview &quot;</span> &lt;&lt; req-&gt;getFile() &lt;&lt; endl;
<a name="l01455"></a>01455                                 <span class="keywordtype">string</span> file = req-&gt;getFile();
<a name="l01456"></a>01456                                 boost::replace_first(file,<span class="stringliteral">&quot;fview&quot;</span>,<span class="stringliteral">&quot;html&quot;</span>);
<a name="l01457"></a>01457                                 <span class="keywordtype">string</span> ffile = req-&gt;getCntxt_root()+<span class="stringliteral">&quot;/fviews/&quot;</span>+file;
<a name="l01458"></a>01458                                 cout &lt;&lt; ffile &lt;&lt; endl;
<a name="l01459"></a>01459                                 ifstream infile(ffile.c_str());
<a name="l01460"></a>01460                                 <span class="keywordtype">string</span> temp;
<a name="l01461"></a>01461                                 <span class="keywordflow">if</span>(infile.is_open())
<a name="l01462"></a>01462                                 {
<a name="l01463"></a>01463                                         content = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01464"></a>01464                                         <span class="keywordflow">while</span>(getline(infile, temp))
<a name="l01465"></a>01465                                         {
<a name="l01466"></a>01466                                                 <span class="keywordflow">if</span>(temp.find(<span class="stringliteral">&quot;&lt;?&quot;</span>)==string::npos &amp;&amp; temp.find(<span class="stringliteral">&quot;?&gt;&quot;</span>)==string::npos)
<a name="l01467"></a>01467                                                         content.append(temp);
<a name="l01468"></a>01468                                         }
<a name="l01469"></a>01469                                         <span class="keywordtype">int</span> h = content.find(<span class="stringliteral">&quot;&lt;/head&gt;&quot;</span>);
<a name="l01470"></a>01470                                         <span class="keywordtype">int</span> ht = content.find(<span class="stringliteral">&quot;&lt;html&gt;&quot;</span>);
<a name="l01471"></a>01471                                         <span class="keywordflow">if</span>(h!=string::npos)
<a name="l01472"></a>01472                                         {
<a name="l01473"></a>01473                                                 <span class="keywordtype">string</span> st = content.substr(0,h-1);
<a name="l01474"></a>01474                                                 <span class="keywordtype">string</span> en = content.substr(h);
<a name="l01475"></a>01475                                                 content = st + <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/json2.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01476"></a>01476                                                 content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/prototype.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01477"></a>01477                                                 content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/afc.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01478"></a>01478                                                 content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/_afc_Objects.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01479"></a>01479                                                 content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/_afc_Interfaces.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01480"></a>01480                                                 content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/&quot;</span>+fviewmap[file]+<span class="stringliteral">&quot;.js\&quot;&gt;&lt;/script&gt;&quot;</span> + en;
<a name="l01481"></a>01481                                         }
<a name="l01482"></a>01482                                         <span class="keywordflow">else</span>
<a name="l01483"></a>01483                                         {
<a name="l01484"></a>01484                                                 <span class="keywordflow">if</span>(ht!=string::npos)
<a name="l01485"></a>01485                                                 {
<a name="l01486"></a>01486                                                         <span class="keywordtype">string</span> st = content.substr(0,ht+6);
<a name="l01487"></a>01487                                                         <span class="keywordtype">string</span> en = content.substr(ht+6);
<a name="l01488"></a>01488                                                         content = st + <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/json2.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01489"></a>01489                                                         content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/prototype.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01490"></a>01490                                                         content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/afc.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01491"></a>01491                                                         content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/_afc_Objects.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01492"></a>01492                                                         content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/_afc_Interfaces.js\&quot;&gt;&lt;/script&gt;&quot;</span>;
<a name="l01493"></a>01493                                                         content += <span class="stringliteral">&quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;public/&quot;</span>+fviewmap[file]+<span class="stringliteral">&quot;.js\&quot;&gt;&lt;/script&gt;&quot;</span> + en;
<a name="l01494"></a>01494                                                 }
<a name="l01495"></a>01495                                         }
<a name="l01496"></a>01496                                 }
<a name="l01497"></a>01497                                 infile.close();
<a name="l01498"></a>01498                                 res.setContent_type(<span class="stringliteral">&quot;text/html&quot;</span>);
<a name="l01499"></a>01499                                 cout &lt;&lt; content &lt;&lt; flush;
<a name="l01500"></a>01500                         }
<a name="l01501"></a>01501                         <span class="keywordflow">else</span>
<a name="l01502"></a>01502                         {
<a name="l01503"></a>01503                                 <span class="keywordflow">if</span>(res.getContent_str()==<span class="stringliteral">&quot;&quot;</span>)
<a name="l01504"></a>01504                                         content = getContentStr(req-&gt;getUrl(),lprops[req-&gt;getDefaultLocale()],ext);
<a name="l01505"></a>01505                                 <span class="keywordflow">else</span>
<a name="l01506"></a>01506                                         content = res.getContent_str();
<a name="l01507"></a>01507                         }
<a name="l01508"></a>01508                         <span class="keywordflow">if</span>(ext!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; (content.length()==0))
<a name="l01509"></a>01509                         {
<a name="l01510"></a>01510                                 res.setStatusCode(<span class="stringliteral">&quot;404&quot;</span>);
<a name="l01511"></a>01511                                 res.setStatusMsg(<span class="stringliteral">&quot;Not Found&quot;</span>);
<a name="l01512"></a>01512                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(0));</span>
<a name="l01513"></a>01513                         }
<a name="l01514"></a>01514                         <span class="keywordflow">else</span>
<a name="l01515"></a>01515                         {
<a name="l01516"></a>01516                                 res.setStatusCode(<span class="stringliteral">&quot;200&quot;</span>);
<a name="l01517"></a>01517                                 res.setStatusMsg(<span class="stringliteral">&quot;OK&quot;</span>);
<a name="l01518"></a>01518                                 res.setContent_type(props[ext]);
<a name="l01519"></a>01519                                 res.setContent_str(content);
<a name="l01520"></a>01520                                 <span class="comment">//res.setContent_len(boost::lexical_cast&lt;string&gt;(content.length()));</span>
<a name="l01521"></a>01521                                 <span class="comment">//sess.setAttribute(&quot;CURR&quot;,req-&gt;getUrl());</span>
<a name="l01522"></a>01522                         }
<a name="l01523"></a>01523                 }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525                 <span class="keywordflow">if</span>(filterMap.find(req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*out&quot;</span>)!=filterMap.end() || filterMap.find(req-&gt;getCntxt_name()+ext+<span class="stringliteral">&quot;out&quot;</span>)!=filterMap.end())
<a name="l01526"></a>01526                 {
<a name="l01527"></a>01527                         vector&lt;string&gt; tempp;
<a name="l01528"></a>01528                         <span class="keywordflow">if</span>(filterMap.find(req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*out&quot;</span>)!=filterMap.end())
<a name="l01529"></a>01529                                 tempp = filterMap[req-&gt;getCntxt_name()+<span class="stringliteral">&quot;*.*out&quot;</span>];
<a name="l01530"></a>01530                         <span class="keywordflow">else</span>
<a name="l01531"></a>01531                                 tempp = filterMap[req-&gt;getCntxt_name()+ext+<span class="stringliteral">&quot;out&quot;</span>];
<a name="l01532"></a>01532 
<a name="l01533"></a>01533                         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> var = 0; var &lt; tempp.size(); ++var)
<a name="l01534"></a>01534                         {
<a name="l01535"></a>01535                                 <span class="keywordtype">string</span> clasz = tempp.at(var);
<a name="l01536"></a>01536                                 clasz = <span class="stringliteral">&quot;getReflectionCIFor&quot;</span> + clasz;
<a name="l01537"></a>01537                                 cout &lt;&lt; <span class="stringliteral">&quot;filter handled by class &quot;</span> &lt;&lt; clasz &lt;&lt; endl;
<a name="l01538"></a>01538                                 <span class="keywordflow">if</span>(dlib == NULL)
<a name="l01539"></a>01539                                 {
<a name="l01540"></a>01540                                         cerr &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l01541"></a>01541                                         exit(-1);
<a name="l01542"></a>01542                                 }
<a name="l01543"></a>01543                                 <span class="keywordtype">void</span> *mkr = dlsym(dlib, clasz.c_str());
<a name="l01544"></a>01544                                 <span class="keywordflow">if</span>(mkr!=NULL)
<a name="l01545"></a>01545                                 {
<a name="l01546"></a>01546                                         FunPtr f =  (FunPtr)mkr;
<a name="l01547"></a>01547                                         <a class="code" href="classClassInfo.html">ClassInfo</a> srv = f();
<a name="l01548"></a>01548                                         args argus;
<a name="l01549"></a>01549                                         <a class="code" href="classConstructor.html">Constructor</a> ctor = srv.getConstructor(argus);
<a name="l01550"></a>01550                                         <a class="code" href="classReflector.html">Reflector</a> ref;
<a name="l01551"></a>01551                                         <span class="keywordtype">void</span> *_temp = ref.newInstanceGVP(ctor);
<a name="l01552"></a>01552                                         <a class="code" href="classFilter.html">Filter</a> *filter = (<a class="code" href="classFilter.html">Filter</a>*)_temp;
<a name="l01553"></a>01553                                         filter-&gt;doOutputFilter(&amp;res);
<a name="l01554"></a>01554                                         cout &lt;&lt; <span class="stringliteral">&quot;filter called&quot;</span> &lt;&lt; endl;
<a name="l01555"></a>01555                                         <span class="keyword">delete</span> _temp;
<a name="l01556"></a>01556                                 }
<a name="l01557"></a>01557                         }
<a name="l01558"></a>01558                 }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560                 alldatlg += <span class="stringliteral">&quot;--processed data&quot;</span>;
<a name="l01561"></a>01561                 <span class="keywordtype">string</span> h1;
<a name="l01562"></a>01562                 <span class="keywordtype">bool</span> sessionchanged = !req-&gt;hasCookie();
<a name="l01563"></a>01563                 sessionchanged |= req-&gt;getSession()-&gt;isDirty();
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                 createResponse(res,sessionchanged,req-&gt;getSession()-&gt;getSessionAttributes(),req-&gt;getCookieInfo()[<span class="stringliteral">&quot;FFEADID&quot;</span>]);
<a name="l01566"></a>01566                 h1 = res.generateResponse();
<a name="l01567"></a>01567                 <span class="comment">//cout &lt;&lt; h1 &lt;&lt; endl;</span>
<a name="l01568"></a>01568                 <span class="keywordflow">if</span>(isSSLEnabled)
<a name="l01569"></a>01569                 {
<a name="l01570"></a>01570                         <span class="keywordtype">int</span> r;
<a name="l01571"></a>01571                         <span class="comment">/* Now perform renegotiation if requested */</span>
<a name="l01572"></a>01572                         <span class="keywordflow">if</span>(client_auth==CLIENT_AUTH_REHANDSHAKE){
<a name="l01573"></a>01573                           SSL_set_verify(ssl,SSL_VERIFY_PEER |
<a name="l01574"></a>01574                                 SSL_VERIFY_FAIL_IF_NO_PEER_CERT,0);
<a name="l01575"></a>01575 
<a name="l01576"></a>01576                           <span class="comment">/* Stop the client from just resuming the</span>
<a name="l01577"></a>01577 <span class="comment">                                 un-authenticated session */</span>
<a name="l01578"></a>01578                           SSL_set_session_id_context(ssl,
<a name="l01579"></a>01579                                 (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;s_server_auth_session_id_context,
<a name="l01580"></a>01580                                 <span class="keyword">sizeof</span>(s_server_auth_session_id_context));
<a name="l01581"></a>01581 
<a name="l01582"></a>01582                           <span class="keywordflow">if</span>(SSL_renegotiate(ssl)&lt;=0)
<a name="l01583"></a>01583                           {
<a name="l01584"></a>01584                                   error_occurred(<span class="stringliteral">&quot;SSL renegotiation error&quot;</span>,fd,ssl);
<a name="l01585"></a>01585                                   <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l01586"></a>01586                                   <span class="keywordflow">return</span>;
<a name="l01587"></a>01587                           }
<a name="l01588"></a>01588                           <span class="keywordflow">if</span>(SSL_do_handshake(ssl)&lt;=0)
<a name="l01589"></a>01589                           {
<a name="l01590"></a>01590                                   error_occurred(<span class="stringliteral">&quot;SSL renegotiation error&quot;</span>,fd,ssl);
<a name="l01591"></a>01591                                   <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l01592"></a>01592                                   <span class="keywordflow">return</span>;
<a name="l01593"></a>01593                           }
<a name="l01594"></a>01594                           ssl-&gt;state=SSL_ST_ACCEPT;
<a name="l01595"></a>01595                           <span class="keywordflow">if</span>(SSL_do_handshake(ssl)&lt;=0)
<a name="l01596"></a>01596                           {
<a name="l01597"></a>01597                                   error_occurred(<span class="stringliteral">&quot;SSL renegotiation error&quot;</span>,fd,ssl);
<a name="l01598"></a>01598                                   <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l01599"></a>01599                                   <span class="keywordflow">return</span>;
<a name="l01600"></a>01600                           }
<a name="l01601"></a>01601                         }
<a name="l01602"></a>01602                         <span class="keywordflow">if</span>((r=BIO_puts(io,h1.c_str()))&lt;=0)
<a name="l01603"></a>01603                         {
<a name="l01604"></a>01604                                   error_occurred(<span class="stringliteral">&quot;send failed&quot;</span>,fd,ssl);
<a name="l01605"></a>01605                                   <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l01606"></a>01606                                   <span class="keywordflow">return</span>;
<a name="l01607"></a>01607                         }
<a name="l01608"></a>01608                         <span class="comment">/*int size;</span>
<a name="l01609"></a>01609 <span class="comment">                        if(res.getContent_str().length()&gt;0)</span>
<a name="l01610"></a>01610 <span class="comment">                        {</span>
<a name="l01611"></a>01611 <span class="comment">                                if ((size=BIO_puts(io,res.getContent_str().c_str()))&lt;=0)</span>
<a name="l01612"></a>01612 <span class="comment">                                {</span>
<a name="l01613"></a>01613 <span class="comment">                                          error_occurred(&quot;send failed&quot;,fd,ssl);</span>
<a name="l01614"></a>01614 <span class="comment">                                          if(io!=NULL)BIO_free(io);</span>
<a name="l01615"></a>01615 <span class="comment">                                          return;</span>
<a name="l01616"></a>01616 <span class="comment">                                }</span>
<a name="l01617"></a>01617 <span class="comment">                        }*/</span>
<a name="l01618"></a>01618                         <span class="keywordflow">if</span>((r=BIO_flush(io))&lt;0)
<a name="l01619"></a>01619                         {
<a name="l01620"></a>01620                                   error_occurred(<span class="stringliteral">&quot;Error flushing BIO&quot;</span>,fd,ssl);
<a name="l01621"></a>01621                                   <span class="keywordflow">if</span>(io!=NULL)BIO_free(io);
<a name="l01622"></a>01622                                   <span class="keywordflow">return</span>;
<a name="l01623"></a>01623                         }
<a name="l01624"></a>01624                         <span class="comment">//cout &lt;&lt; h1 &lt;&lt; flush;</span>
<a name="l01625"></a>01625                         <span class="comment">//if(io!=NULL)BIO_free_all(io);</span>
<a name="l01626"></a>01626                         closeSSL(fd,ssl,io);
<a name="l01627"></a>01627                 }
<a name="l01628"></a>01628                 <span class="keywordflow">else</span>
<a name="l01629"></a>01629                 {
<a name="l01630"></a>01630                         <span class="keywordtype">int</span> size;
<a name="l01631"></a>01631                         <span class="keywordflow">if</span> ((size=send(fd,&amp;h1[0] , h1.length(), 0)) == -1)
<a name="l01632"></a>01632                                 cout &lt;&lt; <span class="stringliteral">&quot;send failed&quot;</span> &lt;&lt; flush;
<a name="l01633"></a>01633                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(size==0)
<a name="l01634"></a>01634                         {
<a name="l01635"></a>01635                                 close(fd);memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l01636"></a>01636                                 cout &lt;&lt; <span class="stringliteral">&quot;socket closed for writing&quot;</span> &lt;&lt;flush;<span class="keywordflow">return</span>;
<a name="l01637"></a>01637                         }
<a name="l01638"></a>01638 
<a name="l01639"></a>01639 
<a name="l01640"></a>01640                         <span class="comment">/*if(res.getContent_str().length()&gt;0)</span>
<a name="l01641"></a>01641 <span class="comment">                        {</span>
<a name="l01642"></a>01642 <span class="comment">                                if ((size=send(fd,res.getContent_str().c_str(), res.getContent_str().length(),0)) == -1)</span>
<a name="l01643"></a>01643 <span class="comment">                                        cout &lt;&lt; &quot;send failed&quot; &lt;&lt; flush;</span>
<a name="l01644"></a>01644 <span class="comment">                                else if(size==0)</span>
<a name="l01645"></a>01645 <span class="comment">                                {</span>
<a name="l01646"></a>01646 <span class="comment">                                        close(fd);memset(&amp;buf[0], 0, sizeof(buf));</span>
<a name="l01647"></a>01647 <span class="comment">                                        cout &lt;&lt; &quot;socket closed for writing&quot; &lt;&lt;flush;return;</span>
<a name="l01648"></a>01648 <span class="comment">                                }</span>
<a name="l01649"></a>01649 <span class="comment">                        }*/</span>
<a name="l01650"></a>01650                         <span class="keywordflow">if</span>(io!=NULL)BIO_free_all(io);
<a name="l01651"></a>01651                 }
<a name="l01652"></a>01652                 close(fd);
<a name="l01653"></a>01653                 memset(&amp;buf[0], 0, <span class="keyword">sizeof</span>(buf));
<a name="l01654"></a>01654                 ss.clear();
<a name="l01655"></a>01655 
<a name="l01656"></a>01656                 <span class="comment">//Logger::info(&quot;got new connection to process\n&quot;+req-&gt;getFile()+&quot; :: &quot; + res.getStatusCode() + &quot;\n&quot;+req-&gt;getCntxt_name() + &quot;\n&quot;+req-&gt;getCntxt_root() + &quot;\n&quot;+req-&gt;getUrl());</span>
<a name="l01657"></a>01657                 <span class="keyword">delete</span> req;
<a name="l01658"></a>01658                 cout &lt;&lt; alldatlg &lt;&lt; <span class="stringliteral">&quot;--sent data--DONE&quot;</span> &lt;&lt; flush;
<a name="l01659"></a>01659                 <span class="comment">//sessionMap[sessId] = sess;</span>
<a name="l01660"></a>01660         }
<a name="l01661"></a>01661         <span class="keywordflow">catch</span>(...)
<a name="l01662"></a>01662         {
<a name="l01663"></a>01663                 cout &lt;&lt; <span class="stringliteral">&quot;Standard exception: &quot;</span> &lt;&lt; endl;
<a name="l01664"></a>01664         }
<a name="l01665"></a>01665 }
<a name="l01666"></a>01666 
<a name="l01667"></a>01667 
<a name="l01668"></a>01668 <span class="keywordtype">void</span> sigchld_handler(<span class="keywordtype">int</span> s)
<a name="l01669"></a>01669 {
<a name="l01670"></a>01670         <span class="keywordflow">while</span>(waitpid(-1, NULL, WNOHANG) &gt; 0);
<a name="l01671"></a>01671 }
<a name="l01672"></a>01672 
<a name="l01673"></a>01673 <span class="comment">// get sockaddr, IPv4 or IPv6:</span>
<a name="l01674"></a>01674 <span class="keywordtype">void</span> *get_in_addr(<span class="keyword">struct</span> sockaddr *sa)
<a name="l01675"></a>01675 {
<a name="l01676"></a>01676     <span class="keywordflow">if</span> (sa-&gt;sa_family == AF_INET) {
<a name="l01677"></a>01677         <span class="keywordflow">return</span> &amp;(((<span class="keyword">struct </span>sockaddr_in*)sa)-&gt;sin_addr);
<a name="l01678"></a>01678     }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680     <span class="keywordflow">return</span> &amp;(((<span class="keyword">struct </span>sockaddr_in6*)sa)-&gt;sin6_addr);
<a name="l01681"></a>01681 }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 <span class="keywordtype">int</span> send_connection(<span class="keywordtype">int</span> fd,<span class="keywordtype">int</span> unix_socket_fd)
<a name="l01685"></a>01685 {
<a name="l01686"></a>01686         <span class="comment">//struct sockaddr_un unix_socket_name = {0};</span>
<a name="l01687"></a>01687         <span class="keyword">struct </span>msghdr msg;
<a name="l01688"></a>01688         <span class="keywordtype">char</span> ccmsg[CMSG_SPACE(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))];
<a name="l01689"></a>01689         <span class="keyword">struct </span>cmsghdr *cmsg;
<a name="l01690"></a>01690         <span class="keyword">struct </span>iovec vec;  <span class="comment">/* stupidity: must send/receive at least one byte */</span>
<a name="l01691"></a>01691         <span class="keywordtype">char</span> *str = (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;x&quot;</span>;
<a name="l01692"></a>01692         <span class="keywordtype">int</span> rv;
<a name="l01693"></a>01693 
<a name="l01694"></a>01694         <span class="comment">//msg.msg_name = (struct sockaddr*)&amp;unix_socket_name;</span>
<a name="l01695"></a>01695         <span class="comment">//msg.msg_namelen = sizeof(unix_socket_name);</span>
<a name="l01696"></a>01696         msg.msg_name = 0;
<a name="l01697"></a>01697         msg.msg_namelen = 0;
<a name="l01698"></a>01698         vec.iov_base = str;
<a name="l01699"></a>01699         vec.iov_len = 1;
<a name="l01700"></a>01700         msg.msg_iov = &amp;vec;
<a name="l01701"></a>01701         msg.msg_iovlen = 1;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703         <span class="comment">/* old BSD implementations should use msg_accrights instead of</span>
<a name="l01704"></a>01704 <span class="comment">        * msg_control; the interface is different. */</span>
<a name="l01705"></a>01705         msg.msg_control = ccmsg;
<a name="l01706"></a>01706         msg.msg_controllen = <span class="keyword">sizeof</span>(ccmsg);
<a name="l01707"></a>01707         cmsg = CMSG_FIRSTHDR(&amp;msg);
<a name="l01708"></a>01708         cmsg-&gt;cmsg_level = SOL_SOCKET;
<a name="l01709"></a>01709         cmsg-&gt;cmsg_type = SCM_RIGHTS;
<a name="l01710"></a>01710         cmsg-&gt;cmsg_len = CMSG_LEN(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l01711"></a>01711         *(<span class="keywordtype">int</span>*)CMSG_DATA(cmsg) = fd;
<a name="l01712"></a>01712         msg.msg_controllen = cmsg-&gt;cmsg_len;
<a name="l01713"></a>01713 
<a name="l01714"></a>01714         msg.msg_flags = 0;
<a name="l01715"></a>01715         <span class="comment">//boost::mutex::scoped_lock lock(p_mutex);</span>
<a name="l01716"></a>01716         <span class="keywordflow">if</span>((rv= sendmsg(unix_socket_fd, &amp;msg, 0)) &lt; 0 )
<a name="l01717"></a>01717         {
<a name="l01718"></a>01718           perror(<span class="stringliteral">&quot;sendmsg()&quot;</span>);
<a name="l01719"></a>01719           exit(1);
<a name="l01720"></a>01720         }
<a name="l01721"></a>01721         close(fd);
<a name="l01722"></a>01722         <span class="keywordflow">return</span> rv;
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a>01725 <span class="keywordtype">int</span> receive_fd(<span class="keywordtype">int</span> fd)
<a name="l01726"></a>01726 {
<a name="l01727"></a>01727   <span class="keyword">struct </span>msghdr msg;
<a name="l01728"></a>01728   <span class="keyword">struct </span>iovec iov;
<a name="l01729"></a>01729   <span class="keywordtype">char</span> buf[1];
<a name="l01730"></a>01730   <span class="keywordtype">int</span> rv;
<a name="l01731"></a>01731   <span class="keywordtype">int</span> connfd = -1;
<a name="l01732"></a>01732   <span class="keywordtype">char</span> ccmsg[CMSG_SPACE(<span class="keyword">sizeof</span>(connfd))];
<a name="l01733"></a>01733   <span class="keyword">struct </span>cmsghdr *cmsg;
<a name="l01734"></a>01734 
<a name="l01735"></a>01735   iov.iov_base = buf;
<a name="l01736"></a>01736   iov.iov_len = 1;
<a name="l01737"></a>01737 
<a name="l01738"></a>01738   msg.msg_name = 0;
<a name="l01739"></a>01739   msg.msg_namelen = 0;
<a name="l01740"></a>01740   msg.msg_iov = &amp;iov;
<a name="l01741"></a>01741   msg.msg_iovlen = 1;
<a name="l01742"></a>01742   <span class="comment">/* old BSD implementations should use msg_accrights instead of</span>
<a name="l01743"></a>01743 <span class="comment">   * msg_control; the interface is different. */</span>
<a name="l01744"></a>01744   msg.msg_control = ccmsg;
<a name="l01745"></a>01745   msg.msg_controllen = <span class="keyword">sizeof</span>(ccmsg); <span class="comment">/* ? seems to work... */</span>
<a name="l01746"></a>01746 
<a name="l01747"></a>01747   rv = recvmsg(fd, &amp;msg, 0);
<a name="l01748"></a>01748   <span class="keywordflow">if</span> (rv == -1) {
<a name="l01749"></a>01749     perror(<span class="stringliteral">&quot;recvmsg&quot;</span>);
<a name="l01750"></a>01750     <span class="keywordflow">return</span> -1;
<a name="l01751"></a>01751   }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753   cmsg = CMSG_FIRSTHDR(&amp;msg);
<a name="l01754"></a>01754   <span class="keywordflow">if</span> (!cmsg-&gt;cmsg_type == SCM_RIGHTS) {
<a name="l01755"></a>01755     fprintf(stderr, <span class="stringliteral">&quot;got control message of unknown type %d\n&quot;</span>,
<a name="l01756"></a>01756             cmsg-&gt;cmsg_type);
<a name="l01757"></a>01757     <span class="keywordflow">return</span> -1;
<a name="l01758"></a>01758   }
<a name="l01759"></a>01759   <span class="keywordflow">return</span> *(<span class="keywordtype">int</span>*)CMSG_DATA(cmsg);
<a name="l01760"></a>01760 }
<a name="l01761"></a>01761 
<a name="l01762"></a>01762 <span class="keywordtype">void</span> signalSIGSEGV(<span class="keywordtype">int</span> dummy)
<a name="l01763"></a>01763 {
<a name="l01764"></a>01764         signal(SIGSEGV,signalSIGSEGV);
<a name="l01765"></a>01765         <span class="keywordtype">string</span> filename;
<a name="l01766"></a>01766         stringstream ss;
<a name="l01767"></a>01767         ss &lt;&lt; servd;
<a name="l01768"></a>01768         ss &lt;&lt; getpid();
<a name="l01769"></a>01769         ss &gt;&gt; filename;
<a name="l01770"></a>01770         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01771"></a>01771         <span class="keyword">remove</span>(filename.c_str());
<a name="l01772"></a>01772         <span class="keywordtype">void</span> * array[25];
<a name="l01773"></a>01773         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01774"></a>01774         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01775"></a>01775         <span class="keywordtype">string</span> tempo;
<a name="l01776"></a>01776         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01777"></a>01777         {
<a name="l01778"></a>01778                 tempo = symbols[i];
<a name="l01779"></a>01779                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01780"></a>01780         }
<a name="l01781"></a>01781         free(symbols);
<a name="l01782"></a>01782         cout &lt;&lt; <span class="stringliteral">&quot;Segmentation fault occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01783"></a>01783         abort();
<a name="l01784"></a>01784 }
<a name="l01785"></a>01785 <span class="keywordtype">void</span> signalSIGCHLD(<span class="keywordtype">int</span> dummy)
<a name="l01786"></a>01786 {
<a name="l01787"></a>01787         signal(SIGCHLD,signalSIGCHLD);
<a name="l01788"></a>01788         <span class="keywordtype">string</span> filename;
<a name="l01789"></a>01789         stringstream ss;
<a name="l01790"></a>01790         ss &lt;&lt; servd;
<a name="l01791"></a>01791         ss &lt;&lt; getpid();
<a name="l01792"></a>01792         ss &gt;&gt; filename;
<a name="l01793"></a>01793         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01794"></a>01794         <span class="keyword">remove</span>(filename.c_str());
<a name="l01795"></a>01795         <span class="keywordtype">void</span> * array[25];
<a name="l01796"></a>01796         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01797"></a>01797         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01798"></a>01798         <span class="keywordtype">string</span> tempo;
<a name="l01799"></a>01799         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01800"></a>01800         {
<a name="l01801"></a>01801                 tempo = symbols[i];
<a name="l01802"></a>01802                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01803"></a>01803         }
<a name="l01804"></a>01804         free(symbols);
<a name="l01805"></a>01805         cout &lt;&lt; <span class="stringliteral">&quot;Child process got killed &quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01806"></a>01806         abort();
<a name="l01807"></a>01807 }
<a name="l01808"></a>01808 <span class="keywordtype">void</span> signalSIGABRT(<span class="keywordtype">int</span> dummy)
<a name="l01809"></a>01809 {
<a name="l01810"></a>01810         signal(SIGABRT,signalSIGABRT);
<a name="l01811"></a>01811         <span class="keywordtype">string</span> filename;
<a name="l01812"></a>01812         stringstream ss;
<a name="l01813"></a>01813         ss &lt;&lt; servd;
<a name="l01814"></a>01814         ss &lt;&lt; getpid();
<a name="l01815"></a>01815         ss &gt;&gt; filename;
<a name="l01816"></a>01816         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01817"></a>01817         <span class="keyword">remove</span>(filename.c_str());
<a name="l01818"></a>01818         <span class="keywordtype">void</span> * array[25];
<a name="l01819"></a>01819         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01820"></a>01820         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01821"></a>01821         <span class="keywordtype">string</span> tempo;
<a name="l01822"></a>01822         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01823"></a>01823         {
<a name="l01824"></a>01824                 tempo = symbols[i];
<a name="l01825"></a>01825                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01826"></a>01826         }
<a name="l01827"></a>01827         free(symbols);
<a name="l01828"></a>01828         cout &lt;&lt; <span class="stringliteral">&quot;Abort signal occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01829"></a>01829         abort();
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 <span class="keywordtype">void</span> signalSIGTERM(<span class="keywordtype">int</span> dummy)
<a name="l01832"></a>01832 {
<a name="l01833"></a>01833         signal(SIGKILL,signalSIGTERM);
<a name="l01834"></a>01834         <span class="keywordtype">string</span> filename;
<a name="l01835"></a>01835         stringstream ss;
<a name="l01836"></a>01836         ss &lt;&lt; servd;
<a name="l01837"></a>01837         ss &lt;&lt; getpid();
<a name="l01838"></a>01838         ss &gt;&gt; filename;
<a name="l01839"></a>01839         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01840"></a>01840         <span class="keyword">remove</span>(filename.c_str());
<a name="l01841"></a>01841         <span class="keywordtype">void</span> * array[25];
<a name="l01842"></a>01842         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01843"></a>01843         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01844"></a>01844         <span class="keywordtype">string</span> tempo;
<a name="l01845"></a>01845         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01846"></a>01846         {
<a name="l01847"></a>01847                 tempo = symbols[i];
<a name="l01848"></a>01848                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01849"></a>01849         }
<a name="l01850"></a>01850         free(symbols);
<a name="l01851"></a>01851         cout &lt;&lt; <span class="stringliteral">&quot;Termination signal occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01852"></a>01852         abort();
<a name="l01853"></a>01853 }
<a name="l01854"></a>01854 
<a name="l01855"></a>01855 <span class="keywordtype">void</span> signalSIGKILL(<span class="keywordtype">int</span> dummy)
<a name="l01856"></a>01856 {
<a name="l01857"></a>01857         signal(SIGKILL,signalSIGKILL);
<a name="l01858"></a>01858         <span class="keywordtype">string</span> filename;
<a name="l01859"></a>01859         stringstream ss;
<a name="l01860"></a>01860         ss &lt;&lt; servd;
<a name="l01861"></a>01861         ss &lt;&lt; getpid();
<a name="l01862"></a>01862         ss &gt;&gt; filename;
<a name="l01863"></a>01863         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01864"></a>01864         <span class="keyword">remove</span>(filename.c_str());
<a name="l01865"></a>01865         <span class="keywordtype">void</span> * array[25];
<a name="l01866"></a>01866         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01867"></a>01867         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01868"></a>01868         <span class="keywordtype">string</span> tempo;
<a name="l01869"></a>01869         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01870"></a>01870         {
<a name="l01871"></a>01871                 tempo = symbols[i];
<a name="l01872"></a>01872                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01873"></a>01873         }
<a name="l01874"></a>01874         free(symbols);
<a name="l01875"></a>01875         cout &lt;&lt; <span class="stringliteral">&quot;Kill signal occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01876"></a>01876         abort();
<a name="l01877"></a>01877 }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 <span class="keywordtype">void</span> signalSIGINT(<span class="keywordtype">int</span> dummy)
<a name="l01880"></a>01880 {
<a name="l01881"></a>01881         signal(SIGINT,signalSIGINT);
<a name="l01882"></a>01882         <span class="keywordtype">string</span> filename;
<a name="l01883"></a>01883         stringstream ss;
<a name="l01884"></a>01884         ss &lt;&lt; servd;
<a name="l01885"></a>01885         ss &lt;&lt; getpid();
<a name="l01886"></a>01886         ss &gt;&gt; filename;
<a name="l01887"></a>01887         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01888"></a>01888         <span class="keyword">remove</span>(filename.c_str());
<a name="l01889"></a>01889         <span class="keywordtype">void</span> * array[25];
<a name="l01890"></a>01890         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01891"></a>01891         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01892"></a>01892         <span class="keywordtype">string</span> tempo;
<a name="l01893"></a>01893         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01894"></a>01894         {
<a name="l01895"></a>01895                 tempo = symbols[i];
<a name="l01896"></a>01896                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01897"></a>01897         }
<a name="l01898"></a>01898         free(symbols);
<a name="l01899"></a>01899         cout &lt;&lt; <span class="stringliteral">&quot;Interrupt signal occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01900"></a>01900         abort();
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903 <span class="keywordtype">void</span> signalSIGFPE(<span class="keywordtype">int</span> dummy)
<a name="l01904"></a>01904 {
<a name="l01905"></a>01905         signal(SIGFPE,signalSIGFPE);
<a name="l01906"></a>01906         <span class="keywordtype">string</span> filename;
<a name="l01907"></a>01907         stringstream ss;
<a name="l01908"></a>01908         ss &lt;&lt; servd;
<a name="l01909"></a>01909         ss &lt;&lt; getpid();
<a name="l01910"></a>01910         ss &gt;&gt; filename;
<a name="l01911"></a>01911         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01912"></a>01912         <span class="keyword">remove</span>(filename.c_str());
<a name="l01913"></a>01913         <span class="keywordtype">void</span> * array[25];
<a name="l01914"></a>01914         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01915"></a>01915         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01916"></a>01916         <span class="keywordtype">string</span> tempo;
<a name="l01917"></a>01917         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01918"></a>01918         {
<a name="l01919"></a>01919                 tempo = symbols[i];
<a name="l01920"></a>01920                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01921"></a>01921         }
<a name="l01922"></a>01922         free(symbols);
<a name="l01923"></a>01923         cout &lt;&lt; <span class="stringliteral">&quot;Floating point Exception occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01924"></a>01924         abort();
<a name="l01925"></a>01925 }
<a name="l01926"></a>01926 <span class="keywordtype">void</span> signalSIGPIPE(<span class="keywordtype">int</span> dummy)
<a name="l01927"></a>01927 {
<a name="l01928"></a>01928         signal(SIGPIPE,signalSIGPIPE);
<a name="l01929"></a>01929         <span class="comment">/*string filename;</span>
<a name="l01930"></a>01930 <span class="comment">        stringstream ss;</span>
<a name="l01931"></a>01931 <span class="comment">        ss &lt;&lt; servd;</span>
<a name="l01932"></a>01932 <span class="comment">        ss &lt;&lt; getpid();</span>
<a name="l01933"></a>01933 <span class="comment">        ss &gt;&gt; filename;</span>
<a name="l01934"></a>01934 <span class="comment">        filename.append(&quot;.cntrl&quot;);</span>
<a name="l01935"></a>01935 <span class="comment">        remove(filename.c_str());*/</span>
<a name="l01936"></a>01936         <span class="keywordtype">void</span> * array[25];
<a name="l01937"></a>01937         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01938"></a>01938         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01939"></a>01939         <span class="keywordtype">string</span> tempo;
<a name="l01940"></a>01940         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01941"></a>01941         {
<a name="l01942"></a>01942                 tempo = symbols[i];
<a name="l01943"></a>01943                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01944"></a>01944         }
<a name="l01945"></a>01945         free(symbols);
<a name="l01946"></a>01946         cout &lt;&lt; <span class="stringliteral">&quot;Broken pipe ignore it&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01947"></a>01947         <span class="comment">//abort();</span>
<a name="l01948"></a>01948 }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950 <span class="keywordtype">void</span> signalSIGILL(<span class="keywordtype">int</span> dummy)
<a name="l01951"></a>01951 {
<a name="l01952"></a>01952         signal(SIGILL,signalSIGILL);
<a name="l01953"></a>01953         <span class="keywordtype">string</span> filename;
<a name="l01954"></a>01954         stringstream ss;
<a name="l01955"></a>01955         ss &lt;&lt; servd;
<a name="l01956"></a>01956         ss &lt;&lt; getpid();
<a name="l01957"></a>01957         ss &gt;&gt; filename;
<a name="l01958"></a>01958         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l01959"></a>01959         <span class="keyword">remove</span>(filename.c_str());
<a name="l01960"></a>01960         <span class="keywordtype">void</span> * array[25];
<a name="l01961"></a>01961         <span class="keywordtype">int</span> nSize = backtrace(array, 25);
<a name="l01962"></a>01962         <span class="keywordtype">char</span> ** symbols = backtrace_symbols(array, nSize);
<a name="l01963"></a>01963         <span class="keywordtype">string</span> tempo;
<a name="l01964"></a>01964         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; nSize; i++)
<a name="l01965"></a>01965         {
<a name="l01966"></a>01966                 tempo = symbols[i];
<a name="l01967"></a>01967                 tempo += <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01968"></a>01968         }
<a name="l01969"></a>01969         free(symbols);
<a name="l01970"></a>01970         cout &lt;&lt; <span class="stringliteral">&quot;Floating point Exception occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01971"></a>01971         abort();
<a name="l01972"></a>01972 }
<a name="l01973"></a>01973 
<a name="l01974"></a>01974 <span class="keywordtype">void</span> cleanUpRoutine(<span class="keywordtype">string</span> tempo)
<a name="l01975"></a>01975 {
<a name="l01976"></a>01976         cout &lt;&lt; <span class="stringliteral">&quot;Floating point Exception occurred for process&quot;</span> &lt;&lt; getpid() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span> &lt;&lt; tempo &lt;&lt; flush;
<a name="l01977"></a>01977         abort();
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 <span class="keywordtype">void</span> service(<span class="keywordtype">int</span> fd,<span class="keywordtype">string</span> serverRootDirectory,map&lt;string,string&gt; *params)
<a name="l01980"></a>01980 
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982         <a class="code" href="classServiceTask.html">ServiceTask</a> *task = <span class="keyword">new</span> <a class="code" href="classServiceTask.html">ServiceTask</a>(fd,serverRootDirectory,params);
<a name="l01983"></a>01983         task-&gt;run();
<a name="l01984"></a>01984         <span class="keyword">delete</span> task;
<a name="l01985"></a>01985         <span class="comment">//cout &lt;&lt; &quot;\nDestroyed task&quot; &lt;&lt; flush;</span>
<a name="l01986"></a>01986 }
<a name="l01987"></a>01987 
<a name="l01988"></a>01988 pid_t createChildProcess(<span class="keywordtype">string</span> serverRootDirectory,<span class="keywordtype">int</span> sp[],<span class="keywordtype">int</span> sockfd)
<a name="l01989"></a>01989 {
<a name="l01990"></a>01990         pid_t pid;
<a name="l01991"></a>01991         <span class="keyword">struct </span>epoll_event ev;
<a name="l01992"></a>01992         <span class="keywordflow">if</span> (socketpair(AF_UNIX, SOCK_DGRAM, 0, sp) == -1)
<a name="l01993"></a>01993         {
<a name="l01994"></a>01994                 perror(<span class="stringliteral">&quot;socketpair&quot;</span>);
<a name="l01995"></a>01995                 exit(1);
<a name="l01996"></a>01996         }
<a name="l01997"></a>01997         <span class="keywordflow">if</span>((pid=fork())==0)
<a name="l01998"></a>01998         {
<a name="l01999"></a>01999                 dlib = dlopen(<span class="stringliteral">&quot;libinter.so&quot;</span>, RTLD_NOW|RTLD_GLOBAL);
<a name="l02000"></a>02000                 cout &lt;&lt; endl &lt;&lt;dlib &lt;&lt; endl;
<a name="l02001"></a>02001                 <span class="keywordflow">if</span>(dlib==NULL)
<a name="l02002"></a>02002                 {
<a name="l02003"></a>02003                         cout &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l02004"></a>02004                         Logger::info(<span class="stringliteral">&quot;Could not load Library&quot;</span>);
<a name="l02005"></a>02005                 }
<a name="l02006"></a>02006                 <span class="keywordflow">else</span>
<a name="l02007"></a>02007                         Logger::info(<span class="stringliteral">&quot;Library loaded successfully&quot;</span>);
<a name="l02008"></a>02008                 <span class="keywordflow">if</span>(isSSLEnabled)
<a name="l02009"></a>02009                 {
<a name="l02010"></a>02010                         <span class="comment">/*HTTPS related*/</span>
<a name="l02011"></a>02011                         <span class="comment">//client_auth=CLIENT_AUTH_REQUIRE;</span>
<a name="l02012"></a>02012                         <span class="comment">/* Build our SSL context*/</span>
<a name="l02013"></a>02013                         ctx=initialize_ctx((<span class="keywordtype">char</span>*)key_file.c_str(),(<span class="keywordtype">char</span>*)sec_password.c_str());
<a name="l02014"></a>02014                         load_dh_params(ctx,(<span class="keywordtype">char</span>*)dh_file.c_str());
<a name="l02015"></a>02015 
<a name="l02016"></a>02016                         SSL_CTX_set_session_id_context(ctx,
<a name="l02017"></a>02017                           (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;s_server_session_id_context,
<a name="l02018"></a>02018                           <span class="keyword">sizeof</span> s_server_session_id_context);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020                         <span class="comment">/* Set our cipher list */</span>
<a name="l02021"></a>02021                         <span class="keywordflow">if</span>(ciphers){
<a name="l02022"></a>02022                           SSL_CTX_set_cipher_list(ctx,ciphers);
<a name="l02023"></a>02023                         }
<a name="l02024"></a>02024                         <span class="keywordflow">if</span>(client_auth==2)
<a name="l02025"></a>02025                                 SSL_CTX_set_verify(ctx,SSL_VERIFY_PEER|SSL_VERIFY_FAIL_IF_NO_PEER_CERT,0);
<a name="l02026"></a>02026                         <span class="keywordflow">else</span>
<a name="l02027"></a>02027                                 SSL_CTX_set_verify(ctx,SSL_VERIFY_PEER,0);
<a name="l02028"></a>02028                 }
<a name="l02029"></a>02029                 servd = serverRootDirectory;
<a name="l02030"></a>02030                 <span class="keywordtype">string</span> filename;
<a name="l02031"></a>02031                 stringstream ss;
<a name="l02032"></a>02032                 ss &lt;&lt; serverRootDirectory;
<a name="l02033"></a>02033                 ss &lt;&lt; getpid();
<a name="l02034"></a>02034                 ss &gt;&gt; filename;
<a name="l02035"></a>02035                 filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l02036"></a>02036                 cout &lt;&lt; <span class="stringliteral">&quot;generated file &quot;</span> &lt;&lt; filename &lt;&lt; flush;
<a name="l02037"></a>02037                 ofstream cntrlfile;
<a name="l02038"></a>02038                 cntrlfile.open(filename.c_str());
<a name="l02039"></a>02039                 cntrlfile &lt;&lt; <span class="stringliteral">&quot;Process Running&quot;</span> &lt;&lt; flush;
<a name="l02040"></a>02040                 cntrlfile.close();
<a name="l02041"></a>02041                 <span class="keyword">struct </span>msghdr msg;
<a name="l02042"></a>02042                 <span class="keyword">struct </span>iovec iov;
<a name="l02043"></a>02043                 <span class="keywordtype">char</span> buf[1];
<a name="l02044"></a>02044                 <span class="keywordtype">int</span> rv;
<a name="l02045"></a>02045                 <span class="keywordtype">int</span> connfd = -1;
<a name="l02046"></a>02046                 <span class="keywordtype">char</span> ccmsg[CMSG_SPACE(<span class="keyword">sizeof</span>(connfd))];
<a name="l02047"></a>02047                 <span class="keyword">struct </span>cmsghdr *cmsg;
<a name="l02048"></a>02048 
<a name="l02049"></a>02049                 iov.iov_base = buf;
<a name="l02050"></a>02050                 iov.iov_len = 1;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052                 msg.msg_name = 0;
<a name="l02053"></a>02053                 msg.msg_namelen = 0;
<a name="l02054"></a>02054                 msg.msg_iov = &amp;iov;
<a name="l02055"></a>02055                 msg.msg_iovlen = 1;
<a name="l02056"></a>02056                 <span class="comment">/* old BSD implementations should use msg_accrights instead of</span>
<a name="l02057"></a>02057 <span class="comment">                * msg_control; the interface is different. */</span>
<a name="l02058"></a>02058                 msg.msg_control = ccmsg;
<a name="l02059"></a>02059                 msg.msg_controllen = <span class="keyword">sizeof</span>(ccmsg); <span class="comment">/* ? seems to work... */</span>
<a name="l02060"></a>02060                 close(sockfd);
<a name="l02061"></a>02061                 <span class="keyword">struct </span>epoll_event events[1];
<a name="l02062"></a>02062                 <span class="comment">//printf(&quot;parent side--%d child side---%d child pid--%ld\n&quot;,sp[j][0],sp[j][1],(long)getpid());</span>
<a name="l02063"></a>02063                 <span class="keywordtype">int</span> epoll_handle = epoll_create(1);
<a name="l02064"></a>02064                 ev.events = EPOLLIN | EPOLLPRI;
<a name="l02065"></a>02065                 ev.data.fd = sp[1];
<a name="l02066"></a>02066                 <span class="keywordflow">if</span> (epoll_ctl(epoll_handle, EPOLL_CTL_ADD, sp[1], &amp;ev) &lt; 0)
<a name="l02067"></a>02067                 {
<a name="l02068"></a>02068                         fprintf(stderr, <span class="stringliteral">&quot;epoll set insertion error: fd=%d\n&quot;</span>, sp[1]);
<a name="l02069"></a>02069                         <span class="keywordflow">return</span> -1;
<a name="l02070"></a>02070                 }
<a name="l02071"></a>02071                 <a class="code" href="classThreadPool.html">ThreadPool</a> pool;
<a name="l02072"></a>02072                 <span class="keywordflow">if</span>(!isThreadprq)
<a name="l02073"></a>02073                 {
<a name="l02074"></a>02074                         pool.init(thrdpsiz,30,<span class="keyword">true</span>);
<a name="l02075"></a>02075                 }
<a name="l02076"></a>02076                 <a class="code" href="classPropFileReader.html">PropFileReader</a> pread;
<a name="l02077"></a>02077                 propMap params = pread.getProperties(serverRootDirectory+<span class="stringliteral">&quot;resources/security.prop&quot;</span>);
<a name="l02078"></a>02078 
<a name="l02079"></a>02079                 cout &lt;&lt; params.size() &lt;&lt;endl;
<a name="l02080"></a>02080                 <span class="keywordflow">while</span>(1)
<a name="l02081"></a>02081                 {
<a name="l02082"></a>02082                         <span class="keywordtype">int</span> nfds = epoll_wait(epoll_handle, events, 1,-1);
<a name="l02083"></a>02083                         <span class="keywordflow">if</span> (nfds == -1)
<a name="l02084"></a>02084                         {
<a name="l02085"></a>02085                                 perror(<span class="stringliteral">&quot;epoll_wait child process&quot;</span>);
<a name="l02086"></a>02086                                 cout &lt;&lt; <span class="stringliteral">&quot;\n----------epoll_wait child process----&quot;</span> &lt;&lt; flush;
<a name="l02087"></a>02087                                 <span class="comment">//break;</span>
<a name="l02088"></a>02088                         }
<a name="l02089"></a>02089                         <span class="keywordflow">else</span>
<a name="l02090"></a>02090                         {
<a name="l02091"></a>02091                                 <span class="comment">//int fd = receive_fd(sp[j][1]);</span>
<a name="l02092"></a>02092                                 rv = recvmsg(sp[1], &amp;msg, 0);
<a name="l02093"></a>02093                                 <span class="keywordflow">if</span> (rv == -1)
<a name="l02094"></a>02094                                 {
<a name="l02095"></a>02095                                         perror(<span class="stringliteral">&quot;recvmsg&quot;</span>);
<a name="l02096"></a>02096                                         cout &lt;&lt; <span class="stringliteral">&quot;\n----------error occurred----&quot;</span> &lt;&lt; flush;
<a name="l02097"></a>02097                                         exit(1);
<a name="l02098"></a>02098                                 }
<a name="l02099"></a>02099 
<a name="l02100"></a>02100                                 cmsg = CMSG_FIRSTHDR(&amp;msg);
<a name="l02101"></a>02101                                 <span class="keywordflow">if</span> (!cmsg-&gt;cmsg_type == SCM_RIGHTS)
<a name="l02102"></a>02102                                 {
<a name="l02103"></a>02103                                         fprintf(stderr, <span class="stringliteral">&quot;got control message of unknown type %d\n&quot;</span>,cmsg-&gt;cmsg_type);
<a name="l02104"></a>02104                                         exit(1);
<a name="l02105"></a>02105                                 }
<a name="l02106"></a>02106                                 <span class="keywordtype">int</span> fd = *(<span class="keywordtype">int</span>*)CMSG_DATA(cmsg);
<a name="l02107"></a>02107                                 fcntl(fd, F_SETFL,O_SYNC);
<a name="l02108"></a>02108 
<a name="l02109"></a>02109                                 <span class="keywordtype">char</span> buf[10];
<a name="l02110"></a>02110                                 <span class="keywordtype">int</span> err;
<a name="l02111"></a>02111                                 <span class="keywordflow">if</span>((err=recv(fd,buf,10,MSG_PEEK))==0)
<a name="l02112"></a>02112                                 {
<a name="l02113"></a>02113                                         close(fd);
<a name="l02114"></a>02114                                         cout &lt;&lt; <span class="stringliteral">&quot;\nsocket conn closed before being serviced&quot;</span> &lt;&lt; flush;
<a name="l02115"></a>02115                                         <span class="keywordflow">continue</span>;
<a name="l02116"></a>02116                                 }
<a name="l02117"></a>02117 
<a name="l02118"></a>02118                                 <span class="keywordflow">if</span>(isThreadprq)
<a name="l02119"></a>02119                                         boost::thread m_thread(boost::bind(&amp;service,fd,serverRootDirectory,&amp;params));
<a name="l02120"></a>02120                                 <span class="keywordflow">else</span>
<a name="l02121"></a>02121                                 {
<a name="l02122"></a>02122                                         <a class="code" href="classServiceTask.html">ServiceTask</a> *task = <span class="keyword">new</span> <a class="code" href="classServiceTask.html">ServiceTask</a>(fd,serverRootDirectory,&amp;params);
<a name="l02123"></a>02123                                         pool.execute(*task);
<a name="l02124"></a>02124                                 }
<a name="l02125"></a>02125                         }
<a name="l02126"></a>02126                 }
<a name="l02127"></a>02127         }
<a name="l02128"></a>02128         <span class="keywordflow">return</span> pid;
<a name="l02129"></a>02129 }
<a name="l02130"></a>02130 
<a name="l02131"></a>02131 pid_t createChildMonitProcess(<span class="keywordtype">int</span> sp[])
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133         pid_t pid;
<a name="l02134"></a>02134         <span class="keywordflow">if</span> (socketpair(AF_UNIX, SOCK_DGRAM, 0, sp) == -1)
<a name="l02135"></a>02135         {
<a name="l02136"></a>02136                 perror(<span class="stringliteral">&quot;socketpair&quot;</span>);
<a name="l02137"></a>02137                 exit(1);
<a name="l02138"></a>02138         }
<a name="l02139"></a>02139         <span class="keywordflow">if</span>((pid=fork())==0)
<a name="l02140"></a>02140         {
<a name="l02141"></a>02141                 map&lt;string,bool&gt; stat;
<a name="l02142"></a>02142                 <span class="keywordflow">while</span>(1)
<a name="l02143"></a>02143                 {
<a name="l02144"></a>02144                         <span class="keywordtype">char</span> buf[10];
<a name="l02145"></a>02145                         <span class="keywordflow">if</span>(read(sp[1], buf, <span class="keyword">sizeof</span> buf) &lt; 0)
<a name="l02146"></a>02146                         {
<a name="l02147"></a>02147                                 <span class="keywordtype">string</span> temp = buf;
<a name="l02148"></a>02148                                 strVec tempv;
<a name="l02149"></a>02149                                 boost::iter_split(tempv, temp, boost::first_finder(<span class="stringliteral">&quot;:&quot;</span>));
<a name="l02150"></a>02150                                 <span class="keywordflow">if</span>(tempv.size()==2)
<a name="l02151"></a>02151                                 {
<a name="l02152"></a>02152                                         <span class="keywordflow">if</span>(tempv.at(0)==<span class="stringliteral">&quot;R&quot;</span>)
<a name="l02153"></a>02153                                         {
<a name="l02154"></a>02154                                                 <span class="keywordtype">string</span> h = <span class="stringliteral">&quot;0&quot;</span>;
<a name="l02155"></a>02155                                                 <span class="keywordflow">if</span>(stat[tempv.at(1)])
<a name="l02156"></a>02156                                                         h = <span class="stringliteral">&quot;1&quot;</span>;
<a name="l02157"></a>02157                                                 write(sp[0], h.c_str() , <span class="keyword">sizeof</span>(h));
<a name="l02158"></a>02158                                         }
<a name="l02159"></a>02159                                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(tempv.at(0)==<span class="stringliteral">&quot;W&quot;</span>)
<a name="l02160"></a>02160                                         {
<a name="l02161"></a>02161                                                 stat[tempv.at(1)] = <span class="keyword">false</span>;
<a name="l02162"></a>02162                                         }
<a name="l02163"></a>02163                                 }
<a name="l02164"></a>02164                         }
<a name="l02165"></a>02165                 }
<a name="l02166"></a>02166         }
<a name="l02167"></a>02167         <span class="keywordflow">return</span> pid;
<a name="l02168"></a>02168 }
<a name="l02169"></a>02169 
<a name="l02170"></a>02170 
<a name="l02171"></a>02171 strVec temporaray(strVec webdirs,strVec webdirs1,<span class="keywordtype">string</span> incpath,<span class="keywordtype">string</span> rtdcfpath,<span class="keywordtype">string</span> pubpath,<span class="keywordtype">string</span> respath)
<a name="l02172"></a>02172 {
<a name="l02173"></a>02173         strVec all,dcps,afcd,appf,wspath,compnts,cmpnames;
<a name="l02174"></a>02174         <span class="keywordtype">string</span> includeRef;
<a name="l02175"></a>02175         <a class="code" href="classTemplateEngine.html">TemplateEngine</a> templ;
<a name="l02176"></a>02176         Context cntxt;
<a name="l02177"></a>02177         <span class="keywordtype">string</span> libs,ilibs,isrcs,iobjs,ideps;
<a name="l02178"></a>02178         <a class="code" href="classReflection.html">Reflection</a> ref;
<a name="l02179"></a>02179         vector&lt;bool&gt; stat;
<a name="l02180"></a>02180         strVec vecvp,pathvec;
<a name="l02181"></a>02181         propMap srp;
<a name="l02182"></a>02182         <a class="code" href="classPropFileReader.html">PropFileReader</a> pread;
<a name="l02183"></a>02183         <a class="code" href="classXmlParser.html">XmlParser</a> parser(<span class="stringliteral">&quot;Parser&quot;</span>);
<a name="l02184"></a>02184         <a class="code" href="classComponentGen.html">ComponentGen</a> gen;
<a name="l02185"></a>02185         <span class="keywordflow">if</span>(isSSLEnabled)
<a name="l02186"></a>02186         {
<a name="l02187"></a>02187                 propMap sslsec = pread.getProperties(respath+<span class="stringliteral">&quot;/security.prop&quot;</span>);
<a name="l02188"></a>02188                 <span class="keywordflow">if</span>(sslsec.size()&gt;0)
<a name="l02189"></a>02189                 {
<a name="l02190"></a>02190                         key_file = sslsec[<span class="stringliteral">&quot;KEYFILE&quot;</span>];
<a name="l02191"></a>02191                         dh_file = sslsec[<span class="stringliteral">&quot;DHFILE&quot;</span>];
<a name="l02192"></a>02192                         ca_list = sslsec[<span class="stringliteral">&quot;CA_LIST&quot;</span>];
<a name="l02193"></a>02193                         rand_file = sslsec[<span class="stringliteral">&quot;RANDOM&quot;</span>];
<a name="l02194"></a>02194                         sec_password = sslsec[<span class="stringliteral">&quot;PASSWORD&quot;</span>];
<a name="l02195"></a>02195                         <span class="keywordtype">string</span> tempcl = sslsec[<span class="stringliteral">&quot;CLIENT_SEC_LEVEL&quot;</span>];
<a name="l02196"></a>02196                         srv_auth_prvd = sslsec[<span class="stringliteral">&quot;SRV_AUTH_PRVD&quot;</span>];
<a name="l02197"></a>02197                         srv_auth_mode = sslsec[<span class="stringliteral">&quot;SRV_AUTH_MODE&quot;</span>];
<a name="l02198"></a>02198                         srv_auth_file = sslsec[<span class="stringliteral">&quot;SRV_AUTH_FILE&quot;</span>];
<a name="l02199"></a>02199                         <span class="keywordflow">if</span>(tempcl!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02200"></a>02200                         {
<a name="l02201"></a>02201                                 <span class="keywordflow">try</span>
<a name="l02202"></a>02202                                 {
<a name="l02203"></a>02203                                         client_auth = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(tempcl);
<a name="l02204"></a>02204                                 }
<a name="l02205"></a>02205                                 <span class="keywordflow">catch</span>(...)
<a name="l02206"></a>02206                                 {
<a name="l02207"></a>02207                                         cout &lt;&lt; <span class="stringliteral">&quot;\nInvalid client auth level defined&quot;</span> &lt;&lt; flush;
<a name="l02208"></a>02208                                         client_auth = 1;
<a name="l02209"></a>02209                                 }
<a name="l02210"></a>02210                         }
<a name="l02211"></a>02211                 }
<a name="l02212"></a>02212         }
<a name="l02213"></a>02213         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var=0;var&lt;webdirs.size();var++)
<a name="l02214"></a>02214         {
<a name="l02215"></a>02215                 <span class="comment">//cout &lt;&lt;  webdirs.at(0) &lt;&lt; flush;</span>
<a name="l02216"></a>02216                 <span class="keywordtype">string</span> defpath = webdirs.at(var);
<a name="l02217"></a>02217                 <span class="keywordtype">string</span> dcppath = defpath + <span class="stringliteral">&quot;dcp/&quot;</span>;
<a name="l02218"></a>02218                 <span class="keywordtype">string</span> cmppath = defpath + <span class="stringliteral">&quot;components/&quot;</span>;
<a name="l02219"></a>02219                 <span class="keywordtype">string</span> usrincludes = defpath + <span class="stringliteral">&quot;include/&quot;</span>;
<a name="l02220"></a>02220                 <span class="comment">//propMap srp = pread.getProperties(defpath+&quot;config/app.prop&quot;);</span>
<a name="l02221"></a>02221 
<a name="l02222"></a>02222                 <span class="keywordtype">string</span> name = webdirs1.at(var);
<a name="l02223"></a>02223                 boost::replace_all(name,<span class="stringliteral">&quot;/&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l02224"></a>02224                 cntMap[name] = <span class="stringliteral">&quot;true&quot;</span>;
<a name="l02225"></a>02225                 listi(dcppath,<span class="stringliteral">&quot;.dcp&quot;</span>,<span class="keyword">true</span>,dcps);
<a name="l02226"></a>02226                 listi(cmppath,<span class="stringliteral">&quot;.cmp&quot;</span>,<span class="keyword">true</span>,compnts);
<a name="l02227"></a>02227                 all.push_back(usrincludes);
<a name="l02228"></a>02228                 appf.push_back(defpath+<span class="stringliteral">&quot;app.xml&quot;</span>);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230                 libs += (<span class="stringliteral">&quot;-l&quot;</span>+ name+<span class="stringliteral">&quot; &quot;</span>);
<a name="l02231"></a>02231                 ilibs += (<span class="stringliteral">&quot;-I&quot;</span> + usrincludes+<span class="stringliteral">&quot; &quot;</span>);
<a name="l02232"></a>02232                 wspath.push_back(name);
<a name="l02233"></a>02233 
<a name="l02234"></a>02234                 <a class="code" href="classElement.html">Element</a> root = parser.getDocument(defpath+<span class="stringliteral">&quot;config/application.xml&quot;</span>).getRootElement();
<a name="l02235"></a>02235                 <span class="keywordflow">if</span>(root.getTagName()==<span class="stringliteral">&quot;app&quot;</span> &amp;&amp; root.getChildElements().size()&gt;0)
<a name="l02236"></a>02236                 {
<a name="l02237"></a>02237                         ElementList eles = root.getChildElements();
<a name="l02238"></a>02238                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> apps = 0; apps &lt; eles.size(); apps++)
<a name="l02239"></a>02239                         {
<a name="l02240"></a>02240                                 <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;controllers&quot;</span>)
<a name="l02241"></a>02241                                 {
<a name="l02242"></a>02242                                         ElementList cntrls = eles.at(apps).getChildElements();
<a name="l02243"></a>02243                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn = 0; cntn &lt; cntrls.size(); cntn++)
<a name="l02244"></a>02244                                         {
<a name="l02245"></a>02245                                                 <span class="keywordflow">if</span>(cntrls.at(cntn).getTagName()==<span class="stringliteral">&quot;controller&quot;</span>)
<a name="l02246"></a>02246                                                 {
<a name="l02247"></a>02247                                                         <span class="keywordtype">string</span> url = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;url&quot;</span>);
<a name="l02248"></a>02248                                                         <span class="keywordtype">string</span> clas = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02249"></a>02249                                                         <span class="keywordflow">if</span>(url!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; clas!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02250"></a>02250                                                         {
<a name="l02251"></a>02251                                                                 <span class="keywordflow">if</span>(cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;url&quot;</span>).find(<span class="stringliteral">&quot;*&quot;</span>)!=string::npos)
<a name="l02252"></a>02252                                                                 {
<a name="l02253"></a>02253                                                                         <span class="keywordflow">if</span>(url==<span class="stringliteral">&quot;*.*&quot;</span>)
<a name="l02254"></a>02254                                                                                 urlpattMap[name+url] = clas;
<a name="l02255"></a>02255                                                                         <span class="keywordflow">else</span>
<a name="l02256"></a>02256                                                                         {
<a name="l02257"></a>02257                                                                                 url = url.substr(url.find(<span class="stringliteral">&quot;*&quot;</span>)+1);
<a name="l02258"></a>02258                                                                                 urlMap[name+url] = clas;
<a name="l02259"></a>02259                                                                         }
<a name="l02260"></a>02260                                                                 }
<a name="l02261"></a>02261                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(clas!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02262"></a>02262                                                                         urlMap[name+url] = clas;
<a name="l02263"></a>02263                                                                 cout &lt;&lt; <span class="stringliteral">&quot;adding controller =&gt; &quot;</span> &lt;&lt; name &lt;&lt; url &lt;&lt; <span class="stringliteral">&quot; :: &quot;</span> &lt;&lt; clas &lt;&lt; endl;
<a name="l02264"></a>02264                                                         }
<a name="l02265"></a>02265                                                         <span class="keywordflow">else</span>
<a name="l02266"></a>02266                                                         {
<a name="l02267"></a>02267                                                                 <span class="keywordtype">string</span> from = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;from&quot;</span>);
<a name="l02268"></a>02268                                                                 <span class="keywordtype">string</span> to = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;to&quot;</span>);
<a name="l02269"></a>02269                                                                 <span class="keywordflow">if</span>(to.find(<span class="stringliteral">&quot;*&quot;</span>)!=string::npos &amp;&amp; to!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02270"></a>02270                                                                         to = to.substr(to.find(<span class="stringliteral">&quot;*&quot;</span>)+1);
<a name="l02271"></a>02271                                                                 <span class="keywordflow">if</span>(from.find(<span class="stringliteral">&quot;*&quot;</span>)!=string::npos &amp;&amp; to!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02272"></a>02272                                                                 {
<a name="l02273"></a>02273                                                                         <span class="keywordflow">if</span>(from==<span class="stringliteral">&quot;*.*&quot;</span>)
<a name="l02274"></a>02274                                                                                 mappattMap[name+from] = to;
<a name="l02275"></a>02275                                                                         <span class="keywordflow">else</span>
<a name="l02276"></a>02276                                                                         {
<a name="l02277"></a>02277                                                                                 from = from.substr(from.find(<span class="stringliteral">&quot;*&quot;</span>)+1);
<a name="l02278"></a>02278                                                                                 mapMap[name+from] = to;
<a name="l02279"></a>02279                                                                         }
<a name="l02280"></a>02280                                                                 }
<a name="l02281"></a>02281                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(to!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02282"></a>02282                                                                 {
<a name="l02283"></a>02283                                                                         mapMap[name+from] = to;
<a name="l02284"></a>02284                                                                 }
<a name="l02285"></a>02285                                                                 cout &lt;&lt; <span class="stringliteral">&quot;adding mapping =&gt; &quot;</span> &lt;&lt; name &lt;&lt; from &lt;&lt; <span class="stringliteral">&quot; :: &quot;</span> &lt;&lt; to &lt;&lt; endl;
<a name="l02286"></a>02286                                                         }
<a name="l02287"></a>02287                                                 }
<a name="l02288"></a>02288                                         }
<a name="l02289"></a>02289                                 }
<a name="l02290"></a>02290                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;authhandlers&quot;</span>)
<a name="l02291"></a>02291                                 {
<a name="l02292"></a>02292                                         ElementList cntrls = eles.at(apps).getChildElements();
<a name="l02293"></a>02293                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn = 0; cntn &lt; cntrls.size(); cntn++)
<a name="l02294"></a>02294                                         {
<a name="l02295"></a>02295                                                 <span class="keywordflow">if</span>(cntrls.at(cntn).getTagName()==<span class="stringliteral">&quot;authhandler&quot;</span>)
<a name="l02296"></a>02296                                                 {
<a name="l02297"></a>02297                                                         <span class="keywordtype">string</span> url = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;url&quot;</span>);
<a name="l02298"></a>02298                                                         <span class="keywordtype">string</span> provider = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;provider&quot;</span>);
<a name="l02299"></a>02299                                                         <span class="keywordflow">if</span>(url!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; provider!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02300"></a>02300                                                         {
<a name="l02301"></a>02301                                                                 <span class="keywordflow">if</span>(url.find(<span class="stringliteral">&quot;*&quot;</span>)!=string::npos)
<a name="l02302"></a>02302                                                                 {
<a name="l02303"></a>02303                                                                         <span class="keywordflow">if</span>(url==<span class="stringliteral">&quot;*.*&quot;</span>)
<a name="l02304"></a>02304                                                                                 autpattMap[name+url] = provider;
<a name="l02305"></a>02305                                                                         <span class="keywordflow">else</span>
<a name="l02306"></a>02306                                                                         {
<a name="l02307"></a>02307                                                                                 url = url.substr(url.find(<span class="stringliteral">&quot;*&quot;</span>)+1);
<a name="l02308"></a>02308                                                                                 autMap[name+url] = provider;
<a name="l02309"></a>02309                                                                         }
<a name="l02310"></a>02310                                                                 }
<a name="l02311"></a>02311                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(provider!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02312"></a>02312                                                                         autMap[name+url] = provider;
<a name="l02313"></a>02313                                                                 cout &lt;&lt; <span class="stringliteral">&quot;adding authhandler =&gt; &quot;</span> &lt;&lt; name &lt;&lt; url &lt;&lt; <span class="stringliteral">&quot; :: &quot;</span> &lt;&lt; provider &lt;&lt; endl;
<a name="l02314"></a>02314                                                         }
<a name="l02315"></a>02315                                                 }
<a name="l02316"></a>02316                                         }
<a name="l02317"></a>02317                                 }
<a name="l02318"></a>02318                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;filters&quot;</span>)
<a name="l02319"></a>02319                                 {
<a name="l02320"></a>02320                                         ElementList cntrls = eles.at(apps).getChildElements();
<a name="l02321"></a>02321                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn = 0; cntn &lt; cntrls.size(); cntn++)
<a name="l02322"></a>02322                                         {
<a name="l02323"></a>02323                                                 <span class="keywordflow">if</span>(cntrls.at(cntn).getTagName()==<span class="stringliteral">&quot;filter&quot;</span>)
<a name="l02324"></a>02324                                                 {
<a name="l02325"></a>02325                                                         <span class="keywordtype">string</span> url = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;url&quot;</span>);
<a name="l02326"></a>02326                                                         <span class="keywordtype">string</span> clas = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02327"></a>02327                                                         <span class="keywordtype">string</span> type = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;type&quot;</span>);
<a name="l02328"></a>02328                                                         <span class="keywordflow">if</span>(clas!=<span class="stringliteral">&quot;&quot;</span> &amp;&amp; (type==<span class="stringliteral">&quot;in&quot;</span> || type==<span class="stringliteral">&quot;out&quot;</span>))
<a name="l02329"></a>02329                                                         {
<a name="l02330"></a>02330                                                                 <span class="keywordflow">if</span>(url==<span class="stringliteral">&quot;&quot;</span>)url=<span class="stringliteral">&quot;*.*&quot;</span>;
<a name="l02331"></a>02331                                                                 <span class="keywordflow">if</span>(url.find(<span class="stringliteral">&quot;*&quot;</span>)!=string::npos)
<a name="l02332"></a>02332                                                                 {
<a name="l02333"></a>02333                                                                         <span class="keywordflow">if</span>(url==<span class="stringliteral">&quot;*.*&quot;</span>)
<a name="l02334"></a>02334                                                                         {
<a name="l02335"></a>02335                                                                                 filterMap[name+url+type].push_back(clas);
<a name="l02336"></a>02336                                                                         }
<a name="l02337"></a>02337                                                                         <span class="keywordflow">else</span>
<a name="l02338"></a>02338                                                                         {
<a name="l02339"></a>02339                                                                                 url = url.substr(url.find(<span class="stringliteral">&quot;*&quot;</span>)+1);
<a name="l02340"></a>02340                                                                                 filterMap[name+url+type].push_back(clas);
<a name="l02341"></a>02341                                                                         }
<a name="l02342"></a>02342                                                                 }
<a name="l02343"></a>02343                                                                 cout &lt;&lt; <span class="stringliteral">&quot;adding filter =&gt; &quot;</span> &lt;&lt; name &lt;&lt; url &lt;&lt; type &lt;&lt; <span class="stringliteral">&quot; :: &quot;</span> &lt;&lt; clas &lt;&lt; endl;
<a name="l02344"></a>02344                                                         }
<a name="l02345"></a>02345                                                 }
<a name="l02346"></a>02346                                         }
<a name="l02347"></a>02347                                 }
<a name="l02348"></a>02348                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;templates&quot;</span>)
<a name="l02349"></a>02349                                 {
<a name="l02350"></a>02350                                         ElementList tmplts = eles.at(apps).getChildElements();
<a name="l02351"></a>02351                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmpn = 0; tmpn &lt; tmplts.size(); tmpn++)
<a name="l02352"></a>02352                                         {
<a name="l02353"></a>02353                                                 <span class="keywordflow">if</span>(tmplts.at(tmpn).getTagName()==<span class="stringliteral">&quot;template&quot;</span>)
<a name="l02354"></a>02354                                                 {
<a name="l02355"></a>02355                                                         tmplMap[name+tmplts.at(tmpn).getAttribute(<span class="stringliteral">&quot;file&quot;</span>)] = tmplts.at(tmpn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02356"></a>02356                                                         <span class="comment">//cout &lt;&lt; tmplts.at(tmpn).getAttribute(&quot;file&quot;) &lt;&lt; &quot; :: &quot; &lt;&lt; tmplts.at(tmpn).getAttribute(&quot;class&quot;) &lt;&lt; flush;</span>
<a name="l02357"></a>02357                                                 }
<a name="l02358"></a>02358                                         }
<a name="l02359"></a>02359                                 }
<a name="l02360"></a>02360                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;dviews&quot;</span>)
<a name="l02361"></a>02361                                 {
<a name="l02362"></a>02362                                         ElementList dvs = eles.at(apps).getChildElements();
<a name="l02363"></a>02363                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dn = 0; dn &lt; dvs.size(); dn++)
<a name="l02364"></a>02364                                         {
<a name="l02365"></a>02365                                                 <span class="keywordflow">if</span>(dvs.at(dn).getTagName()==<span class="stringliteral">&quot;dview&quot;</span>)
<a name="l02366"></a>02366                                                 {
<a name="l02367"></a>02367                                                         vwMap[name+dvs.at(dn).getAttribute(<span class="stringliteral">&quot;path&quot;</span>)] = dvs.at(dn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02368"></a>02368                                                         <span class="comment">//cout &lt;&lt; dvs.at(dn).getAttribute(&quot;path&quot;) &lt;&lt; &quot; :: &quot; &lt;&lt; dvs.at(dn).getAttribute(&quot;class&quot;) &lt;&lt; flush;</span>
<a name="l02369"></a>02369                                                 }
<a name="l02370"></a>02370                                         }
<a name="l02371"></a>02371                                 }
<a name="l02372"></a>02372                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;restcontrollers&quot;</span>)
<a name="l02373"></a>02373                                 {
<a name="l02374"></a>02374                                         ElementList cntrls = eles.at(apps).getChildElements();
<a name="l02375"></a>02375                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn = 0; cntn &lt; cntrls.size(); cntn++)
<a name="l02376"></a>02376                                         {
<a name="l02377"></a>02377                                                 <span class="keywordflow">if</span>(cntrls.at(cntn).getTagName()==<span class="stringliteral">&quot;restcontroller&quot;</span>)
<a name="l02378"></a>02378                                                 {
<a name="l02379"></a>02379                                                         <span class="keywordtype">string</span> url = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;urlpath&quot;</span>);
<a name="l02380"></a>02380                                                         <span class="keywordtype">string</span> clas = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02381"></a>02381                                                         <span class="keywordtype">string</span> rname = cntrls.at(cntn).getAttribute(<span class="stringliteral">&quot;name&quot;</span>);
<a name="l02382"></a>02382                                                         ElementList resfuncs = cntrls.at(cntn).getChildElements();
<a name="l02383"></a>02383                                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn1 = 0; cntn1 &lt; resfuncs.size(); cntn1++)
<a name="l02384"></a>02384                                                         {
<a name="l02385"></a>02385                                                                 <span class="keywordflow">if</span>(resfuncs.at(cntn1).getTagName()==<span class="stringliteral">&quot;restfunction&quot;</span>)
<a name="l02386"></a>02386                                                                 {
<a name="l02387"></a>02387                                                                         <a class="code" href="classRestFunction.html">RestFunction</a> restfunction;
<a name="l02388"></a>02388                                                                         restfunction.name = resfuncs.at(cntn1).getAttribute(<span class="stringliteral">&quot;name&quot;</span>);
<a name="l02389"></a>02389                                                                         restfunction.alias = resfuncs.at(cntn1).getAttribute(<span class="stringliteral">&quot;alias&quot;</span>);
<a name="l02390"></a>02390                                                                         restfunction.clas = clas;
<a name="l02391"></a>02391                                                                         ElementList resfuncparams = resfuncs.at(cntn1).getChildElements();
<a name="l02392"></a>02392                                                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cntn2 = 0; cntn2 &lt; resfuncparams.size(); cntn2++)
<a name="l02393"></a>02393                                                                         {
<a name="l02394"></a>02394                                                                                 <span class="keywordflow">if</span>(resfuncparams.at(cntn2).getTagName()==<span class="stringliteral">&quot;param&quot;</span>)
<a name="l02395"></a>02395                                                                                 {
<a name="l02396"></a>02396                                                                                         <a class="code" href="classRestFunctionParams.html">RestFunctionParams</a> param;
<a name="l02397"></a>02397                                                                                         param.pos = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(resfuncparams.at(cntn2).getAttribute(<span class="stringliteral">&quot;pos&quot;</span>));
<a name="l02398"></a>02398                                                                                         param.type = resfuncparams.at(cntn2).getAttribute(<span class="stringliteral">&quot;type&quot;</span>);
<a name="l02399"></a>02399                                                                                         restfunction.params.push_back(param);
<a name="l02400"></a>02400                                                                                 }
<a name="l02401"></a>02401                                                                         }
<a name="l02402"></a>02402                                                                         <span class="keywordflow">if</span>(restfunction.params.size()==0)
<a name="l02403"></a>02403                                                                                 <span class="keywordflow">continue</span>;
<a name="l02404"></a>02404                                                                         <span class="keywordflow">if</span>(clas!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02405"></a>02405                                                                         {
<a name="l02406"></a>02406                                                                                 <span class="keywordflow">if</span>(url.find(<span class="stringliteral">&quot;*&quot;</span>)==string::npos)
<a name="l02407"></a>02407                                                                                 {
<a name="l02408"></a>02408                                                                                         <span class="keywordflow">if</span>(url==<span class="stringliteral">&quot;&quot;</span>)
<a name="l02409"></a>02409                                                                                                 url = <span class="stringliteral">&quot;/&quot;</span>;
<a name="l02410"></a>02410                                                                                         <span class="keywordtype">string</span> urlmpp;
<a name="l02411"></a>02411                                                                                         <span class="keywordflow">if</span>(rname!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02412"></a>02412                                                                                         {
<a name="l02413"></a>02413                                                                                                 <span class="keywordflow">if</span>(restfunction.alias!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02414"></a>02414                                                                                                 {
<a name="l02415"></a>02415                                                                                                         urlmpp = name+url+rname+<span class="stringliteral">&quot;/&quot;</span>+restfunction.alias;
<a name="l02416"></a>02416                                                                                                         rstCntMap[urlmpp] = restfunction;
<a name="l02417"></a>02417                                                                                                 }
<a name="l02418"></a>02418                                                                                                 <span class="keywordflow">else</span>
<a name="l02419"></a>02419                                                                                                 {
<a name="l02420"></a>02420                                                                                                         urlmpp = name+url+rname+<span class="stringliteral">&quot;/&quot;</span>+restfunction.name;
<a name="l02421"></a>02421                                                                                                         rstCntMap[name+url+rname+<span class="stringliteral">&quot;/&quot;</span>+restfunction.name] = restfunction;
<a name="l02422"></a>02422                                                                                                 }
<a name="l02423"></a>02423                                                                                         }
<a name="l02424"></a>02424                                                                                         <span class="keywordflow">else</span>
<a name="l02425"></a>02425                                                                                         {
<a name="l02426"></a>02426                                                                                                 <span class="keywordflow">if</span>(restfunction.alias!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02427"></a>02427                                                                                                 {
<a name="l02428"></a>02428                                                                                                         urlmpp = name+url+clas+<span class="stringliteral">&quot;/&quot;</span>+restfunction.alias;
<a name="l02429"></a>02429                                                                                                         rstCntMap[urlmpp] = restfunction;
<a name="l02430"></a>02430                                                                                                 }
<a name="l02431"></a>02431                                                                                                 <span class="keywordflow">else</span>
<a name="l02432"></a>02432                                                                                                 {
<a name="l02433"></a>02433                                                                                                         urlmpp = name+url+clas+<span class="stringliteral">&quot;/&quot;</span>+restfunction.name;
<a name="l02434"></a>02434                                                                                                         rstCntMap[urlmpp] = restfunction;
<a name="l02435"></a>02435                                                                                                 }
<a name="l02436"></a>02436                                                                                         }
<a name="l02437"></a>02437                                                                                         cout &lt;&lt; <span class="stringliteral">&quot;adding rest-controller =&gt; &quot;</span> &lt;&lt; urlmpp  &lt;&lt; <span class="stringliteral">&quot; , class =&gt; &quot;</span> &lt;&lt; clas &lt;&lt; endl;
<a name="l02438"></a>02438                                                                                 }
<a name="l02439"></a>02439                                                                         }
<a name="l02440"></a>02440                                                                 }
<a name="l02441"></a>02441                                                         }
<a name="l02442"></a>02442                                                 }
<a name="l02443"></a>02443                                         }
<a name="l02444"></a>02444                                 }
<a name="l02445"></a>02445                         }
<a name="l02446"></a>02446                 }
<a name="l02447"></a>02447                 <a class="code" href="classMapping.html">Mapping</a>* mapping = <span class="keyword">new</span> <a class="code" href="classMapping.html">Mapping</a>;
<a name="l02448"></a>02448                 smstrMap appTableColMapping;
<a name="l02449"></a>02449                 strMap maptc,maptcl;
<a name="l02450"></a>02450                 relMap appTableRelMapping;
<a name="l02451"></a>02451                 <a class="code" href="classElement.html">Element</a> dbroot = parser.getDocument(defpath+<span class="stringliteral">&quot;config/cibernate.xml&quot;</span>).getRootElement();
<a name="l02452"></a>02452                 <span class="keywordflow">if</span>(dbroot.getTagName()==<span class="stringliteral">&quot;cibernate&quot;</span>)
<a name="l02453"></a>02453                 {
<a name="l02454"></a>02454                         ElementList dbeles = dbroot.getChildElements();
<a name="l02455"></a>02455                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dbs = 0; dbs &lt; dbeles.size(); dbs++)
<a name="l02456"></a>02456                         {
<a name="l02457"></a>02457                                 <span class="keywordflow">if</span>(dbeles.at(dbs).getTagName()==<span class="stringliteral">&quot;config&quot;</span>)
<a name="l02458"></a>02458                                 {
<a name="l02459"></a>02459                                         ElementList confs = dbeles.at(dbs).getChildElements();
<a name="l02460"></a>02460                                         <span class="keywordtype">string</span> uid,pwd,dsn;
<a name="l02461"></a>02461                                         <span class="keywordtype">int</span> psize= 2;
<a name="l02462"></a>02462                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cns = 0; cns &lt; confs.size(); cns++)
<a name="l02463"></a>02463                                         {
<a name="l02464"></a>02464                                                 <span class="keywordflow">if</span>(confs.at(cns).getTagName()==<span class="stringliteral">&quot;uid&quot;</span>)
<a name="l02465"></a>02465                                                 {
<a name="l02466"></a>02466                                                         uid = confs.at(cns).getText();
<a name="l02467"></a>02467                                                 }
<a name="l02468"></a>02468                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(confs.at(cns).getTagName()==<span class="stringliteral">&quot;pwd&quot;</span>)
<a name="l02469"></a>02469                                                 {
<a name="l02470"></a>02470                                                         pwd = confs.at(cns).getText();
<a name="l02471"></a>02471                                                 }
<a name="l02472"></a>02472                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(confs.at(cns).getTagName()==<span class="stringliteral">&quot;dsn&quot;</span>)
<a name="l02473"></a>02473                                                 {
<a name="l02474"></a>02474                                                         dsn = confs.at(cns).getText();
<a name="l02475"></a>02475                                                 }
<a name="l02476"></a>02476                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(confs.at(cns).getTagName()==<span class="stringliteral">&quot;pool-size&quot;</span>)
<a name="l02477"></a>02477                                                 {
<a name="l02478"></a>02478                                                         <span class="keywordflow">if</span>(confs.at(cns).getText()!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02479"></a>02479                                                                 psize = boost::lexical_cast&lt;int&gt;(confs.at(cns).getText());
<a name="l02480"></a>02480                                                 }
<a name="l02481"></a>02481                                         }
<a name="l02482"></a>02482                                         CibernateConnPools::addPool(psize,uid,pwd,dsn,name);
<a name="l02483"></a>02483                                 }
<a name="l02484"></a>02484                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(dbeles.at(dbs).getTagName()==<span class="stringliteral">&quot;tables&quot;</span>)
<a name="l02485"></a>02485                                 {
<a name="l02486"></a>02486                                         ElementList tabs = dbeles.at(dbs).getChildElements();
<a name="l02487"></a>02487                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dn = 0; dn &lt; tabs.size(); dn++)
<a name="l02488"></a>02488                                         {
<a name="l02489"></a>02489                                                 <span class="keywordflow">if</span>(tabs.at(dn).getTagName()==<span class="stringliteral">&quot;table&quot;</span>)
<a name="l02490"></a>02490                                                 {
<a name="l02491"></a>02491                                                         vector&lt;DBRel&gt; relv;
<a name="l02492"></a>02492                                                         <span class="comment">/*DBRel relation;</span>
<a name="l02493"></a>02493 <span class="comment">                                                        relation.type = (tabs.at(dn).getAttribute(&quot;hasOne&quot;)!=&quot;&quot;)?1:((tabs.at(dn).getAttribute(&quot;hasMany&quot;)!=&quot;&quot;)?2:((tabs.at(dn).getAttribute(&quot;many&quot;)!=&quot;&quot;)?3:0));</span>
<a name="l02494"></a>02494 <span class="comment">                                                        if(relation.type==1)</span>
<a name="l02495"></a>02495 <span class="comment">                                                                relation.clsName = tabs.at(dn).getAttribute(&quot;hasOne&quot;);</span>
<a name="l02496"></a>02496 <span class="comment">                                                        else if(relation.type==2)</span>
<a name="l02497"></a>02497 <span class="comment">                                                                relation.clsName = tabs.at(dn).getAttribute(&quot;hasMany&quot;);</span>
<a name="l02498"></a>02498 <span class="comment">                                                        else if(relation.type==3)</span>
<a name="l02499"></a>02499 <span class="comment">                                                                relation.clsName = tabs.at(dn).getAttribute(&quot;many&quot;);</span>
<a name="l02500"></a>02500 <span class="comment">                                                        relation.fk = tabs.at(dn).getAttribute(&quot;fk&quot;);</span>
<a name="l02501"></a>02501 <span class="comment">                                                        relation.pk_rel = tabs.at(dn).getAttribute(&quot;pk&quot;);*/</span>
<a name="l02502"></a>02502                                                         maptcl[tabs.at(dn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>)] = tabs.at(dn).getAttribute(<span class="stringliteral">&quot;name&quot;</span>);
<a name="l02503"></a>02503                                                         ElementList cols = tabs.at(dn).getChildElements();
<a name="l02504"></a>02504                                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cn = 0; cn &lt; cols.size(); cn++)
<a name="l02505"></a>02505                                                         {
<a name="l02506"></a>02506                                                                 <span class="keywordflow">if</span>(cols.at(cn).getTagName()==<span class="stringliteral">&quot;hasOne&quot;</span>)
<a name="l02507"></a>02507                                                                 {
<a name="l02508"></a>02508                                                                         <a class="code" href="classDBRel.html">DBRel</a> relation;
<a name="l02509"></a>02509                                                                         relation.clsName = cols.at(cn).getText();
<a name="l02510"></a>02510                                                                         relation.type = 1;
<a name="l02511"></a>02511                                                                         relation.fk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;fk&quot;</span>);
<a name="l02512"></a>02512                                                                         relation.pk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;pk&quot;</span>);
<a name="l02513"></a>02513                                                                         relv.push_back(relation);
<a name="l02514"></a>02514                                                                 }
<a name="l02515"></a>02515                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cols.at(cn).getTagName()==<span class="stringliteral">&quot;hasMany&quot;</span>)
<a name="l02516"></a>02516                                                                 {
<a name="l02517"></a>02517                                                                         <a class="code" href="classDBRel.html">DBRel</a> relation;
<a name="l02518"></a>02518                                                                         relation.clsName = cols.at(cn).getText();
<a name="l02519"></a>02519                                                                         relation.type = 2;
<a name="l02520"></a>02520                                                                         relation.fk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;fk&quot;</span>);
<a name="l02521"></a>02521                                                                         relation.pk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;pk&quot;</span>);
<a name="l02522"></a>02522                                                                         relation.field = cols.at(cn).getAttribute(<span class="stringliteral">&quot;field&quot;</span>);
<a name="l02523"></a>02523                                                                         relv.push_back(relation);
<a name="l02524"></a>02524                                                                 }
<a name="l02525"></a>02525                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cols.at(cn).getTagName()==<span class="stringliteral">&quot;many&quot;</span>)
<a name="l02526"></a>02526                                                                 {
<a name="l02527"></a>02527                                                                         <a class="code" href="classDBRel.html">DBRel</a> relation;
<a name="l02528"></a>02528                                                                         relation.clsName = cols.at(cn).getText();
<a name="l02529"></a>02529                                                                         relation.type = 3;
<a name="l02530"></a>02530                                                                         relation.fk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;fk&quot;</span>);
<a name="l02531"></a>02531                                                                         relation.pk = cols.at(cn).getAttribute(<span class="stringliteral">&quot;pk&quot;</span>);
<a name="l02532"></a>02532                                                                         relv.push_back(relation);
<a name="l02533"></a>02533                                                                 }
<a name="l02534"></a>02534                                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cols.at(cn).getTagName()==<span class="stringliteral">&quot;col&quot;</span>)
<a name="l02535"></a>02535                                                                 {
<a name="l02536"></a>02536                                                                         maptc[cols.at(cn).getAttribute(<span class="stringliteral">&quot;obf&quot;</span>)] = cols.at(cn).getAttribute(<span class="stringliteral">&quot;dbf&quot;</span>);
<a name="l02537"></a>02537                                                                 }
<a name="l02538"></a>02538                                                         }
<a name="l02539"></a>02539                                                         appTableColMapping[tabs.at(dn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>)] = maptc;
<a name="l02540"></a>02540                                                         appTableRelMapping[tabs.at(dn).getAttribute(<span class="stringliteral">&quot;class&quot;</span>)] = relv;
<a name="l02541"></a>02541                                                 }
<a name="l02542"></a>02542                                         }
<a name="l02543"></a>02543                                 }
<a name="l02544"></a>02544                         }
<a name="l02545"></a>02545                 }
<a name="l02546"></a>02546                 mapping-&gt;setAppTableColMapping(appTableColMapping);
<a name="l02547"></a>02547                 mapping-&gt;setAppTableClassMapping(maptcl);
<a name="l02548"></a>02548                 mapping-&gt;setAppTableRelMapping(appTableRelMapping);
<a name="l02549"></a>02549                 CibernateConnPools::addMapping(name,mapping);
<a name="l02550"></a>02550                 <span class="comment">//cout &lt;&lt; (defpath+&quot;config/app.prop&quot;) &lt;&lt; flush;</span>
<a name="l02551"></a>02551                 propMap afc = pread.getProperties(defpath+<span class="stringliteral">&quot;config/afc.prop&quot;</span>);
<a name="l02552"></a>02552 
<a name="l02553"></a>02553                 <span class="keywordtype">string</span> filepath;
<a name="l02554"></a>02554                 <span class="keywordflow">if</span>(afc.size()&gt;0)
<a name="l02555"></a>02555                 {
<a name="l02556"></a>02556                         <span class="keywordtype">string</span> objs = afc[<span class="stringliteral">&quot;PROP&quot;</span>];
<a name="l02557"></a>02557                         strVec objv;
<a name="l02558"></a>02558                         boost::iter_split(objv, objs, boost::first_finder(<span class="stringliteral">&quot;,&quot;</span>));
<a name="l02559"></a>02559                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var1 = 0;var1&lt;objv.size();var1++)
<a name="l02560"></a>02560                         {
<a name="l02561"></a>02561                                 <span class="keywordflow">if</span>(objv.at(var1)!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02562"></a>02562                                 {
<a name="l02563"></a>02563                                         <span class="comment">//strVec info = ref.getAfcObjectData(usrincludes+objv.at(var)+&quot;.h&quot;, true);</span>
<a name="l02564"></a>02564                                         pathvec.push_back(name);
<a name="l02565"></a>02565                                         vecvp.push_back(usrincludes);
<a name="l02566"></a>02566                                         stat.push_back(<span class="keyword">true</span>);
<a name="l02567"></a>02567                                         afcd.push_back(objv.at(var1));
<a name="l02568"></a>02568                                 }
<a name="l02569"></a>02569                         }
<a name="l02570"></a>02570                         objs = afc[<span class="stringliteral">&quot;INTF&quot;</span>];
<a name="l02571"></a>02571                         objv.clear();
<a name="l02572"></a>02572                         boost::iter_split(objv, objs, boost::first_finder(<span class="stringliteral">&quot;,&quot;</span>));
<a name="l02573"></a>02573                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var1 = 0;var1&lt;objv.size();var1++)
<a name="l02574"></a>02574                         {
<a name="l02575"></a>02575                                 <span class="keywordflow">if</span>(objv.at(var1)!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02576"></a>02576                                 {
<a name="l02577"></a>02577                                         <span class="comment">//strVec info = ref.getAfcObjectData(usrincludes+objv.at(var)+&quot;.h&quot;, false);</span>
<a name="l02578"></a>02578                                         pathvec.push_back(name);
<a name="l02579"></a>02579                                         vecvp.push_back(usrincludes);
<a name="l02580"></a>02580                                         stat.push_back(<span class="keyword">false</span>);
<a name="l02581"></a>02581                                         afcd.push_back(objv.at(var1));
<a name="l02582"></a>02582                                 }
<a name="l02583"></a>02583                         }
<a name="l02584"></a>02584                 }
<a name="l02585"></a>02585                 root = parser.getDocument(defpath+<span class="stringliteral">&quot;config/fviews.xml&quot;</span>).getRootElement();
<a name="l02586"></a>02586                 <span class="keywordflow">if</span>(root.getTagName()==<span class="stringliteral">&quot;fview&quot;</span> &amp;&amp; root.getChildElements().size()&gt;0)
<a name="l02587"></a>02587                 {
<a name="l02588"></a>02588                         ElementList eles = root.getChildElements();
<a name="l02589"></a>02589                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> apps = 0; apps &lt; eles.size(); apps++)
<a name="l02590"></a>02590                         {
<a name="l02591"></a>02591                                 <span class="keywordflow">if</span>(eles.at(apps).getTagName()==<span class="stringliteral">&quot;page&quot;</span>)
<a name="l02592"></a>02592                                 {
<a name="l02593"></a>02593                                         <span class="keywordtype">string</span> fvw = eles.at(apps).getAttribute(<span class="stringliteral">&quot;htm&quot;</span>);
<a name="l02594"></a>02594                                         boost::replace_first(fvw,<span class="stringliteral">&quot;.html&quot;</span>,<span class="stringliteral">&quot;.fview&quot;</span>);
<a name="l02595"></a>02595                                         fviewmap[eles.at(apps).getAttribute(<span class="stringliteral">&quot;htm&quot;</span>)] = eles.at(apps).getAttribute(<span class="stringliteral">&quot;class&quot;</span>);
<a name="l02596"></a>02596                                         pathvec.push_back(name);
<a name="l02597"></a>02597                                         vecvp.push_back(usrincludes);
<a name="l02598"></a>02598                                         stat.push_back(<span class="keyword">false</span>);
<a name="l02599"></a>02599                                         afcd.push_back(eles.at(apps).getAttribute(<span class="stringliteral">&quot;class&quot;</span>));
<a name="l02600"></a>02600                                         ElementList elese = eles.at(apps).getChildElements();
<a name="l02601"></a>02601                                         <span class="keywordtype">string</span> nsfns = <span class="stringliteral">&quot;\nvar _fview_namespace = {&quot;</span>;
<a name="l02602"></a>02602                                         <span class="keywordtype">string</span> js = <span class="stringliteral">&quot;\n\nwindow.onload = function(){&quot;</span>;
<a name="l02603"></a>02603                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> appse = 0; appse &lt; elese.size(); appse++)
<a name="l02604"></a>02604                                         {
<a name="l02605"></a>02605                                                 <span class="keywordflow">if</span>(elese.at(appse).getTagName()==<span class="stringliteral">&quot;event&quot;</span>)
<a name="l02606"></a>02606                                                 {
<a name="l02607"></a>02607                                                         nsfns += <span class="stringliteral">&quot;\n\&quot;_fview_cntxt_global_js_callback&quot;</span>+boost::lexical_cast&lt;<span class="keywordtype">string</span>&gt;(appse)+<span class="stringliteral">&quot;\&quot; : function(response){&quot;</span> + elese.at(appse).getAttribute(<span class="stringliteral">&quot;cb&quot;</span>) + <span class="stringliteral">&quot;},&quot;</span>;
<a name="l02608"></a>02608                                                         js += <span class="stringliteral">&quot;\ndocument.getElementById(&#39;&quot;</span>+elese.at(appse).getAttribute(<span class="stringliteral">&quot;eid&quot;</span>)+<span class="stringliteral">&quot;&#39;).&quot;</span>;
<a name="l02609"></a>02609                                                         js += elese.at(appse).getAttribute(<span class="stringliteral">&quot;type&quot;</span>) + <span class="stringliteral">&quot; = function(){&quot;</span>;
<a name="l02610"></a>02610                                                         js += eles.at(apps).getAttribute(<span class="stringliteral">&quot;class&quot;</span>)+<span class="stringliteral">&quot;.&quot;</span>+elese.at(appse).getAttribute(<span class="stringliteral">&quot;func&quot;</span>)+<span class="stringliteral">&quot;(&quot;</span>;
<a name="l02611"></a>02611                                                         <span class="keywordtype">string</span> args = elese.at(appse).getAttribute(<span class="stringliteral">&quot;args&quot;</span>);
<a name="l02612"></a>02612                                                         <span class="keywordflow">if</span>(args!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02613"></a>02613                                                                 args += <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02614"></a>02614                                                         js += args + <span class="stringliteral">&quot;\&quot;_fview_cntxt_global_js_callback&quot;</span>+boost::lexical_cast&lt;<span class="keywordtype">string</span>&gt;(appse)+<span class="stringliteral">&quot;\&quot;,\&quot;/&quot;</span>+name+<span class="stringliteral">&quot;/&quot;</span>+fvw+<span class="stringliteral">&quot;\&quot;,_fview_namespace);}&quot;</span>;
<a name="l02615"></a>02615                                                 }
<a name="l02616"></a>02616                                                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(elese.at(appse).getTagName()==<span class="stringliteral">&quot;form&quot;</span>)
<a name="l02617"></a>02617                                                 {
<a name="l02618"></a>02618                                                         pathvec.push_back(name);
<a name="l02619"></a>02619                                                         vecvp.push_back(usrincludes);
<a name="l02620"></a>02620                                                         stat.push_back(<span class="keyword">true</span>);
<a name="l02621"></a>02621                                                         afcd.push_back(elese.at(appse).getAttribute(<span class="stringliteral">&quot;bean&quot;</span>));
<a name="l02622"></a>02622                                                         formMap[elese.at(appse).getAttribute(<span class="stringliteral">&quot;name&quot;</span>)] = elese.at(appse);
<a name="l02623"></a>02623                                                 }
<a name="l02624"></a>02624                                         }
<a name="l02625"></a>02625                                         js += <span class="stringliteral">&quot;\n}\n\n&quot;</span>;
<a name="l02626"></a>02626                                         nsfns = nsfns.substr(0,nsfns.length()-1) + <span class="stringliteral">&quot;\n}\n&quot;</span>;
<a name="l02627"></a>02627                                         js = nsfns + js;
<a name="l02628"></a>02628                                         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> appse = 0; appse &lt; elese.size(); appse++)
<a name="l02629"></a>02629                                         {
<a name="l02630"></a>02630                                                 <span class="keywordflow">if</span>(elese.at(appse).getTagName()==<span class="stringliteral">&quot;functions&quot;</span>)
<a name="l02631"></a>02631                                                 {
<a name="l02632"></a>02632                                                         js += elese.at(appse).getText();
<a name="l02633"></a>02633                                                 }
<a name="l02634"></a>02634                                         }
<a name="l02635"></a>02635                                         AfcUtil::writeTofile(pubpath+eles.at(apps).getAttribute(<span class="stringliteral">&quot;class&quot;</span>)+<span class="stringliteral">&quot;.js&quot;</span>,js,<span class="keyword">true</span>);
<a name="l02636"></a>02636                                 }
<a name="l02637"></a>02637                         }
<a name="l02638"></a>02638                 }
<a name="l02639"></a>02639         }
<a name="l02640"></a>02640         cout &lt;&lt; endl&lt;&lt; <span class="stringliteral">&quot;started generating compoenent code&quot;</span> &lt;&lt;endl;
<a name="l02641"></a>02641         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var1 = 0;var1&lt;compnts.size();var1++)
<a name="l02642"></a>02642         {
<a name="l02643"></a>02643                 <span class="keywordtype">string</span> cudata,cuheader,curemote,curemoteheaders;
<a name="l02644"></a>02644                 <span class="keywordtype">string</span> file = gen.generateComponentCU(compnts.at(var1),cudata,cuheader,curemote,curemoteheaders);
<a name="l02645"></a>02645                 AfcUtil::writeTofile(rtdcfpath+file+<span class="stringliteral">&quot;.h&quot;</span>,cuheader,<span class="keyword">true</span>);
<a name="l02646"></a>02646                 AfcUtil::writeTofile(rtdcfpath+file+<span class="stringliteral">&quot;.cpp&quot;</span>,cudata,<span class="keyword">true</span>);
<a name="l02647"></a>02647                 AfcUtil::writeTofile(rtdcfpath+file+<span class="stringliteral">&quot;_Remote.h&quot;</span>,curemoteheaders,<span class="keyword">true</span>);
<a name="l02648"></a>02648                 AfcUtil::writeTofile(rtdcfpath+file+<span class="stringliteral">&quot;_Remote.cpp&quot;</span>,curemote,<span class="keyword">true</span>);
<a name="l02649"></a>02649                 isrcs += <span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;.cpp \\\n&quot;</span>+<span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;_Remote.cpp \\\n&quot;</span>;
<a name="l02650"></a>02650                 iobjs += <span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;.o \\\n&quot;</span>+<span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;_Remote.o \\\n&quot;</span>;
<a name="l02651"></a>02651                 ideps += <span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;.d \\\n&quot;</span>+<span class="stringliteral">&quot;./&quot;</span>+file+<span class="stringliteral">&quot;_Remote.d \\\n&quot;</span>;
<a name="l02652"></a>02652                 cmpnames.push_back(file);
<a name="l02653"></a>02653                 cout &lt;&lt; endl&lt;&lt; compnts.at(var1) &lt;&lt;endl;
<a name="l02654"></a>02654         }
<a name="l02655"></a>02655         cout &lt;&lt; endl&lt;&lt; <span class="stringliteral">&quot;done generating compoenent code&quot;</span> &lt;&lt;endl;
<a name="l02656"></a>02656         <span class="keywordtype">string</span> ret = ref.generateClassDefinitionsAll(all,includeRef);
<a name="l02657"></a>02657         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;ReflectorInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02658"></a>02658         ret = ref.generateSerDefinitionAll(all,includeRef);
<a name="l02659"></a>02659         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;SerializeInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02660"></a>02660         cntxt[<span class="stringliteral">&quot;RUNTIME_LIBRARIES&quot;</span>] = libs;
<a name="l02661"></a>02661         ret = templ.evaluate(rtdcfpath+<span class="stringliteral">&quot;objects.mk.template&quot;</span>,cntxt);
<a name="l02662"></a>02662         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;objects.mk&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02663"></a>02663         cntxt.clear();
<a name="l02664"></a>02664         cntxt[<span class="stringliteral">&quot;USER_DEFINED_INC&quot;</span>] = ilibs;
<a name="l02665"></a>02665         cntxt[<span class="stringliteral">&quot;RUNTIME_COMP_SRCS&quot;</span>] = isrcs;
<a name="l02666"></a>02666         cntxt[<span class="stringliteral">&quot;RUNTIME_COMP_OBJS&quot;</span>] = iobjs;
<a name="l02667"></a>02667         cntxt[<span class="stringliteral">&quot;RUNTIME_COMP_DEPS&quot;</span>] = ideps;
<a name="l02668"></a>02668         ret = templ.evaluate(rtdcfpath+<span class="stringliteral">&quot;subdir.mk.template&quot;</span>,cntxt);
<a name="l02669"></a>02669         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;subdir.mk&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02670"></a>02670         dcpsss = dcps;
<a name="l02671"></a>02671         ret = DCPGenerator::generateDCPAll(dcps);
<a name="l02672"></a>02672         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;DCPInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02673"></a>02673         <span class="keywordtype">string</span> headers,objs,infjs;
<a name="l02674"></a>02674         ret = AfcUtil::generateJsObjectsAll(vecvp,afcd,stat,headers,objs,infjs,pathvec);
<a name="l02675"></a>02675         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;AjaxInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02676"></a>02676         AfcUtil::writeTofile(pubpath+<span class="stringliteral">&quot;_afc_Objects.js&quot;</span>,objs,<span class="keyword">true</span>);
<a name="l02677"></a>02677         AfcUtil::writeTofile(pubpath+<span class="stringliteral">&quot;_afc_Interfaces.js&quot;</span>,infjs,<span class="keyword">true</span>);
<a name="l02678"></a>02678         AfcUtil::writeTofile(incpath+<span class="stringliteral">&quot;AfcInclude.h&quot;</span>,headers,<span class="keyword">true</span>);
<a name="l02679"></a>02679         <a class="code" href="classApplicationUtil.html">ApplicationUtil</a> apputil;
<a name="l02680"></a>02680         webdirs.clear();
<a name="l02681"></a>02681         ret = apputil.buildAllApplications(appf,webdirs1,appMap);
<a name="l02682"></a>02682         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;ApplicationInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02683"></a>02683         <a class="code" href="classWsUtil.html">WsUtil</a> wsu;
<a name="l02684"></a>02684         ret = wsu.generateAllWSDL(wspath,respath,wsdlmap);
<a name="l02685"></a>02685         AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;WsInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02686"></a>02686         <span class="keywordflow">return</span> cmpnames;
<a name="l02687"></a>02687 }
<a name="l02688"></a>02688 
<a name="l02689"></a>02689 <span class="keywordtype">void</span> dynamic_page_monitor(<span class="keywordtype">string</span> serverRootDirectory)
<a name="l02690"></a>02690 {
<a name="l02691"></a>02691         <span class="keyword">struct </span>stat statbuf;
<a name="l02692"></a>02692         map&lt;string,long&gt; statsinf;
<a name="l02693"></a>02693         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;(int)dcpsss.size();i++)
<a name="l02694"></a>02694         {
<a name="l02695"></a>02695                 stat(dcpsss.at(i).c_str(), &amp;statbuf);
<a name="l02696"></a>02696                 time_t tm = statbuf.st_mtime;
<a name="l02697"></a>02697                 <span class="keywordtype">long</span> tim = (uintmax_t)tm;
<a name="l02698"></a>02698                 statsinf[dcpsss.at(i)] = tim;
<a name="l02699"></a>02699         }
<a name="l02700"></a>02700         <span class="keywordflow">while</span>(<span class="keyword">true</span>)
<a name="l02701"></a>02701         {
<a name="l02702"></a>02702                 boost::this_thread::sleep(boost::posix_time::seconds(5));
<a name="l02703"></a>02703                 <span class="keywordtype">bool</span> flag = <span class="keyword">false</span>;
<a name="l02704"></a>02704                 <span class="keywordflow">if</span>(processgendone)
<a name="l02705"></a>02705                         <span class="keywordflow">continue</span>;
<a name="l02706"></a>02706                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;(int)dcpsss.size();i++)
<a name="l02707"></a>02707                 {
<a name="l02708"></a>02708                         stat(dcpsss.at(i).c_str(), &amp;statbuf);
<a name="l02709"></a>02709                         time_t tm = statbuf.st_mtime;
<a name="l02710"></a>02710                         <span class="keywordtype">long</span> tim = (uintmax_t)tm;
<a name="l02711"></a>02711                         <span class="keywordflow">if</span>(tim!=statsinf[dcpsss.at(i)])
<a name="l02712"></a>02712                         {
<a name="l02713"></a>02713                                 <span class="keywordtype">string</span> rtdcfpath = serverRootDirectory + <span class="stringliteral">&quot;rtdcf/&quot;</span>;
<a name="l02714"></a>02714                                 <span class="keywordtype">string</span> respath = serverRootDirectory + <span class="stringliteral">&quot;resources/&quot;</span>;
<a name="l02715"></a>02715                                 <span class="keywordtype">string</span> ret = DCPGenerator::generateDCPAll(dcpsss);
<a name="l02716"></a>02716                                 AfcUtil::writeTofile(rtdcfpath+<span class="stringliteral">&quot;DCPInterface.cpp&quot;</span>,ret,<span class="keyword">true</span>);
<a name="l02717"></a>02717                                 <span class="keywordtype">string</span> compres = <span class="stringliteral">&quot;/&quot;</span>+respath+<span class="stringliteral">&quot;rundyn.sh&quot;</span>;
<a name="l02718"></a>02718                                 <span class="keywordtype">int</span> i=system(compres.c_str());
<a name="l02719"></a>02719                                 <span class="keywordflow">if</span>(!i)
<a name="l02720"></a>02720                                 {
<a name="l02721"></a>02721                                         cout &lt;&lt; <span class="stringliteral">&quot;regenarting intermediate code-----Done&quot;</span> &lt;&lt; endl;
<a name="l02722"></a>02722                                         Logger::info(<span class="stringliteral">&quot;Done generating intermediate code&quot;</span>);
<a name="l02723"></a>02723                                 }
<a name="l02724"></a>02724                                 m_mutex.lock();
<a name="l02725"></a>02725                                 map&lt;int,pid_t&gt;::iterator it;
<a name="l02726"></a>02726                                 <span class="keywordflow">for</span>(it=pds.begin();it!=pds.end();it++)
<a name="l02727"></a>02727                                 {
<a name="l02728"></a>02728                                         kill(it-&gt;second,9);
<a name="l02729"></a>02729                                 }
<a name="l02730"></a>02730                                 m_mutex.unlock();
<a name="l02731"></a>02731                                 processforcekilled = <span class="keyword">true</span>;
<a name="l02732"></a>02732                                 flag = <span class="keyword">true</span>;
<a name="l02733"></a>02733                                 <span class="keywordflow">break</span>;
<a name="l02734"></a>02734                         }
<a name="l02735"></a>02735                 }
<a name="l02736"></a>02736                 <span class="keywordflow">if</span>(flag)
<a name="l02737"></a>02737                 {
<a name="l02738"></a>02738                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> ii=0;ii&lt;(int)dcpsss.size();ii++)
<a name="l02739"></a>02739                         {
<a name="l02740"></a>02740                                 stat(dcpsss.at(ii).c_str(), &amp;statbuf);
<a name="l02741"></a>02741                                 time_t tm = statbuf.st_mtime;
<a name="l02742"></a>02742                                 <span class="keywordtype">long</span> tim = (uintmax_t)tm;
<a name="l02743"></a>02743                                 statsinf[dcpsss.at(ii)] = tim;
<a name="l02744"></a>02744                         }
<a name="l02745"></a>02745                 }
<a name="l02746"></a>02746         }
<a name="l02747"></a>02747 }
<a name="l02748"></a>02748 
<a name="l02749"></a>02749 
<a name="l02750"></a>02750 <span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])
<a name="l02751"></a>02751 {
<a name="l02752"></a>02752         parid = getpid();
<a name="l02753"></a>02753         signal(SIGSEGV,signalSIGSEGV);
<a name="l02754"></a>02754         signal(SIGFPE,signalSIGFPE);
<a name="l02755"></a>02755 
<a name="l02756"></a>02756         <span class="comment">//signal(SIGILL,signalSIGILL);</span>
<a name="l02757"></a>02757         signal(SIGPIPE,signalSIGPIPE);
<a name="l02758"></a>02758         <span class="keywordtype">int</span> sockfd, new_fd;  <span class="comment">// listen on sock_fd, new connection on new_fd</span>
<a name="l02759"></a>02759     <span class="keyword">struct </span>addrinfo hints, *servinfo, *p;
<a name="l02760"></a>02760     <span class="keyword">struct </span>sockaddr_storage their_addr; <span class="comment">// connector&#39;s address information</span>
<a name="l02761"></a>02761     socklen_t sin_size;
<a name="l02762"></a>02762     <span class="keyword">struct </span>sigaction sa;
<a name="l02763"></a>02763 
<a name="l02764"></a>02764 
<a name="l02765"></a>02765     <span class="keyword">struct </span>epoll_event ev;
<a name="l02766"></a>02766         <span class="comment">//struct rlimit rt;</span>
<a name="l02767"></a>02767     <span class="keywordtype">int</span> yes=1;
<a name="l02768"></a>02768     <span class="comment">//char s[INET6_ADDRSTRLEN];</span>
<a name="l02769"></a>02769     <span class="keywordtype">int</span> rv,nfds,preForked=5;
<a name="l02770"></a>02770 
<a name="l02771"></a>02771     <span class="comment">/*char path[1024];</span>
<a name="l02772"></a>02772 <span class="comment">        pwd(path,sizeof path);</span>
<a name="l02773"></a>02773 <span class="comment">        string serverRootDirectory;</span>
<a name="l02774"></a>02774 <span class="comment">        stringstream sf;</span>
<a name="l02775"></a>02775 <span class="comment">        sf &lt;&lt; path;</span>
<a name="l02776"></a>02776 <span class="comment">        sf &gt;&gt; serverRootDirectory;*/</span>
<a name="l02777"></a>02777     <span class="keywordtype">string</span> serverRootDirectory = argv[1];
<a name="l02778"></a>02778 
<a name="l02779"></a>02779         serverRootDirectory += <span class="stringliteral">&quot;/&quot;</span>;<span class="comment">//serverRootDirectory = &quot;/home/sumeet/server/&quot;;</span>
<a name="l02780"></a>02780         <span class="keywordtype">string</span> incpath = serverRootDirectory + <span class="stringliteral">&quot;include/&quot;</span>;
<a name="l02781"></a>02781         <span class="keywordtype">string</span> rtdcfpath = serverRootDirectory + <span class="stringliteral">&quot;rtdcf/&quot;</span>;
<a name="l02782"></a>02782         <span class="keywordtype">string</span> pubpath = serverRootDirectory + <span class="stringliteral">&quot;public/&quot;</span>;
<a name="l02783"></a>02783         <span class="keywordtype">string</span> respath = serverRootDirectory + <span class="stringliteral">&quot;resources/&quot;</span>;
<a name="l02784"></a>02784         <span class="keywordtype">string</span> webpath = serverRootDirectory + <span class="stringliteral">&quot;web/&quot;</span>;
<a name="l02785"></a>02785         resourcePath = respath;
<a name="l02786"></a>02786 
<a name="l02787"></a>02787         <span class="comment">//string logf = serverRootDirectory+&quot;/server.log&quot;;</span>
<a name="l02788"></a>02788         <span class="comment">//logfile.open(logf.c_str());</span>
<a name="l02789"></a>02789         <span class="keywordtype">string</span> logp = respath+<span class="stringliteral">&quot;/log.prop&quot;</span>;
<a name="l02790"></a>02790         Logger::init(logp);
<a name="l02791"></a>02791 
<a name="l02792"></a>02792     <a class="code" href="classPropFileReader.html">PropFileReader</a> pread;
<a name="l02793"></a>02793     propMap srprps = pread.getProperties(respath+<span class="stringliteral">&quot;server.prop&quot;</span>);
<a name="l02794"></a>02794     <span class="keywordflow">if</span>(srprps[<span class="stringliteral">&quot;NUM_PROC&quot;</span>]!=<span class="stringliteral">&quot;&quot;</span>)
<a name="l02795"></a>02795         preForked = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(srprps[<span class="stringliteral">&quot;NUM_PROC&quot;</span>]);
<a name="l02796"></a>02796     <span class="keywordtype">string</span> sslEnabled = srprps[<span class="stringliteral">&quot;SSL_ENAB&quot;</span>];
<a name="l02797"></a>02797         <span class="keywordflow">if</span>(sslEnabled==<span class="stringliteral">&quot;true&quot;</span> || sslEnabled==<span class="stringliteral">&quot;TRUE&quot;</span>)
<a name="l02798"></a>02798                 isSSLEnabled = <span class="keyword">true</span>;
<a name="l02799"></a>02799         <span class="keywordtype">string</span> thrdpreq = srprps[<span class="stringliteral">&quot;THRD_PREQ&quot;</span>];
<a name="l02800"></a>02800         <span class="keywordflow">if</span>(thrdpreq==<span class="stringliteral">&quot;true&quot;</span> || thrdpreq==<span class="stringliteral">&quot;TRUE&quot;</span>)
<a name="l02801"></a>02801                 isThreadprq = <span class="keyword">true</span>;
<a name="l02802"></a>02802         <span class="keywordtype">string</span> compileEnabled = srprps[<span class="stringliteral">&quot;COMPILE_ENABLED&quot;</span>];
<a name="l02803"></a>02803         <span class="keywordflow">if</span>(compileEnabled==<span class="stringliteral">&quot;true&quot;</span> || compileEnabled==<span class="stringliteral">&quot;TRUE&quot;</span>)
<a name="l02804"></a>02804                 isCompileEnabled = <span class="keyword">true</span>;
<a name="l02805"></a>02805         <span class="keywordflow">else</span>
<a name="l02806"></a>02806         {
<a name="l02807"></a>02807                 thrdpreq = srprps[<span class="stringliteral">&quot;THRD_PSIZ&quot;</span>];
<a name="l02808"></a>02808                 <span class="keywordflow">if</span>(thrdpreq==<span class="stringliteral">&quot;&quot;</span>)
<a name="l02809"></a>02809                         thrdpsiz = 30;
<a name="l02810"></a>02810                 <span class="keywordflow">else</span>
<a name="l02811"></a>02811                 {
<a name="l02812"></a>02812                         <span class="keywordflow">try</span>
<a name="l02813"></a>02813                         {
<a name="l02814"></a>02814                                 thrdpsiz = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(thrdpreq);
<a name="l02815"></a>02815                         }
<a name="l02816"></a>02816                         <span class="keywordflow">catch</span>(...)
<a name="l02817"></a>02817                         {
<a name="l02818"></a>02818                                 cout &lt;&lt; <span class="stringliteral">&quot;\nInvalid thread pool size defined&quot;</span> &lt;&lt;flush;
<a name="l02819"></a>02819                                 thrdpsiz = 30;
<a name="l02820"></a>02820                         }
<a name="l02821"></a>02821                 }
<a name="l02822"></a>02822         }
<a name="l02823"></a>02823         <span class="keywordflow">if</span>(srprps[<span class="stringliteral">&quot;SESS_STATE&quot;</span>]==<span class="stringliteral">&quot;server&quot;</span>)
<a name="l02824"></a>02824                 sessatserv = <span class="keyword">true</span>;
<a name="l02825"></a>02825     <span class="comment">/* Set each process to allow the maximum number of files to open */</span>
<a name="l02826"></a>02826         <span class="comment">/*rt.rlim_max = rt.rlim_cur = MAXEPOLLSIZE;</span>
<a name="l02827"></a>02827 <span class="comment">        if(setrlimit(RLIMIT_NOFILE, &amp;rt) == -1)</span>
<a name="l02828"></a>02828 <span class="comment">        {</span>
<a name="l02829"></a>02829 <span class="comment">                perror(&quot;setrlimit&quot;);</span>
<a name="l02830"></a>02830 <span class="comment">                exit(1);</span>
<a name="l02831"></a>02831 <span class="comment">        }</span>
<a name="l02832"></a>02832 <span class="comment">        else</span>
<a name="l02833"></a>02833 <span class="comment">                printf(&quot;set the parameters of system resources, the success!\n&quot;);*/</span>
<a name="l02834"></a>02834 
<a name="l02835"></a>02835     memset(&amp;hints, 0, <span class="keyword">sizeof</span> hints);
<a name="l02836"></a>02836     hints.ai_family = AF_UNSPEC;
<a name="l02837"></a>02837     hints.ai_socktype = SOCK_STREAM;
<a name="l02838"></a>02838     hints.ai_flags = AI_PASSIVE; <span class="comment">// use my IP</span>
<a name="l02839"></a>02839     <span class="keywordtype">string</span> PORT = srprps[<span class="stringliteral">&quot;PORT_NO&quot;</span>];
<a name="l02840"></a>02840     <span class="keywordflow">if</span> ((rv = getaddrinfo(NULL, &amp;PORT[0], &amp;hints, &amp;servinfo)) != 0) {
<a name="l02841"></a>02841         fprintf(stderr, <span class="stringliteral">&quot;getaddrinfo: %s\n&quot;</span>, gai_strerror(rv));
<a name="l02842"></a>02842         <span class="keywordflow">return</span> 1;
<a name="l02843"></a>02843     }
<a name="l02844"></a>02844 
<a name="l02845"></a>02845     <span class="comment">// loop through all the results and bind to the first we can</span>
<a name="l02846"></a>02846     <span class="keywordflow">for</span>(p = servinfo; p != NULL; p = p-&gt;ai_next) {
<a name="l02847"></a>02847         <span class="keywordflow">if</span> ((sockfd = socket(p-&gt;ai_family, p-&gt;ai_socktype,
<a name="l02848"></a>02848                 p-&gt;ai_protocol)) == -1) {
<a name="l02849"></a>02849             perror(<span class="stringliteral">&quot;server: socket&quot;</span>);
<a name="l02850"></a>02850             <span class="keywordflow">continue</span>;
<a name="l02851"></a>02851         }
<a name="l02852"></a>02852         <span class="keywordflow">if</span> (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, &amp;yes,
<a name="l02853"></a>02853                 <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)) == -1) {
<a name="l02854"></a>02854             perror(<span class="stringliteral">&quot;setsockopt&quot;</span>);
<a name="l02855"></a>02855             exit(1);
<a name="l02856"></a>02856         }
<a name="l02857"></a>02857         <span class="keywordflow">if</span> (bind(sockfd, p-&gt;ai_addr, p-&gt;ai_addrlen) == -1) {
<a name="l02858"></a>02858                         close(sockfd);
<a name="l02859"></a>02859             perror(<span class="stringliteral">&quot;server: bind&quot;</span>);
<a name="l02860"></a>02860             <span class="keywordflow">continue</span>;
<a name="l02861"></a>02861         }
<a name="l02862"></a>02862         <span class="keywordflow">break</span>;
<a name="l02863"></a>02863     }
<a name="l02864"></a>02864 
<a name="l02865"></a>02865     <span class="keywordflow">if</span> (p == NULL)  {
<a name="l02866"></a>02866         fprintf(stderr, <span class="stringliteral">&quot;server: failed to bind\n&quot;</span>);
<a name="l02867"></a>02867         <span class="keywordflow">return</span> 2;
<a name="l02868"></a>02868     }
<a name="l02869"></a>02869     freeaddrinfo(servinfo); <span class="comment">// all done with this structure</span>
<a name="l02870"></a>02870     <span class="keywordflow">if</span> (listen(sockfd, BACKLOGM) == -1) {
<a name="l02871"></a>02871         perror(<span class="stringliteral">&quot;listen&quot;</span>);
<a name="l02872"></a>02872         exit(1);
<a name="l02873"></a>02873     }
<a name="l02874"></a>02874     fcntl(sockfd, F_SETFL, fcntl(sockfd, F_GETFD, 0) | O_NONBLOCK);
<a name="l02875"></a>02875     sa.sa_handler = sigchld_handler; <span class="comment">// reap all dead processes</span>
<a name="l02876"></a>02876     sigemptyset(&amp;sa.sa_mask);
<a name="l02877"></a>02877     sa.sa_flags = SA_RESTART;
<a name="l02878"></a>02878     <span class="keywordflow">if</span> (sigaction(SIGCHLD, &amp;sa, NULL) == -1) {
<a name="l02879"></a>02879         perror(<span class="stringliteral">&quot;sigaction&quot;</span>);
<a name="l02880"></a>02880         exit(1);
<a name="l02881"></a>02881     }
<a name="l02882"></a>02882     strVec webdirs,webdirs1,pubfiles;
<a name="l02883"></a>02883     listi(webpath,<span class="stringliteral">&quot;/&quot;</span>,<span class="keyword">true</span>,webdirs);
<a name="l02884"></a>02884     listi(webpath,<span class="stringliteral">&quot;/&quot;</span>,<span class="keyword">false</span>,webdirs1);
<a name="l02885"></a>02885     listi(pubpath,<span class="stringliteral">&quot;.js&quot;</span>,<span class="keyword">false</span>,pubfiles);
<a name="l02886"></a>02886     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var=0;var&lt;pubfiles.size();var++)
<a name="l02887"></a>02887     {
<a name="l02888"></a>02888         pubMap[pubfiles.at(var)] = <span class="stringliteral">&quot;true&quot;</span>;
<a name="l02889"></a>02889     }
<a name="l02890"></a>02890     strVec cmpnames;
<a name="l02891"></a>02891     <span class="keywordflow">try</span>
<a name="l02892"></a>02892     {
<a name="l02893"></a>02893         cmpnames = temporaray(webdirs,webdirs1,incpath,rtdcfpath,pubpath,respath);
<a name="l02894"></a>02894     }
<a name="l02895"></a>02895     <span class="keywordflow">catch</span>(<a class="code" href="classXmlParseException.html">XmlParseException</a> *p)
<a name="l02896"></a>02896     {
<a name="l02897"></a>02897         cout &lt;&lt; p-&gt;getMessage() &lt;&lt; endl;
<a name="l02898"></a>02898     }
<a name="l02899"></a>02899 
<a name="l02900"></a>02900     <span class="keywordtype">bool</span> libpresent = <span class="keyword">true</span>;
<a name="l02901"></a>02901     <span class="keywordtype">void</span> *dlibtemp = dlopen(<span class="stringliteral">&quot;libinter.so&quot;</span>, RTLD_NOW|RTLD_GLOBAL);
<a name="l02902"></a>02902         cout &lt;&lt; endl &lt;&lt;dlibtemp &lt;&lt; endl;
<a name="l02903"></a>02903         <span class="keywordflow">if</span>(dlibtemp==NULL)
<a name="l02904"></a>02904         {
<a name="l02905"></a>02905                 libpresent = <span class="keyword">false</span>;
<a name="l02906"></a>02906                 cout &lt;&lt; dlerror() &lt;&lt; endl;
<a name="l02907"></a>02907                 Logger::info(<span class="stringliteral">&quot;Could not load Library&quot;</span>);
<a name="l02908"></a>02908         }
<a name="l02909"></a>02909         <span class="keywordflow">else</span>
<a name="l02910"></a>02910                 dlclose(dlibtemp);
<a name="l02911"></a>02911     <span class="keywordflow">if</span>(isCompileEnabled)
<a name="l02912"></a>02912         libpresent = <span class="keyword">false</span>;
<a name="l02913"></a>02913 
<a name="l02914"></a>02914         props = pread.getProperties(respath+<span class="stringliteral">&quot;mime-types.prop&quot;</span>);
<a name="l02915"></a>02915         lprops = pread.getProperties(respath+<span class="stringliteral">&quot;locale.prop&quot;</span>);
<a name="l02916"></a>02916         <span class="keywordtype">string</span> compres = <span class="stringliteral">&quot;/&quot;</span>+respath+<span class="stringliteral">&quot;run.sh&quot;</span>;
<a name="l02917"></a>02917         <span class="keywordflow">if</span>(!libpresent)
<a name="l02918"></a>02918         {
<a name="l02919"></a>02919                 <span class="keywordtype">int</span> i=system(compres.c_str());
<a name="l02920"></a>02920                 <span class="keywordflow">if</span>(!i)
<a name="l02921"></a>02921                 {
<a name="l02922"></a>02922                         cout &lt;&lt; <span class="stringliteral">&quot;Done&quot;</span> &lt;&lt; flush;
<a name="l02923"></a>02923                         Logger::info(<span class="stringliteral">&quot;Done generating intermediate code&quot;</span>);
<a name="l02924"></a>02924                         <span class="comment">//logfile &lt;&lt; &quot;Done generating intermediate code\n&quot; &lt;&lt; flush;</span>
<a name="l02925"></a>02925                 }
<a name="l02926"></a>02926         }
<a name="l02927"></a>02927 
<a name="l02928"></a>02928         <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> var1 = 0;var1&lt;cmpnames.size();var1++)
<a name="l02929"></a>02929         {
<a name="l02930"></a>02930                 <span class="keywordtype">string</span> name = cmpnames.at(var1);
<a name="l02931"></a>02931                 boost::replace_first(name,<span class="stringliteral">&quot;Component_&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l02932"></a>02932                 ComponentHandler::registerComponent(name);
<a name="l02933"></a>02933                 AppContext::registerComponent(name);
<a name="l02934"></a>02934         }
<a name="l02935"></a>02935         <span class="keywordflow">if</span>(srprps[<span class="stringliteral">&quot;CMP_PORT&quot;</span>]==<span class="stringliteral">&quot;&quot;</span>)
<a name="l02936"></a>02936         {
<a name="l02937"></a>02937                 srprps[<span class="stringliteral">&quot;CMP_PORT&quot;</span>] = <span class="stringliteral">&quot;7001&quot;</span>;
<a name="l02938"></a>02938         }
<a name="l02939"></a>02939         ComponentHandler::trigger(srprps[<span class="stringliteral">&quot;CMP_PORT&quot;</span>]);
<a name="l02940"></a>02940         <span class="keywordflow">if</span>(srprps[<span class="stringliteral">&quot;MESS_PORT&quot;</span>]==<span class="stringliteral">&quot;&quot;</span>)
<a name="l02941"></a>02941         {
<a name="l02942"></a>02942                 srprps[<span class="stringliteral">&quot;MESS_PORT&quot;</span>] = <span class="stringliteral">&quot;7002&quot;</span>;
<a name="l02943"></a>02943         }
<a name="l02944"></a>02944         MessageHandler::trigger(srprps[<span class="stringliteral">&quot;MESS_PORT&quot;</span>],resourcePath);
<a name="l02945"></a>02945         <span class="keywordflow">if</span>(srprps[<span class="stringliteral">&quot;MI_PORT&quot;</span>]==<span class="stringliteral">&quot;&quot;</span>)
<a name="l02946"></a>02946         {
<a name="l02947"></a>02947                 srprps[<span class="stringliteral">&quot;MI_PORT&quot;</span>] = <span class="stringliteral">&quot;7003&quot;</span>;
<a name="l02948"></a>02948         }
<a name="l02949"></a>02949         MethodInvoc::trigger(srprps[<span class="stringliteral">&quot;MI_PORT&quot;</span>]);
<a name="l02950"></a>02950         <span class="keywordtype">int</span> sp[preForked][2]; <span class="comment">/* the pair of socket descriptors */</span>
<a name="l02951"></a>02951         printf(<span class="stringliteral">&quot;server: waiting for connections...\n&quot;</span>);
<a name="l02952"></a>02952         <span class="comment">//logfile &lt;&lt; &quot;Server: waiting for connections on port &quot; &lt;&lt; PORT &lt;&lt; &quot;\n&quot; &lt;&lt; flush;</span>
<a name="l02953"></a>02953         Logger::info(<span class="stringliteral">&quot;Server: waiting for connections on port &quot;</span>+PORT);
<a name="l02954"></a>02954 
<a name="l02955"></a>02955         vector&lt;string&gt; files;
<a name="l02956"></a>02956         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;preForked;j++)
<a name="l02957"></a>02957         {
<a name="l02958"></a>02958                 pid_t pid = createChildProcess(serverRootDirectory,sp[j],sockfd);
<a name="l02959"></a>02959                 pds[j] = pid;
<a name="l02960"></a>02960                 stringstream ss;
<a name="l02961"></a>02961                 <span class="keywordtype">string</span> filename;
<a name="l02962"></a>02962                 ss &lt;&lt; serverRootDirectory;
<a name="l02963"></a>02963                 ss &lt;&lt; pds[j];
<a name="l02964"></a>02964                 ss &gt;&gt; filename;
<a name="l02965"></a>02965                 filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l02966"></a>02966                 files.push_back(filename);
<a name="l02967"></a>02967         }
<a name="l02968"></a>02968         <span class="keywordflow">if</span>(isCompileEnabled)boost::thread m_thread(boost::bind(&amp;dynamic_page_monitor ,serverRootDirectory));
<a name="l02969"></a>02969         <span class="keyword">struct </span>epoll_event events[MAXEPOLLSIZE];
<a name="l02970"></a>02970         <span class="keywordtype">int</span> epoll_handle = epoll_create(MAXEPOLLSIZE);
<a name="l02971"></a>02971         ev.events = EPOLLIN | EPOLLPRI;
<a name="l02972"></a>02972         ev.data.fd = sockfd;
<a name="l02973"></a>02973         <span class="keywordflow">if</span> (epoll_ctl(epoll_handle, EPOLL_CTL_ADD, sockfd, &amp;ev) &lt; 0)
<a name="l02974"></a>02974         {
<a name="l02975"></a>02975                 fprintf(stderr, <span class="stringliteral">&quot;epoll set insertion error: fd=%d\n&quot;</span>, sockfd);
<a name="l02976"></a>02976                 <span class="keywordflow">return</span> -1;
<a name="l02977"></a>02977         }
<a name="l02978"></a>02978         <span class="keywordflow">else</span>
<a name="l02979"></a>02979                 printf(<span class="stringliteral">&quot;listener socket to join epoll success!\n&quot;</span>);
<a name="l02980"></a>02980         <span class="keywordtype">int</span> childNo = 0;
<a name="l02981"></a>02981         <span class="comment">/*if(fork()==0)</span>
<a name="l02982"></a>02982 <span class="comment">        {</span>
<a name="l02983"></a>02983 <span class="comment">                //start  of hotdeployment process</span>
<a name="l02984"></a>02984 <span class="comment"></span>
<a name="l02985"></a>02985 <span class="comment">        }*/</span>
<a name="l02986"></a>02986         <span class="comment">//cout &lt;&lt; &quot;Done&quot; &lt;&lt; flush;</span>
<a name="l02987"></a>02987         <span class="keyword">struct </span>msghdr msg;
<a name="l02988"></a>02988         <span class="keywordtype">char</span> ccmsg[CMSG_SPACE(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>))];
<a name="l02989"></a>02989         <span class="keyword">struct </span>cmsghdr *cmsg;
<a name="l02990"></a>02990         <span class="keyword">struct </span>iovec vec;  <span class="comment">/* stupidity: must send/receive at least one byte */</span>
<a name="l02991"></a>02991         <span class="keywordtype">char</span> *str = (<span class="keywordtype">char</span> *)<span class="stringliteral">&quot;x&quot;</span>;
<a name="l02992"></a>02992         <span class="comment">//msg.msg_name = (struct sockaddr*)&amp;unix_socket_name;</span>
<a name="l02993"></a>02993         <span class="comment">//msg.msg_namelen = sizeof(unix_socket_name);</span>
<a name="l02994"></a>02994         msg.msg_name = 0;
<a name="l02995"></a>02995         msg.msg_namelen = 0;
<a name="l02996"></a>02996         vec.iov_base = str;
<a name="l02997"></a>02997         vec.iov_len = 1;
<a name="l02998"></a>02998         msg.msg_iov = &amp;vec;
<a name="l02999"></a>02999         msg.msg_iovlen = 1;
<a name="l03000"></a>03000 
<a name="l03001"></a>03001         <span class="comment">/* old BSD implementations should use msg_accrights instead of</span>
<a name="l03002"></a>03002 <span class="comment">        * msg_control; the interface is different. */</span>
<a name="l03003"></a>03003         msg.msg_control = ccmsg;
<a name="l03004"></a>03004         msg.msg_controllen = <span class="keyword">sizeof</span>(ccmsg);
<a name="l03005"></a>03005         cmsg = CMSG_FIRSTHDR(&amp;msg);
<a name="l03006"></a>03006         cmsg-&gt;cmsg_level = SOL_SOCKET;
<a name="l03007"></a>03007         cmsg-&gt;cmsg_type = SCM_RIGHTS;
<a name="l03008"></a>03008         cmsg-&gt;cmsg_len = CMSG_LEN(<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));
<a name="l03009"></a>03009         msg.msg_flags = 0;
<a name="l03010"></a>03010         <span class="keywordtype">int</span> curfds = 1;
<a name="l03011"></a>03011         ifstream cntrlfile;
<a name="l03012"></a>03012         <a class="code" href="classThreadPool.html">ThreadPool</a> pool;
<a name="l03013"></a>03013         <span class="keywordflow">if</span>(!isThreadprq)
<a name="l03014"></a>03014         {
<a name="l03015"></a>03015                 pool.init(thrdpsiz,30,<span class="keyword">true</span>);
<a name="l03016"></a>03016         }
<a name="l03017"></a>03017         <span class="keywordflow">while</span>(1)
<a name="l03018"></a>03018         {
<a name="l03019"></a>03019 
<a name="l03020"></a>03020                 <span class="keywordflow">if</span>(childNo&gt;=preForked)
<a name="l03021"></a>03021                         childNo = 0;
<a name="l03022"></a>03022                 nfds = epoll_wait(epoll_handle, events, curfds,-1);
<a name="l03023"></a>03023                 <span class="keywordflow">if</span> (nfds == -1)
<a name="l03024"></a>03024                 {
<a name="l03025"></a>03025                         perror(<span class="stringliteral">&quot;epoll_wait main process&quot;</span>);
<a name="l03026"></a>03026                         <span class="comment">//logfile &lt;&lt; &quot;Interruption Signal Received\n&quot; &lt;&lt; flush;</span>
<a name="l03027"></a>03027                         Logger::info(<span class="stringliteral">&quot;Interruption Signal Received\n&quot;</span>);
<a name="l03028"></a>03028                         curfds = 1;
<a name="l03029"></a>03029                         <span class="keywordflow">if</span>(errno==EBADF)
<a name="l03030"></a>03030                                 cout &lt;&lt; <span class="stringliteral">&quot;\nInavlid fd&quot;</span> &lt;&lt;flush;
<a name="l03031"></a>03031                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errno==EFAULT)
<a name="l03032"></a>03032                                 cout &lt;&lt; <span class="stringliteral">&quot;\nThe memory area pointed to by events is not accessible&quot;</span> &lt;&lt;flush;
<a name="l03033"></a>03033                         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(errno==EINTR)
<a name="l03034"></a>03034                                 cout &lt;&lt; <span class="stringliteral">&quot;\ncall was interrupted by a signal handler before any of the requested events occurred&quot;</span> &lt;&lt;flush;
<a name="l03035"></a>03035                         <span class="keywordflow">else</span>
<a name="l03036"></a>03036                                 cout &lt;&lt; <span class="stringliteral">&quot;\nnot an epoll file descriptor&quot;</span> &lt;&lt;flush;
<a name="l03037"></a>03037                         <span class="comment">//break;</span>
<a name="l03038"></a>03038                 }
<a name="l03039"></a>03039                 processgendone = <span class="keyword">false</span>;
<a name="l03040"></a>03040                 <span class="keywordflow">if</span>(processforcekilled)
<a name="l03041"></a>03041                 {
<a name="l03042"></a>03042                         files.clear();
<a name="l03043"></a>03043                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0;j&lt;preForked;j++)
<a name="l03044"></a>03044                         {
<a name="l03045"></a>03045                                 pid_t pid = createChildProcess(serverRootDirectory,sp[j],sockfd);
<a name="l03046"></a>03046                                 pds[j] = pid;
<a name="l03047"></a>03047                                 stringstream ss;
<a name="l03048"></a>03048                                 <span class="keywordtype">string</span> filename;
<a name="l03049"></a>03049                                 ss &lt;&lt; serverRootDirectory;
<a name="l03050"></a>03050                                 ss &lt;&lt; pds[j];
<a name="l03051"></a>03051                                 ss &gt;&gt; filename;
<a name="l03052"></a>03052                                 filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l03053"></a>03053                                 files.push_back(filename);
<a name="l03054"></a>03054                         }
<a name="l03055"></a>03055                         processforcekilled = <span class="keyword">false</span>;
<a name="l03056"></a>03056                         processgendone = <span class="keyword">true</span>;
<a name="l03057"></a>03057                 }
<a name="l03058"></a>03058                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> n=0;n&lt;nfds;n++)
<a name="l03059"></a>03059                 {
<a name="l03060"></a>03060                         <span class="keywordflow">if</span>(childNo&gt;=preForked)
<a name="l03061"></a>03061                                 childNo = 0;
<a name="l03062"></a>03062                         <span class="keywordflow">if</span> (events[n].data.fd == sockfd)
<a name="l03063"></a>03063                         {
<a name="l03064"></a>03064                                 new_fd = -1;
<a name="l03065"></a>03065                                 sin_size = <span class="keyword">sizeof</span> their_addr;
<a name="l03066"></a>03066                                 new_fd = accept(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;their_addr, &amp;sin_size);
<a name="l03067"></a>03067                                 <span class="comment">//cout &lt;&lt; &quot;\nnew http request&quot; &lt;&lt;flush;</span>
<a name="l03068"></a>03068                                 <span class="comment">//logfile &lt;&lt; &quot;Interruption Signal Received\n&quot; &lt;&lt; flush;</span>
<a name="l03069"></a>03069                                 <span class="keywordflow">if</span> (new_fd == -1)
<a name="l03070"></a>03070                                 {
<a name="l03071"></a>03071                                         perror(<span class="stringliteral">&quot;accept&quot;</span>);
<a name="l03072"></a>03072                                         <span class="keywordflow">continue</span>;
<a name="l03073"></a>03073                                 }
<a name="l03074"></a>03074                                 <span class="keywordflow">else</span>
<a name="l03075"></a>03075                                 {
<a name="l03076"></a>03076                                         curfds++;
<a name="l03077"></a>03077                                         fcntl(new_fd, F_SETFL, fcntl(new_fd, F_GETFD, 0) | O_NONBLOCK);
<a name="l03078"></a>03078                                         ev.events = EPOLLIN | EPOLLPRI;
<a name="l03079"></a>03079                                         ev.data.fd = new_fd;
<a name="l03080"></a>03080                                         <span class="keywordflow">if</span> (epoll_ctl(epoll_handle, EPOLL_CTL_ADD, new_fd, &amp;ev) &lt; 0)
<a name="l03081"></a>03081                                         {
<a name="l03082"></a>03082                                                 perror(<span class="stringliteral">&quot;epoll&quot;</span>);
<a name="l03083"></a>03083                                                 cout &lt;&lt; <span class="stringliteral">&quot;\nerror adding to epoll cntl list&quot;</span> &lt;&lt; flush;
<a name="l03084"></a>03084                                                 <span class="keywordflow">return</span> -1;
<a name="l03085"></a>03085                                         }
<a name="l03086"></a>03086                                 }
<a name="l03087"></a>03087                         }
<a name="l03088"></a>03088                         <span class="keywordflow">else</span>
<a name="l03089"></a>03089                         {
<a name="l03090"></a>03090                                 epoll_ctl(epoll_handle, EPOLL_CTL_DEL, events[n].data.fd,&amp;ev);
<a name="l03091"></a>03091                                 curfds--;
<a name="l03092"></a>03092                                 cntrlfile.open(files.at(childNo).c_str());
<a name="l03093"></a>03093                                 <span class="keywordflow">if</span>(cntrlfile.is_open())
<a name="l03094"></a>03094                                 {
<a name="l03095"></a>03095                                         *(<span class="keywordtype">int</span>*)CMSG_DATA(cmsg) = events[n].data.fd;
<a name="l03096"></a>03096                                         msg.msg_controllen = cmsg-&gt;cmsg_len;
<a name="l03097"></a>03097                                         <span class="keywordflow">if</span>((rv= sendmsg(sp[childNo][0], &amp;msg, 0)) &lt; 0)
<a name="l03098"></a>03098                                         {
<a name="l03099"></a>03099                                           perror(<span class="stringliteral">&quot;sendmsg()&quot;</span>);
<a name="l03100"></a>03100                                           exit(1);
<a name="l03101"></a>03101                                         }
<a name="l03102"></a>03102                                         <span class="keywordtype">string</span> cno = boost::lexical_cast&lt;<span class="keywordtype">string</span>&gt;(childNo);
<a name="l03103"></a>03103                                         close(events[n].data.fd);
<a name="l03104"></a>03104                                         childNo++;
<a name="l03105"></a>03105                                 }
<a name="l03106"></a>03106                                 <span class="keywordflow">else</span>
<a name="l03107"></a>03107                                 {
<a name="l03108"></a>03108                                         <span class="keywordtype">int</span> tcn = childNo;
<a name="l03109"></a>03109                                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> o=0;o&lt;preForked;o++)
<a name="l03110"></a>03110                                         {
<a name="l03111"></a>03111                                                 cntrlfile.open(files.at(o).c_str());
<a name="l03112"></a>03112                                                 <span class="keywordflow">if</span>(cntrlfile.is_open())
<a name="l03113"></a>03113                                                 {
<a name="l03114"></a>03114                                                         *(<span class="keywordtype">int</span>*)CMSG_DATA(cmsg) = events[n].data.fd;
<a name="l03115"></a>03115                                                         msg.msg_controllen = cmsg-&gt;cmsg_len;
<a name="l03116"></a>03116                                                         <span class="keywordflow">if</span>((rv= sendmsg(sp[o][0], &amp;msg, 0)) &lt; 0)
<a name="l03117"></a>03117                                                         {
<a name="l03118"></a>03118                                                           perror(<span class="stringliteral">&quot;sendmsg()&quot;</span>);
<a name="l03119"></a>03119                                                           exit(1);
<a name="l03120"></a>03120                                                         }
<a name="l03121"></a>03121                                                         <span class="keywordtype">string</span> cno = boost::lexical_cast&lt;<span class="keywordtype">string</span>&gt;(o);
<a name="l03122"></a>03122                                                         <span class="comment">//logfile &lt;&lt; (&quot;sent socket to process &quot;+cno+&quot;\n&quot;) &lt;&lt; flush;</span>
<a name="l03123"></a>03123                                                         close(events[n].data.fd);
<a name="l03124"></a>03124                                                         childNo = o+1;
<a name="l03125"></a>03125                                                         <span class="keywordflow">break</span>;
<a name="l03126"></a>03126                                                 }
<a name="l03127"></a>03127                                         }
<a name="l03128"></a>03128                                         close(sp[tcn][0]);
<a name="l03129"></a>03129                                         close(sp[tcn][1]);
<a name="l03130"></a>03130                                         cout &lt;&lt; <span class="stringliteral">&quot;Process got killed&quot;</span> &lt;&lt; flush;
<a name="l03131"></a>03131                                         pid_t pid = createChildProcess(serverRootDirectory,sp[tcn],sockfd);
<a name="l03132"></a>03132                                         pds[tcn] = pid;
<a name="l03133"></a>03133                                         stringstream ss;
<a name="l03134"></a>03134                                         <span class="keywordtype">string</span> filename;
<a name="l03135"></a>03135                                         ss &lt;&lt; serverRootDirectory;
<a name="l03136"></a>03136                                         ss &lt;&lt; pid;
<a name="l03137"></a>03137                                         ss &gt;&gt; filename;
<a name="l03138"></a>03138                                         filename.append(<span class="stringliteral">&quot;.cntrl&quot;</span>);
<a name="l03139"></a>03139                                         files[tcn] = filename;
<a name="l03140"></a>03140                                         cout &lt;&lt; <span class="stringliteral">&quot;created a new Process&quot;</span> &lt;&lt; flush;
<a name="l03141"></a>03141                                         <span class="comment">//logfile &lt;&lt; &quot;Process got killed hence created a new Process &quot; &lt;&lt; pid &lt;&lt; flush;</span>
<a name="l03142"></a>03142                                         Logger::info(<span class="stringliteral">&quot;Process got killed hence created a new Process\n&quot;</span>);
<a name="l03143"></a>03143                                 }
<a name="l03144"></a>03144                                 cntrlfile.close();
<a name="l03145"></a>03145                         }
<a name="l03146"></a>03146                 }
<a name="l03147"></a>03147         }
<a name="l03148"></a>03148         <span class="keywordflow">return</span> 0;
<a name="l03149"></a>03149 }
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Feb 6 13:07:55 2012 for ffead.server.doc by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
